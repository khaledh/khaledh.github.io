<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.15" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #22272e;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>Parser | Khaled Hammouda</title><meta name="description" content="Building a 64-bit operating system from scratch in Nim">
    <link rel="preload" href="/assets/style-DFReAQZD.css" as="style"><link rel="stylesheet" href="/assets/style-DFReAQZD.css">
    <link rel="modulepreload" href="/assets/app-BEnvQN0t.js"><link rel="modulepreload" href="/assets/05-parser.html-Dw5HPOU5.js">
    <link rel="prefetch" href="/assets/index.html-DN4baEjd.js" as="script"><link rel="prefetch" href="/assets/index.html-DTcVMSat.js" as="script"><link rel="prefetch" href="/assets/01-mm.html-DdVm3GHI.js" as="script"><link rel="prefetch" href="/assets/index.html-D8_cVHQe.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-Bq4FSDwn.js" as="script"><link rel="prefetch" href="/assets/02-setup.html-9f0UzP9I.js" as="script"><link rel="prefetch" href="/assets/03-filetype.html-DVtyN252.js" as="script"><link rel="prefetch" href="/assets/04-lexer.html-OooGwppm.js" as="script"><link rel="prefetch" href="/assets/06-parser-p2.html-CHLJtldD.js" as="script"><link rel="prefetch" href="/assets/07-grammarkit.html-DALOmYeT.js" as="script"><link rel="prefetch" href="/assets/08-go-to-decl.html-DPftLCwO.js" as="script"><link rel="prefetch" href="/assets/09-scopes.html-BhA3Jfl5.js" as="script"><link rel="prefetch" href="/assets/10-rename-refactoring.html-CQ7xy6Op.js" as="script"><link rel="prefetch" href="/assets/11-indentation.html-BSbVKVoe.js" as="script"><link rel="prefetch" href="/assets/12-decl-sections.html-DM3D0T_j.js" as="script"><link rel="prefetch" href="/assets/13-comments.html-PACjUQ8Q.js" as="script"><link rel="prefetch" href="/assets/14-numeric-lit.html-Bx-wwqk6.js" as="script"><link rel="prefetch" href="/assets/15-expressions.html-26eNyM4d.js" as="script"><link rel="prefetch" href="/assets/99-tmp.html-gvMZWEF9.js" as="script"><link rel="prefetch" href="/assets/index.html-J4FG-UC7.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-BeNfzmF-.js" as="script"><link rel="prefetch" href="/assets/02-environment-setup.html-C8XAFCUU.js" as="script"><link rel="prefetch" href="/assets/03-targeting-uefi-p1.html-C9weobAl.js" as="script"><link rel="prefetch" href="/assets/04-targeting-uefi-p2.html-DtpCSkF_.js" as="script"><link rel="prefetch" href="/assets/05-bootloader-p1.html-nF5TI7gq.js" as="script"><link rel="prefetch" href="/assets/06-bootloader-p2.html-lTW7xvyF.js" as="script"><link rel="prefetch" href="/assets/07-kernel-image.html-Dbec7FcX.js" as="script"><link rel="prefetch" href="/assets/08-loading-the-kernel-p1.html-CgEWrWCh.js" as="script"><link rel="prefetch" href="/assets/09-loading-the-kernel-p2.html-Bsyq9hJE.js" as="script"><link rel="prefetch" href="/assets/10-loading-the-kernel-p3.html-Cz6f791z.js" as="script"><link rel="prefetch" href="/assets/11-physical-memory.html-Iko_lfyH.js" as="script"><link rel="prefetch" href="/assets/12-virtual-memory.html-BdHdqaeH.js" as="script"><link rel="prefetch" href="/assets/13-higher-half-kernel.html-U7sLCIG_.js" as="script"><link rel="prefetch" href="/assets/14-memory-segments.html-C0Wfonfg.js" as="script"><link rel="prefetch" href="/assets/15-interrupts.html-CuXOHXlP.js" as="script"><link rel="prefetch" href="/assets/16-user-mode.html-DI-QEaJn.js" as="script"><link rel="prefetch" href="/assets/17-tss.html-DedksTv0.js" as="script"><link rel="prefetch" href="/assets/18-system-calls.html-CANG8AhC.js" as="script"><link rel="prefetch" href="/assets/19-tasks.html-D_KA9R1n.js" as="script"><link rel="prefetch" href="/assets/20-position-independent-code.html-DcxhRHAD.js" as="script"><link rel="prefetch" href="/assets/21-elf-loader-p1.html-hRqOVejE.js" as="script"><link rel="prefetch" href="/assets/22-elf-loader-p2.html-CwKLac9X.js" as="script"><link rel="prefetch" href="/assets/23-coop-multitasking.html-CmjVNMNt.js" as="script"><link rel="prefetch" href="/assets/24-system-library.html-Chl8ifRh.js" as="script"><link rel="prefetch" href="/assets/25-interrupt-controller.html-i_QNpPOS.js" as="script"><link rel="prefetch" href="/assets/index.html--jTsfqNO.js" as="script"><link rel="prefetch" href="/assets/404.html-CYnd4SKg.js" as="script"><link rel="prefetch" href="/assets/SearchResult-ZUCfC4Sv.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">Khaled Hammouda</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading active" href="/nimjet/" aria-label="NimJet"><!---->NimJet<!----></a><ul class="vp-sidebar-children" style=""><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/01-intro" aria-label="Introduction"><!---->Introduction<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/02-setup" aria-label="Project Setup"><!---->Project Setup<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/03-filetype" aria-label="File Type"><!---->File Type<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/04-lexer" aria-label="Lexer"><!---->Lexer<!----></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/nimjet/05-parser" aria-label="Parser"><!---->Parser<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/06-parser-p2" aria-label="Parser Implementation"><!---->Parser Implementation<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/07-grammarkit" aria-label="Grammar-Kit"><!---->Grammar-Kit<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/08-go-to-decl" aria-label="Go To Declaration"><!---->Go To Declaration<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/09-scopes" aria-label="Scope Resolution"><!---->Scope Resolution<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/10-rename-refactoring" aria-label="Rename Refactoring"><!---->Rename Refactoring<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/11-indentation" aria-label="Indentation"><!---->Indentation<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/12-decl-sections" aria-label="Declaration Sections"><!---->Declaration Sections<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/13-comments" aria-label="Comments"><!---->Comments<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/14-numeric-lit" aria-label="Numeric Literals"><!---->Numeric Literals<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/15-expressions" aria-label="Expressions"><!---->Expressions<!----></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="parser" tabindex="-1"><a class="header-anchor" href="#parser"><span>Parser</span></a></h1><p>In this section, we will explore the various concepts involved in parsing, including how the parser works, structure of the AST and the PSI, and how they are related. In the next section, we will implement a simple parser by hand, before moving on to generate the parser using Grammar-Kit.</p><h2 id="overview" tabindex="-1"><a class="header-anchor" href="#overview"><span>Overview</span></a></h2><p>In order to work with the language constructs at a higher level, we need to parse the source code. The parser is responsible for converting the stream of tokens provided by the lexer into an abstract syntax tree (AST).</p><p>However, while the AST provides a view into the structure of the source code, it does not provide any semantic information. For example, while the parser can determine that a sequence of tokens is a function call, it cannot determine if the function is defined or if the arguments are valid. This is where the Program Structure Interface (PSI) comes in. The PSI is built on top of the AST, and provides a higher-level API for working with the source code.</p><p>The following diagram shows the relationship between the lexer, parser, AST, and PSI.</p><p style="text-align:center;"><img src="/assets/parsing-DgVhCBlr.png" alt="Parsing" width="600"></p><ul><li>The lexer reads the source code as a sequence of characters and produces a stream of tokens.</li><li>The parser (with the help of <code>PsiBuilder</code>) reads the stream of tokens and produces an abstract syntax tree (AST).</li><li>The conversion from AST to PSI is done through the <code>ParserDefinition.createElement()</code> method, which is responsible for creating the appropriate PSI elements for a given AST node.</li></ul><p>I&#39;m not sure why the <code>PsiBuilder</code> is named as such, since it is used in the parsing step which produces AST nodes, not PSI elements. In my opinion, it would make more sense to name it <code>AstBuilder</code> instead ¯\_(ツ)_/¯.</p><h2 id="ast-structure" tabindex="-1"><a class="header-anchor" href="#ast-structure"><span>AST Structure</span></a></h2><p>Every node in the AST is represented by the <code>ASTNode</code> interface, which holds a reference to an <code>IElementType</code> object that represents the type of the node. There are three types of nodes in the AST, represented by classes that extend <code>IElementType</code>:</p><ul><li>the root node: represents the entire file (an instance of <code>IFileElementType</code>),</li><li>intermediate nodes: represent the production rules in the grammar (instances of <code>NimElementType</code>), and</li><li>leaf nodes: represent the tokens produced by the lexer (instances of <code>NimTokenType</code>).</li></ul><p>Note that the <code>IFileElementType</code> node type has nothing to do with the file type discussed in the <a class="route-link" href="/nimjet/03-filetype">File Type</a> section. The former is a node type in the AST, while the latter represents a file type in the IDE (which does not necessarily have to be a language file).</p><p>In the following diagram, I try to illustrate these types of nodes, their base classes, and how the AST is created by the parser.</p><p><img src="/assets/ast-structure-Bw1zoPmL.png" alt="AST Structure"></p><p>The three boxes labelled with the <code>AST</code> tag represent the three types of nodes described above. They are given placeholder names to indicate that they are instances of classes that extend <code>IElementType</code>, and that the name of those instances depends on the language construct they represent.</p><ul><li><code>$FileElementName$</code> is a singleton that represents the root node type of the AST (e.g. <code>NIM_FILE</code>)</li><li><code>$ElementName$</code> represents an intermediate node (e.g. <code>CASE_STMT</code>)</li><li><code>$TokenName$</code> represents a leaf node (e.g. <code>STRING_LIT</code>)</li></ul><p>But how does the parser actually create the AST? In the diagram, <code>NimParser</code> is the actual parser class (which can be handwritten or generated), which drives the <code>PsiBuilder</code> by <em>marking</em> regions of tokens in the input stream as nodes in the tree. When the parser tries to parse a grammar rule, it tells the <code>PsiBuilder</code> to start a <em>marker</em> (a region of tokens that will be converted into a node in the AST), and then calls the appropriate method to parse the rule. When the rule is successfully parsed, the parser tells the <code>PsiBuilder</code> to set the marker as <em>done</em>, and passes the matched element type to be associated with the node. If the rule is not parsed successfully, the parser either tells the <code>PsiBuilder</code> to <em>rollback</em> the marker, or generate an error node. Creating markers is done recursively, as the parser descends into the grammar rules.</p><p>As nodes are marked by the parser, the <code>PsiBuilder</code> creates <code>ASTNode</code> instances (implemented by <code>TreeElement</code>), to represent the nodes in the AST. Each <code>ASTNode</code> has a reference to the <code>IElementType</code> object that represents the type of the node (the ones mentioned above). The parser returns the final root node of the AST by calling the <code>PsiBuilder.getTreeBuilt()</code> method.</p><p>The final piece of the puzzle is the <code>ParserDefinition</code> class, which provides methods for creating the lexer (<code>createLexer</code>), the parser (<code>createParser</code>), and the element type representing the root node of the AST (<code>getFileNodeType</code>), which is an instance of <code>IFileElementType</code>.</p><p>The <code>ParserDefinition</code> class also provides a few methods for returning <code>TokenSet</code> objects (not shown in the diagram) that identify certain types of tokens: comments, whitespace, and string literals.</p><ul><li><code>getWhitespaceTokens()</code>: returns a <code>TokenSet</code> of whitespace tokens. These tokens are typically ignored by the parser.</li><li><code>getCommentTokens()</code>: returns a <code>TokenSet</code> of comment tokens. These tokens are also typically ignored by the parser. They are also used to search for <code>TODO</code> patterns in comments.</li><li><code>getStringLiteralElements()</code>: returns a <code>TokenSet</code> of string literal tokens. These tokens are used by the &quot;Search in strings&quot; option during refactoring.</li></ul><h2 id="psi-structure" tabindex="-1"><a class="header-anchor" href="#psi-structure"><span>PSI Structure</span></a></h2><p>As mentioned earlier, the PSI is built on top of the AST, and provides a higher-level API for working with the source code. You can think of the PSI as an enriched view of the AST, with capabilities to navigate, search, and modify the source code. The following diagram shows the different classes and interfaces that make up the PSI, and their relationship to the AST and the <code>ParserDefinition</code>.</p><p style="text-align:center;"><img src="/assets/psi-structure-BJf_ugxf.png" alt="PSI Structure" width="700"></p><p>The bridge between the AST and the PSI is the <code>ASTWrapperPsiElement</code> class, which is a wrapper around an <code>ASTNode</code> that implements the <code>PsiElement</code> interface. The AST is converted to a PSI tree through the <code>ParserDefinition.createElement()</code> method, which creates the appropriate PSI element for a given AST node.</p><p>The entire file is represented by an instance of the <code>PsiFile</code> interface, which also extends <code>PsiElement</code>. This interface is the typical entry point for working with the PSI tree. In our case, the <code>NimFile</code> class implements <code>PsiFile</code>, and is created through the <code>ParserDefinition.createFile()</code> method.</p><p>The PSI tree is then used by the IDE to provide code completion, navigation, refactoring, and other features.</p><p>Now that we have an idea of how the various components of the parser work together, in the next section we will implement a very simpler parser by hand for a simple statement to get a deeper understanding of the process. Later, we will use Grammar-Kit to generate the parser for us from a BNF grammar, since writing a full parser for Nim by hand would be tedious and error-prone.</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/nimjet/04-lexer" aria-label="Lexer"><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span>Lexer</span></div></a><a class="route-link auto-link next" href="/nimjet/06-parser-p2" aria-label="Parser Implementation"><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span>Parser Implementation</span></div></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BEnvQN0t.js" defer></script>
  </body>
</html>
