<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.15" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #22272e;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>Go To Declaration | Khaled Hammouda</title><meta name="description" content="Building a 64-bit operating system from scratch in Nim">
    <link rel="preload" href="/assets/style-DFReAQZD.css" as="style"><link rel="stylesheet" href="/assets/style-DFReAQZD.css">
    <link rel="modulepreload" href="/assets/app-BEnvQN0t.js"><link rel="modulepreload" href="/assets/08-go-to-decl.html-DPftLCwO.js">
    <link rel="prefetch" href="/assets/index.html-DN4baEjd.js" as="script"><link rel="prefetch" href="/assets/index.html-DTcVMSat.js" as="script"><link rel="prefetch" href="/assets/01-mm.html-DdVm3GHI.js" as="script"><link rel="prefetch" href="/assets/index.html-D8_cVHQe.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-Bq4FSDwn.js" as="script"><link rel="prefetch" href="/assets/02-setup.html-9f0UzP9I.js" as="script"><link rel="prefetch" href="/assets/03-filetype.html-DVtyN252.js" as="script"><link rel="prefetch" href="/assets/04-lexer.html-OooGwppm.js" as="script"><link rel="prefetch" href="/assets/05-parser.html-Dw5HPOU5.js" as="script"><link rel="prefetch" href="/assets/06-parser-p2.html-CHLJtldD.js" as="script"><link rel="prefetch" href="/assets/07-grammarkit.html-DALOmYeT.js" as="script"><link rel="prefetch" href="/assets/09-scopes.html-BhA3Jfl5.js" as="script"><link rel="prefetch" href="/assets/10-rename-refactoring.html-CQ7xy6Op.js" as="script"><link rel="prefetch" href="/assets/11-indentation.html-BSbVKVoe.js" as="script"><link rel="prefetch" href="/assets/12-decl-sections.html-DM3D0T_j.js" as="script"><link rel="prefetch" href="/assets/13-comments.html-PACjUQ8Q.js" as="script"><link rel="prefetch" href="/assets/14-numeric-lit.html-Bx-wwqk6.js" as="script"><link rel="prefetch" href="/assets/15-expressions.html-26eNyM4d.js" as="script"><link rel="prefetch" href="/assets/99-tmp.html-gvMZWEF9.js" as="script"><link rel="prefetch" href="/assets/index.html-J4FG-UC7.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-BeNfzmF-.js" as="script"><link rel="prefetch" href="/assets/02-environment-setup.html-C8XAFCUU.js" as="script"><link rel="prefetch" href="/assets/03-targeting-uefi-p1.html-C9weobAl.js" as="script"><link rel="prefetch" href="/assets/04-targeting-uefi-p2.html-DtpCSkF_.js" as="script"><link rel="prefetch" href="/assets/05-bootloader-p1.html-nF5TI7gq.js" as="script"><link rel="prefetch" href="/assets/06-bootloader-p2.html-lTW7xvyF.js" as="script"><link rel="prefetch" href="/assets/07-kernel-image.html-Dbec7FcX.js" as="script"><link rel="prefetch" href="/assets/08-loading-the-kernel-p1.html-CgEWrWCh.js" as="script"><link rel="prefetch" href="/assets/09-loading-the-kernel-p2.html-Bsyq9hJE.js" as="script"><link rel="prefetch" href="/assets/10-loading-the-kernel-p3.html-Cz6f791z.js" as="script"><link rel="prefetch" href="/assets/11-physical-memory.html-Iko_lfyH.js" as="script"><link rel="prefetch" href="/assets/12-virtual-memory.html-BdHdqaeH.js" as="script"><link rel="prefetch" href="/assets/13-higher-half-kernel.html-U7sLCIG_.js" as="script"><link rel="prefetch" href="/assets/14-memory-segments.html-C0Wfonfg.js" as="script"><link rel="prefetch" href="/assets/15-interrupts.html-CuXOHXlP.js" as="script"><link rel="prefetch" href="/assets/16-user-mode.html-DI-QEaJn.js" as="script"><link rel="prefetch" href="/assets/17-tss.html-DedksTv0.js" as="script"><link rel="prefetch" href="/assets/18-system-calls.html-CANG8AhC.js" as="script"><link rel="prefetch" href="/assets/19-tasks.html-D_KA9R1n.js" as="script"><link rel="prefetch" href="/assets/20-position-independent-code.html-DcxhRHAD.js" as="script"><link rel="prefetch" href="/assets/21-elf-loader-p1.html-hRqOVejE.js" as="script"><link rel="prefetch" href="/assets/22-elf-loader-p2.html-CwKLac9X.js" as="script"><link rel="prefetch" href="/assets/23-coop-multitasking.html-CmjVNMNt.js" as="script"><link rel="prefetch" href="/assets/24-system-library.html-Chl8ifRh.js" as="script"><link rel="prefetch" href="/assets/25-interrupt-controller.html-i_QNpPOS.js" as="script"><link rel="prefetch" href="/assets/index.html--jTsfqNO.js" as="script"><link rel="prefetch" href="/assets/404.html-CYnd4SKg.js" as="script"><link rel="prefetch" href="/assets/SearchResult-ZUCfC4Sv.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">Khaled Hammouda</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading active" href="/nimjet/" aria-label="NimJet"><!---->NimJet<!----></a><ul class="vp-sidebar-children" style=""><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/01-intro" aria-label="Introduction"><!---->Introduction<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/02-setup" aria-label="Project Setup"><!---->Project Setup<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/03-filetype" aria-label="File Type"><!---->File Type<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/04-lexer" aria-label="Lexer"><!---->Lexer<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/05-parser" aria-label="Parser"><!---->Parser<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/06-parser-p2" aria-label="Parser Implementation"><!---->Parser Implementation<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/07-grammarkit" aria-label="Grammar-Kit"><!---->Grammar-Kit<!----></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/nimjet/08-go-to-decl" aria-label="Go To Declaration"><!---->Go To Declaration<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/09-scopes" aria-label="Scope Resolution"><!---->Scope Resolution<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/10-rename-refactoring" aria-label="Rename Refactoring"><!---->Rename Refactoring<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/11-indentation" aria-label="Indentation"><!---->Indentation<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/12-decl-sections" aria-label="Declaration Sections"><!---->Declaration Sections<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/13-comments" aria-label="Comments"><!---->Comments<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/14-numeric-lit" aria-label="Numeric Literals"><!---->Numeric Literals<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/15-expressions" aria-label="Expressions"><!---->Expressions<!----></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="go-to-declaration" tabindex="-1"><a class="header-anchor" href="#go-to-declaration"><span>Go To Declaration</span></a></h1><p>Now that we&#39;ve got the basics in place, let&#39;s add our first actual feature: Go To Declaration. Consider this simple Nim program:</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token keyword">let</span> <span class="highlighted-word">msg</span> <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span>   <span class="token comment"># &lt;- declaration</span></span>
<span class="line">echo <span class="highlighted-word">msg</span>            <span class="token comment"># &lt;- reference</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>We want to be able to navigate from the identifier <code>msg</code> in <code>echo msg</code> to the declaration of <code>msg</code> on the first line. In IntelliJ terminology, the <code>msg</code> identifier on the second line is called a <em>reference</em>, which can be <em>resolved</em> to its declaration element.</p><p>The IDE knows that a PSI element is a reference if its <code>getReference()</code> method returns a <code>PsiReference</code> object. This object is <em>not</em> the target element, but rather an object that can resolve the reference to its target by invoking its <code>resolve()</code> method. The implementation of the <code>resolve()</code> method will have to locate the target element in the PSI tree, which can get complex depending on the scoping rules of the language.</p><p>Let&#39;s take a look at the AST generated by the Nim compiler for this code snippet. We can use the <code>dumpTree</code> macro from the <code>macros</code> module to print the AST:</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># dumptree.nim</span></span>
<span class="line"><span class="token keyword">import</span> std<span class="token operator">/</span>macros</span>
<span class="line"></span>
<span class="line">dumpTree<span class="token operator">:</span></span>
<span class="line">  <span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span></span>
<span class="line">  echo msg</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Macros are evaluated at compile time, so to see the output we just need to compile the program using <code>nim c dumptree.nim</code>:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">StmtList</span>
<span class="line">  LetSection</span>
<span class="line">    IdentDefs</span>
<span class="line highlighted">      Ident &quot;msg&quot;</span>
<span class="line">      Empty</span>
<span class="line">      StrLit &quot;hello&quot;</span>
<span class="line">  Command</span>
<span class="line">    Ident &quot;echo&quot;</span>
<span class="line highlighted">    Ident &quot;msg&quot;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The <code>Ident</code> node on line 4 is the declaration of <code>msg</code>, and the one on line 9 is the reference to that declaration. In Nim, one of the places where declarations can be found is the <code>LetSection</code> node, as seen in the output above. So, we need to implement <code>getReference</code> on the element representing the reference to return a <code>PsiReference</code> object. That object will implement <code>resolve</code> to find and return the declaration under the <code>LetSection</code> node.</p><p>However, instead of creating a dedicated class for the reference, we can use the PSI class representing the identifier itself; we just need to make it implement the <code>PsiReference</code> interface. One more thing, even though the Nim AST defines both the declaration and the reference as <code>Ident</code> nodes, it will make our lives easier if we create a separate PSI class for each, e.g. <code>IdentDecl</code> and <code>IdentRef</code>. This way, we can avoid any confusion between the two, and will make identifying <code>IdentDecl</code> in the tree easier when resolving a reference.</p><h2 id="updating-the-grammar" tabindex="-1"><a class="header-anchor" href="#updating-the-grammar"><span>Updating the Grammar</span></a></h2><p>Let&#39;s start by updating the grammar to support the two statements in the example above. We&#39;ll use a simplified version of the Nim AST to guide us:</p><div class="language-bnf line-numbers-mode" data-highlighter="prismjs" data-ext="bnf" data-title="bnf"><pre><code><span class="line">// src/main/kotlin/khaledh/nimjet/parser/Nim.bnf</span>
<span class="line"><span class="token operator">{</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"><span class="token operator">}</span></span>
<span class="line"></span>
<span class="line">Module     <span class="token operator">::=</span> !&lt;<span class="token rule"><span class="token punctuation">&lt;</span>eof<span class="token punctuation">&gt;</span></span>&gt; StmtList</span>
<span class="line">StmtList   <span class="token operator">::=</span> Stmt<span class="token operator">*</span></span>
<span class="line">Stmt       <span class="token operator">::=</span> LetSection</span>
<span class="line">             <span class="token operator">|</span> Command</span>
<span class="line"></span>
<span class="line">LetSection <span class="token operator">::=</span> LET IdentDecl EQ STRING_LIT</span>
<span class="line"></span>
<span class="line">Command    <span class="token operator">::=</span> IdentRef IdentRef</span>
<span class="line"></span>
<span class="line">IdentDecl  <span class="token operator">::=</span> IDENT</span>
<span class="line">IdentRef   <span class="token operator">::=</span> IDENT</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You&#39;ll notice that I simplified the <code>LetSection</code> rule to allow only a single declaration for now (we&#39;ll come back to handling multiple declarations in a single <code>let</code> section later), using <code>IdentDecl</code> instead of an undifferentiated <code>IDENT</code>. The <code>Command</code> rule is also simplified to only allow two <code>IdentRef</code> elements.</p><p>If we generate the parser and PSI classes now, we&#39;ll have the following files:</p><div class="language-tree line-numbers-mode" data-highlighter="prismjs" data-ext="tree" data-title="tree"><pre><code><span class="line">src/main/gen</span>
<span class="line">└── khaledh/nimjet</span>
<span class="line">    ├── parser</span>
<span class="line">    │   ├── NimElement.java</span>
<span class="line">    │   └── NimParser.java</span>
<span class="line">    └── psi</span>
<span class="line">        ├── impl</span>
<span class="line">        │   ├── CommandImpl.java</span>
<span class="line">        │   ├── IdentDeclImpl.java</span>
<span class="line">        │   ├── IdentRefImpl.java</span>
<span class="line">        │   ├── LetSectionImpl.java</span>
<span class="line">        │   ├── Stmt.java</span>
<span class="line">        │   └── StmtListImpl.java</span>
<span class="line">        ├── Command.java</span>
<span class="line">        ├── IdentDecl.java</span>
<span class="line">        ├── IdentRef.java</span>
<span class="line">        ├── LetSection.java</span>
<span class="line">        ├── Stmt.java</span>
<span class="line">        └── StmtList.java</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="reference-mixin" tabindex="-1"><a class="header-anchor" href="#reference-mixin"><span>Reference Mixin</span></a></h2><p>Our goal is to be able to navigate from a reference to its declaration. In our case, the reference element is <code>IdentRef</code>, and the declaration element is <code>IdentDecl</code>. The reference element needs to override the <code>getReference</code> method to return a <code>PsiReference</code> object. But how do we tell Grammar-Kit to generate the <code>getReference</code> method for <code>IdentRef</code>? The answer is using mixins. The way mixins work in Grammar-Kit is that we create a mixin class for a particular element, and then we tell Grammar-Kit to mix that class into the generated PSI class for that element. So, let&#39;s go ahead and create a mixin class for <code>IdentRef</code> that implements the <code>getReference</code> method:</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt" data-title="kt"><pre><code><span class="line"><span class="token comment">// src/main/kotlin/khaledh/nimjet/psi/impl/IdentRefMixin.kt</span></span>
<span class="line"><span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token function">IdentRefMixin</span><span class="token punctuation">(</span>node<span class="token operator">:</span> ASTNode<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ASTWrapperPsiElement</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">,</span> IdentRef <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> PsiReference <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">IdentReference</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">TextRange</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>textLength<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We haven&#39;t implemented <code>IdentReference</code> yet; we&#39;ll do that in a moment. But first, notice that the mixin class extends <code>ASTWrapperPsiElement</code>, and implements the <code>IdentRef</code> interface generated by Grammar-Kit. Normally, this signature would be implemented by the generated <code>IdentRefImpl</code> class, but when we tell Grammar-Kit to use a mixin class for an element, it will use the mixin class as the base class for the element instead. So, the generated <code>IdentRefImpl</code> class will extend <code>IdentRefMixin</code>, and that&#39;s why the mixin class needs to take over the responsibility of extending <code>ASTWrapperPsiElement</code>.</p><p>Let&#39;s update the BNF file to use the mixin:</p><div class="language-bnf line-numbers-mode" data-highlighter="prismjs" data-ext="bnf" data-title="bnf"><pre><code><span class="line"><span class="token operator">{</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line">  mixin<span class="token operator">(</span><span class="token string">&quot;IdentRef&quot;</span><span class="token operator">)</span>=<span class="token string">&quot;khaledh.nimjet.psi.impl.IdentRefMixin&quot;</span></span>
<span class="line"><span class="token operator">}</span></span>
<span class="line"><span class="token operator">...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now, if we generate the parser and PSI classes, we&#39;ll see that the <code>IdentRefImpl</code> class extends <code>IdentRefMixin</code> instead of <code>ASTWrapperPsiElement</code>:</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// src/main/gen/khaledh/nimjet/psi/impl/IdentRefImpl.java</span></span>
<span class="line"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IdentRefImpl</span> <span class="token keyword">extends</span> <span class="token class-name">IdentRefMixin</span> <span class="token keyword">implements</span> <span class="token class-name">IdentRef</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now, let&#39;s implement the <code>IdentReference</code> class, which represents the reference to an identifier. This class will implement the <code>PsiReference</code> interface, and its <code>resolve</code> method will find and return the declaration element in the PSI tree.</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt" data-title="kt"><pre><code><span class="line"><span class="token comment">// src/main/kotlin/khaledh/nimjet/psi/IdentReference.kt</span></span>
<span class="line"><span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token function">IdentReference</span><span class="token punctuation">(</span>element<span class="token operator">:</span> IdentRef<span class="token punctuation">,</span> textRange<span class="token operator">:</span> TextRange<span class="token punctuation">)</span></span>
<span class="line">    <span class="token operator">:</span> PsiReferenceBase<span class="token operator">&lt;</span>IdentRef<span class="token operator">&gt;</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> textRange<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> PsiElement<span class="token operator">?</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// This is a naive implementation; we&#39;ll improve it later</span></span>
<span class="line">        <span class="token keyword">val</span> identDecl <span class="token operator">=</span> PsiTreeUtil<span class="token punctuation">.</span>findChildOfType<span class="token operator">&lt;</span>IdentDecl<span class="token operator">&gt;</span><span class="token punctuation">(</span></span>
<span class="line">            myElement<span class="token punctuation">.</span>containingFile<span class="token punctuation">,</span> IdentDecl<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>identDecl<span class="token operator">?</span><span class="token punctuation">.</span>name <span class="token operator">==</span> myElement<span class="token punctuation">.</span>text<span class="token punctuation">)</span> identDecl <span class="token keyword">else</span> <span class="token keyword">null</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The <code>resolve</code> method uses the <code>PsiTreeUtil</code> utility class to find the first child of the file that is an <code>IdentDecl</code> element. It then checks if the name of the declaration matches the text of the reference, and returns the declaration element if it does.</p><p>Obviously, this is a naive implementation that works only if the first declaration in the file is the one we&#39;re looking for. Another thing I&#39;m ignoring here is Nim&#39;s insensitivity to naming style (e.g. <code>myVar</code> and <code>my_var</code> are considered the same). This is just simple way to demonstrate the concept. We&#39;ll improve it later.</p><h2 id="declaration-mixin" tabindex="-1"><a class="header-anchor" href="#declaration-mixin"><span>Declaration Mixin</span></a></h2><p>Now that we have the reference side of things set up, let&#39;s move on to the declaration side. The platform docs state that:</p><blockquote><p>Every PSI element that can be renamed or referenced needs to implement [the] <code>PsiNamedElement</code> interface.</p></blockquote><p>It also mentions, in a different section, that:</p><blockquote><p>In order to enable more advanced functionality, prefer implementing <code>PsiNameIdentifierOwner</code> over <code>PsiNamedElement</code> where possible.</p></blockquote><p>It&#39;s not clear to me in what context and what features <code>PsiNameIdentifierOwner</code> provides over <code>PsiNamedElement</code>. From what I can tell, <code>PsiNameIdentifierOwner</code> is used when the name of the element is not directly accessible from the element itself, but is instead stored in a separate child element. In our case, the actual name of the identifier is stored in the <code>IDENT</code> token, which is a child of the <code>IdentDecl</code> element. So, we&#39;ll go with <code>PsiNamedElement</code> and implement its <code>getNameIdentifier</code> method to return the <code>IDENT</code> element.</p><p>Let&#39;s create a mixin class for <code>IdentDecl</code> that implements <code>PsiNameIdentifierOwner</code>:</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt" data-title="kt"><pre><code><span class="line"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token function">IdentDeclMixin</span><span class="token punctuation">(</span>node<span class="token operator">:</span> ASTNode<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ASTWrapperPsiElement</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">,</span> IdentDecl <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getNameIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> PsiElement<span class="token operator">?</span> <span class="token operator">=</span> ident</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> ident<span class="token punctuation">.</span>text</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> PsiElement <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">TODO</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Not yet implemented&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The <code>getNameIdentifier</code> method returns the <code>IDENT</code> token element. Let&#39;s look at how it&#39;s implemented in the generated <code>IdentDeclImpl</code> class:</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IdentDeclImpl</span> <span class="token keyword">extends</span> <span class="token class-name">IdentDeclMixin</span> <span class="token keyword">implements</span> <span class="token class-name">IdentDecl</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">public</span> <span class="token class-name">IdentDeclImpl</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotNull</span> <span class="token class-name">ASTNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">super</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token annotation punctuation">@Override</span></span>
<span class="line">  <span class="token annotation punctuation">@NotNull</span></span>
<span class="line">  <span class="token keyword">public</span> <span class="token class-name">PsiElement</span> <span class="token function">getIdent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">findNotNullChildByType</span><span class="token punctuation">(</span><span class="token constant">IDENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The implementation generated by Grammar-Kit has a <code>getIdent</code> method that finds the <code>IDENT</code> child token. Since we&#39;re using Kotlin, the <code>getIdent</code> method is automatically converted to a property <code>ident</code> in the Kotlin class. This is why we can access <code>ident</code> directly in the mixin class.</p><p>Let&#39;s update the BNF file to use the mixin, and also tell Grammar-Kit that <code>IdentDecl</code> implements <code>PsiNameIdentifierOwner</code>:</p><div class="language-bnf line-numbers-mode" data-highlighter="prismjs" data-ext="bnf" data-title="bnf"><pre><code><span class="line"><span class="token operator">{</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line">  implements<span class="token operator">(</span><span class="token string">&quot;IdentDecl&quot;</span><span class="token operator">)</span>=<span class="token string">&quot;com.intellij.psi.PsiNameIdentifierOwner&quot;</span></span>
<span class="line">  mixin<span class="token operator">(</span><span class="token string">&quot;IdentDecl&quot;</span><span class="token operator">)</span>=<span class="token string">&quot;khaledh.nimjet.psi.impl.IdentDeclMixin&quot;</span></span>
<span class="line"><span class="token operator">}</span></span>
<span class="line"><span class="token operator">...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now, let&#39;s generate the parser and PSI classes and test the <strong>Go To Declaration</strong> feature in the sandbox IDE.</p><p><img src="/assets/ref-decl-highlight-Fy0LCYz9.png" alt="Ident Reference and Declaration" width="400"></p><p>Notice that the reference and declaration are highlighted when the cursor is on either of them. This is because the IDE recognizes that the reference can be resolved to the declaration, and it highlights the declaration when the reference is selected (and vice versa). To test the navigation feature, place the cursor on the reference and press <code>Ctrl+B</code> (or <code>Cmd+B</code> on macOS) to navigate to the declaration. We can also place the cursor on the declaration and press <code>Ctrl+B</code> to navigate to the reference. Neat!</p><p>Let&#39;s also take a look at the PSI tree:</p><p><img src="/assets/ref-decl-psi-Brk-Ci6p.png" alt="Ident Ref and Decl PSI"></p><p>If we click on the <code>IdentRef</code> node, we can see that it has a reference to the <code>IdentDecl</code> node. Great!</p><p>In the next section, we&#39;ll improve reference resolution to take into account scoping rules, so that references are resolved to their correct declaration.</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/nimjet/07-grammarkit" aria-label="Grammar-Kit"><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span>Grammar-Kit</span></div></a><a class="route-link auto-link next" href="/nimjet/09-scopes" aria-label="Scope Resolution"><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span>Scope Resolution</span></div></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BEnvQN0t.js" defer></script>
  </body>
</html>
