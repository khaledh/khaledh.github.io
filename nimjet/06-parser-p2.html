<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.15" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #22272e;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>Parser Implementation | Khaled Hammouda</title><meta name="description" content="Building a 64-bit operating system from scratch in Nim">
    <link rel="preload" href="/assets/style-DFReAQZD.css" as="style"><link rel="stylesheet" href="/assets/style-DFReAQZD.css">
    <link rel="modulepreload" href="/assets/app-BEnvQN0t.js"><link rel="modulepreload" href="/assets/06-parser-p2.html-CHLJtldD.js">
    <link rel="prefetch" href="/assets/index.html-DN4baEjd.js" as="script"><link rel="prefetch" href="/assets/index.html-DTcVMSat.js" as="script"><link rel="prefetch" href="/assets/01-mm.html-DdVm3GHI.js" as="script"><link rel="prefetch" href="/assets/index.html-D8_cVHQe.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-Bq4FSDwn.js" as="script"><link rel="prefetch" href="/assets/02-setup.html-9f0UzP9I.js" as="script"><link rel="prefetch" href="/assets/03-filetype.html-DVtyN252.js" as="script"><link rel="prefetch" href="/assets/04-lexer.html-OooGwppm.js" as="script"><link rel="prefetch" href="/assets/05-parser.html-Dw5HPOU5.js" as="script"><link rel="prefetch" href="/assets/07-grammarkit.html-DALOmYeT.js" as="script"><link rel="prefetch" href="/assets/08-go-to-decl.html-DPftLCwO.js" as="script"><link rel="prefetch" href="/assets/09-scopes.html-BhA3Jfl5.js" as="script"><link rel="prefetch" href="/assets/10-rename-refactoring.html-CQ7xy6Op.js" as="script"><link rel="prefetch" href="/assets/11-indentation.html-BSbVKVoe.js" as="script"><link rel="prefetch" href="/assets/12-decl-sections.html-DM3D0T_j.js" as="script"><link rel="prefetch" href="/assets/13-comments.html-PACjUQ8Q.js" as="script"><link rel="prefetch" href="/assets/14-numeric-lit.html-Bx-wwqk6.js" as="script"><link rel="prefetch" href="/assets/15-expressions.html-26eNyM4d.js" as="script"><link rel="prefetch" href="/assets/99-tmp.html-gvMZWEF9.js" as="script"><link rel="prefetch" href="/assets/index.html-J4FG-UC7.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-BeNfzmF-.js" as="script"><link rel="prefetch" href="/assets/02-environment-setup.html-C8XAFCUU.js" as="script"><link rel="prefetch" href="/assets/03-targeting-uefi-p1.html-C9weobAl.js" as="script"><link rel="prefetch" href="/assets/04-targeting-uefi-p2.html-DtpCSkF_.js" as="script"><link rel="prefetch" href="/assets/05-bootloader-p1.html-nF5TI7gq.js" as="script"><link rel="prefetch" href="/assets/06-bootloader-p2.html-lTW7xvyF.js" as="script"><link rel="prefetch" href="/assets/07-kernel-image.html-Dbec7FcX.js" as="script"><link rel="prefetch" href="/assets/08-loading-the-kernel-p1.html-CgEWrWCh.js" as="script"><link rel="prefetch" href="/assets/09-loading-the-kernel-p2.html-Bsyq9hJE.js" as="script"><link rel="prefetch" href="/assets/10-loading-the-kernel-p3.html-Cz6f791z.js" as="script"><link rel="prefetch" href="/assets/11-physical-memory.html-Iko_lfyH.js" as="script"><link rel="prefetch" href="/assets/12-virtual-memory.html-BdHdqaeH.js" as="script"><link rel="prefetch" href="/assets/13-higher-half-kernel.html-U7sLCIG_.js" as="script"><link rel="prefetch" href="/assets/14-memory-segments.html-C0Wfonfg.js" as="script"><link rel="prefetch" href="/assets/15-interrupts.html-CuXOHXlP.js" as="script"><link rel="prefetch" href="/assets/16-user-mode.html-DI-QEaJn.js" as="script"><link rel="prefetch" href="/assets/17-tss.html-DedksTv0.js" as="script"><link rel="prefetch" href="/assets/18-system-calls.html-CANG8AhC.js" as="script"><link rel="prefetch" href="/assets/19-tasks.html-D_KA9R1n.js" as="script"><link rel="prefetch" href="/assets/20-position-independent-code.html-DcxhRHAD.js" as="script"><link rel="prefetch" href="/assets/21-elf-loader-p1.html-hRqOVejE.js" as="script"><link rel="prefetch" href="/assets/22-elf-loader-p2.html-CwKLac9X.js" as="script"><link rel="prefetch" href="/assets/23-coop-multitasking.html-CmjVNMNt.js" as="script"><link rel="prefetch" href="/assets/24-system-library.html-Chl8ifRh.js" as="script"><link rel="prefetch" href="/assets/25-interrupt-controller.html-i_QNpPOS.js" as="script"><link rel="prefetch" href="/assets/index.html--jTsfqNO.js" as="script"><link rel="prefetch" href="/assets/404.html-CYnd4SKg.js" as="script"><link rel="prefetch" href="/assets/SearchResult-ZUCfC4Sv.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">Khaled Hammouda</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading active" href="/nimjet/" aria-label="NimJet"><!---->NimJet<!----></a><ul class="vp-sidebar-children" style=""><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/01-intro" aria-label="Introduction"><!---->Introduction<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/02-setup" aria-label="Project Setup"><!---->Project Setup<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/03-filetype" aria-label="File Type"><!---->File Type<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/04-lexer" aria-label="Lexer"><!---->Lexer<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/05-parser" aria-label="Parser"><!---->Parser<!----></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/nimjet/06-parser-p2" aria-label="Parser Implementation"><!---->Parser Implementation<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/07-grammarkit" aria-label="Grammar-Kit"><!---->Grammar-Kit<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/08-go-to-decl" aria-label="Go To Declaration"><!---->Go To Declaration<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/09-scopes" aria-label="Scope Resolution"><!---->Scope Resolution<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/10-rename-refactoring" aria-label="Rename Refactoring"><!---->Rename Refactoring<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/11-indentation" aria-label="Indentation"><!---->Indentation<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/12-decl-sections" aria-label="Declaration Sections"><!---->Declaration Sections<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/13-comments" aria-label="Comments"><!---->Comments<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/14-numeric-lit" aria-label="Numeric Literals"><!---->Numeric Literals<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/15-expressions" aria-label="Expressions"><!---->Expressions<!----></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="parser-implementation" tabindex="-1"><a class="header-anchor" href="#parser-implementation"><span>Parser Implementation</span></a></h1><p>In this section, we will implement a simple parser by hand to parse the following Nim statement:</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line">echo <span class="token string">&quot;Hello, World!&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>The result of the parsing will be:</p><ul><li>an AST representing the structure of the statement, and</li><li>an equivalent PSI tree that the IDE recognizes and can work with.</li></ul><p>We will rely on the built-in PSI viewer to inspect the PSI tree generated by our parser.</p><h2 id="token-element-and-psi-types" tabindex="-1"><a class="header-anchor" href="#token-element-and-psi-types"><span>Token, Element, and PSI Types</span></a></h2><p>Before we start parsing, we need to define the token and element types we will be using. Let&#39;s start with the token types:</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt" data-title="kt"><pre><code><span class="line"><span class="token comment">// src/main/kotlin/khaledh/nimjet/NimTokenType.kt</span></span>
<span class="line"><span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token function">NimTokenType</span><span class="token punctuation">(</span>debugName<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">IElementType</span><span class="token punctuation">(</span>debugName<span class="token punctuation">,</span> NimLanguage<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">interface</span> NimToken <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token annotation builtin">@JvmField</span> <span class="token keyword">val</span> IDENTIFIER <span class="token operator">=</span> <span class="token function">NimTokenType</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;IDENTIFIER&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token annotation builtin">@JvmField</span> <span class="token keyword">val</span> STRING_LIT <span class="token operator">=</span> <span class="token function">NimTokenType</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;STRING_LIT&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We define two token types: <code>IDENTIFIER</code> and <code>STRING_LIT</code>, which are instances of <code>NimTokenType</code> (which extends <code>IElementType</code>). We will use <code>IDENTIFIER</code> to represent the <code>echo</code> proc name, and <code>STRING_LIT</code> to represent the string literal <code>&quot;Hello, World!&quot;</code>.</p><p style="font-size:80%;"><b>Note:</b> The <code>@JvmField</code> annotation is used to expose the companion object fields as static fields so that we can refer to them as <code>NimToken.IDENTIFIER</code> instead of <code>NimToken.Companion.IDENTIFIER</code>. </p><p>Next, we define the element types that will be used to represent the nodes in the AST:</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt" data-title="kt"><pre><code><span class="line"><span class="token comment">// src/main/kotlin/khaledh/nimjet/NimElementType.kt</span></span>
<span class="line"><span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token function">NimElementType</span><span class="token punctuation">(</span>debugName<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">IElementType</span><span class="token punctuation">(</span>debugName<span class="token punctuation">,</span> NimLanguage<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">interface</span> NimElement <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token annotation builtin">@JvmField</span> <span class="token keyword">val</span> FILE <span class="token operator">=</span> <span class="token function">IFileElementType</span><span class="token punctuation">(</span>NimLanguage<span class="token punctuation">)</span></span>
<span class="line">        <span class="token annotation builtin">@JvmField</span> <span class="token keyword">val</span> STMT <span class="token operator">=</span> <span class="token function">NimElementType</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;STMT&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We have two element types: <code>FILE</code>, which is an instance of <code>IFileElementType</code> (the root element type), and <code>STMT</code>, which is an instance of <code>NimElementType</code>. We will use the <code>STMT</code> element to represent the whole statement.</p><p>Finally, we define the PSI element types that will be used to represent the nodes in the PSI tree. We&#39;ll use a separate class/file for each PSI element, since we&#39;ll be adding more functionality to them later. First, let&#39;s define the root PSI element, <code>NimFile</code>:</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt" data-title="kt"><pre><code><span class="line"><span class="token comment">// src/main/kotlin/khaledh/nimjet/psi/NimFile.kt</span></span>
<span class="line"><span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token function">NimFile</span><span class="token punctuation">(</span>viewProvider<span class="token operator">:</span> FileViewProvider<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">PsiFileBase</span><span class="token punctuation">(</span>viewProvider<span class="token punctuation">,</span> NimLanguage<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getFileType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> FileType <span class="token operator">=</span> NimFileType</span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;NimFile&quot;</span></span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The <code>NimFile</code> class extends <code>PsiFileBase</code>, which is a base class that provides a default implementation for the <code>PsiFile</code> interface methods. We override <code>getFileType</code> to return our <code>NimFileType</code> instance, and <code>toString</code> to return a string representation of the PSI file node.</p><p>Next, we define the PSI element for the statement, <code>NimStmt</code>:</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt" data-title="kt"><pre><code><span class="line"><span class="token comment">// src/main/kotlin/khaledh/nimjet/psi/NimStmt.kt</span></span>
<span class="line"><span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token function">NimStmt</span><span class="token punctuation">(</span>node<span class="token operator">:</span> ASTNode<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ASTWrapperPsiElement</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>All PSI elements will extend <code>ASTWrapperPsiElement</code>, which is a base class that wraps an <code>ASTNode</code> and provides a default implementation for the <code>PsiElement</code> interface methods.</p><p>This completes the definition of the token, element, and PSI types we will be using in our simple parser.</p><h2 id="lexer" tabindex="-1"><a class="header-anchor" href="#lexer"><span>Lexer</span></a></h2><p>Let&#39;s update our JFlex lexer spec to recognize the two types of tokens we introduced:</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// src/main/kotlin/khaledh/nimjet/Nim.flex</span></span>
<span class="line"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">khaledh<span class="token punctuation">.</span>nimjet<span class="token punctuation">.</span></span><span class="token class-name">NimTokenType</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">%</span><span class="token operator">%</span></span>
<span class="line"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">%</span><span class="token operator">%</span></span>
<span class="line"></span>
<span class="line"><span class="token generics"><span class="token punctuation">&lt;</span>YYINITIAL<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token punctuation">[</span>a<span class="token operator">-</span>zA<span class="token operator">-</span><span class="token class-name">Z</span><span class="token punctuation">]</span><span class="token punctuation">[</span>a<span class="token operator">-</span>zA<span class="token operator">-</span><span class="token constant">Z0</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">*</span>           <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token class-name">NimToken</span><span class="token punctuation">.</span><span class="token constant">IDENTIFIER</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">  \&quot;<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">^</span>\&quot;\\<span class="token punctuation">]</span><span class="token operator">|</span>\\<span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token operator">*</span>\&quot;             <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token class-name">NimToken</span><span class="token punctuation">.</span><span class="token constant">STRING_LIT</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">[</span> \t\n\r<span class="token punctuation">]</span><span class="token operator">+</span>                     <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token class-name">TokenType</span><span class="token punctuation">.</span><span class="token constant">WHITE_SPACE</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// error fallback</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token operator">^</span><span class="token punctuation">]</span>                            <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token class-name">TokenType</span><span class="token punctuation">.</span><span class="token constant">BAD_CHARACTER</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We added two rules to match the two token types we defined:</p><ul><li><code>IDENTIFIER</code>: matches any sequence of letters and digits starting with a letter</li><li><code>STRING_LIT</code>: matches a string literal enclosed in double quotes (with support for escape sequences)</li></ul><h2 id="parser" tabindex="-1"><a class="header-anchor" href="#parser"><span>Parser</span></a></h2><p>Now, let&#39;s implement the parser. We will create a <code>NimParser</code> class that extends <code>PsiParser</code>, and drives a <code>PsiBuilder</code> to create the AST by marking regions of tokens as nodes in the tree. The parsing approach we will use is called <em>recursive descent</em>, where each grammar rule is implemented as a method in the parser class. Let&#39;s start with a simple implementation without error handling to focus on the parsing logic:</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt" data-title="kt"><pre><code><span class="line"><span class="token comment">// src/main/kotlin/khaledh/nimjet/NimParser.kt</span></span>
<span class="line"><span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> NimParser <span class="token operator">:</span> PsiParser <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// Grammar:</span></span>
<span class="line">    <span class="token comment">//   file ::= stmt</span></span>
<span class="line">    <span class="token comment">//   stmt ::= IDENTIFIER STRING_LIT</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">parse</span><span class="token punctuation">(</span>root<span class="token operator">:</span> IElementType<span class="token punctuation">,</span> builder<span class="token operator">:</span> PsiBuilder<span class="token punctuation">)</span><span class="token operator">:</span> ASTNode <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">parseFile</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> builder<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> builder<span class="token punctuation">.</span>treeBuilt</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">parseFile</span><span class="token punctuation">(</span>root<span class="token operator">:</span> IElementType<span class="token punctuation">,</span> builder<span class="token operator">:</span> PsiBuilder<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">var</span> marker <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token function">parseStmt</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        marker<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span>NimElement<span class="token punctuation">.</span>FILE<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">parseStmt</span><span class="token punctuation">(</span>builder<span class="token operator">:</span> PsiBuilder<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">var</span> marker <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token function">assert</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>tokenType <span class="token operator">==</span> NimToken<span class="token punctuation">.</span>IDENTIFIER<span class="token punctuation">)</span></span>
<span class="line">        builder<span class="token punctuation">.</span><span class="token function">advanceLexer</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token function">assert</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>tokenType <span class="token operator">==</span> NimToken<span class="token punctuation">.</span>STRING_LIT<span class="token punctuation">)</span></span>
<span class="line">        builder<span class="token punctuation">.</span><span class="token function">advanceLexer</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        marker<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span>NimElement<span class="token punctuation">.</span>STMT<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The parser is very simple: it defines two grammar rules:</p><ul><li><code>file ::= stmt</code>: a file consists of a single statement</li><li><code>stmt ::= IDENTIFIER STRING_LIT</code>: a statement consists of an identifier followed by a string literal</li></ul><p>The recursive descent parsing is done by starting with the <code>parseFile</code> method, which represents the <code>file</code> rule. Since the rule consists of a single statement, we <em>descend</em> into the <code>stmt</code> rule by calling <code>parseStmt</code>. The <code>parseStmt</code> method parses its rule by asserting that there is an <code>IDENTIFIER</code> token followed by a <code>STRING_LIT</code> token (advancing the lexer after each token). A proper implementation would include error handling and reporting, but they&#39;re intentionally omitted here for simplicity.</p><p>To tell the <code>PsiBuilder</code> that a region of tokens should be converted into a node in the AST, we create a <em>marker</em> by calling <code>builder.mark()</code> at the beginning of the region, and then call <code>done</code> on the marker at the end of the region to convert it into a node. You&#39;ll see this being done in the <code>parseFile</code> and <code>parseStmt</code> methods, where a marker is set at the beginning of the rule, and then marked as <em>done</em> when the rule is successfully parsed. The <code>done</code> method takes the element type to be associated with the node, which is <code>NimElement.FILE</code> (the root element) for the file node, and <code>NimElement.STMT</code> for the statement node.</p><p>Needless to say, this parser will crash if the input doesn&#39;t exactly match the grammar rules. We&#39;ll improve it later to handle errors gracefully.</p><h2 id="parser-definition" tabindex="-1"><a class="header-anchor" href="#parser-definition"><span>Parser Definition</span></a></h2><p>Let&#39;s now create the <code>NimParserDefinition</code> class, which we will register as an extension to the <code>com.intellij.lang.parserDefinition</code> extension point. This class provides the IDE with the necessary methods to create the lexer, parser, and a few other things:</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt" data-title="kt"><pre><code><span class="line"><span class="token comment">// src/main/kotlin/khaledh/nimjet/NimParserDefinition.kt</span></span>
<span class="line"><span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> NimParserDefinition <span class="token operator">:</span> ParserDefinition <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">createLexer</span><span class="token punctuation">(</span>project<span class="token operator">:</span> Project<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Lexer <span class="token operator">=</span> <span class="token function">NimLexerAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">createParser</span><span class="token punctuation">(</span>project<span class="token operator">:</span> Project<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> PsiParser <span class="token operator">=</span> <span class="token function">NimParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// AST</span></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getFileNodeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> IFileElementType <span class="token operator">=</span> NimElement<span class="token punctuation">.</span>FILE</span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getWhitespaceTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> TokenSet <span class="token operator">=</span> TokenSet<span class="token punctuation">.</span>WHITE_SPACE</span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getCommentTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> TokenSet <span class="token operator">=</span> TokenSet<span class="token punctuation">.</span>EMPTY</span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getStringLiteralElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> TokenSet <span class="token operator">=</span> TokenSet<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>NimToken<span class="token punctuation">.</span>STRING_LIT<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// PSI</span></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">createFile</span><span class="token punctuation">(</span>viewProvider<span class="token operator">:</span> FileViewProvider<span class="token punctuation">)</span><span class="token operator">:</span> PsiFile <span class="token operator">=</span> <span class="token function">NimFile</span><span class="token punctuation">(</span>viewProvider<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">createElement</span><span class="token punctuation">(</span>node<span class="token operator">:</span> ASTNode<span class="token punctuation">)</span><span class="token operator">:</span> PsiElement <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>elementType<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            STMT <span class="token operator">-&gt;</span> <span class="token function">NimStmt</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token keyword">throw</span> <span class="token function">AssertionError</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Unknown element type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">node<span class="token punctuation">.</span>elementType</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Most of the methods should be self-explanatory. The last method, <code>createElement</code>, is responsible for creating the appropriate PSI element for a given AST node. In our case, we only have one type of element, <code>STMT</code>, so we create a <code>NimStmt</code> instance for that element type, and throw an error if we encounter an unknown element type (for now).</p><p>Finally, we need to register the <code>NimParserDefinition</code> class in the <code>plugin.xml</code> file:</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token comment">&lt;!-- src/main/resources/META-INF/plugin.xml --&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>idea-plugin</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    ...</span>
<span class="line"></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extensions</span> <span class="token attr-name">defaultExtensionNs</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.intellij<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        ...</span>
<span class="line"></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lang.parserDefinition</span></span>
<span class="line">            <span class="token attr-name">language</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Nim<span class="token punctuation">&quot;</span></span></span>
<span class="line">            <span class="token attr-name">implementationClass</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>khaledh.nimjet.NimParserDefinition<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span></span>
<span class="line"></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extensions</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>idea-plugin</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This completes the implementation of the parser. We can now test it by running the plugin and inspecting the PSI tree using the built-in PSI viewer.</p><h2 id="testing-the-parser" tabindex="-1"><a class="header-anchor" href="#testing-the-parser"><span>Testing the Parser</span></a></h2><p>Let&#39;s run the <code>Run Plugin</code> gradle task to start the IDE with our plugin. Once the IDE starts, create a new file with the following content:</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line">echo <span class="token string">&quot;hello, world!&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Now, open the PSI viewer from the <strong>Tools | View PSI Structure of Current File</strong> menu.</p><p><img src="/assets/psi-tree-BfzXRRWs.png" alt="PSI Tree"></p><p>Great! We can see the PSI tree with the <code>NimFile</code> and <code>NimStmt</code> nodes, in addition to the <code>IDENTIFIER</code> and <code>STRING_LIT</code> tokens under the <code>NimStmt</code> node. Our simple parser is working as expected.</p><h2 id="error-handling" tabindex="-1"><a class="header-anchor" href="#error-handling"><span>Error Handling</span></a></h2><p>Let&#39;s add error handling to our parser to make it more robust. We&#39;ll change the parser to detect and recover from errors, and report them to the user. We&#39;ll make each parsing method return a boolean indicating whether the rule was successfully parsed. If a rule fails, we&#39;ll mark the region as <em>error</em> and return early. Since returning early means that not all tokens are consumed, we need to advance the lexer to the end of the token stream to ensure that the PSI tree is properly built (this is a requirement of the <code>PsiBuilder</code>).</p><p>Here&#39;s the updated parser:</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt" data-title="kt"><pre><code><span class="line"><span class="token comment">// src/main/kotlin/khaledh/nimjet/NimParser.kt</span></span>
<span class="line"><span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> NimParser <span class="token operator">:</span> PsiParser  <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// Grammar:</span></span>
<span class="line">    <span class="token comment">//   file ::= stmt</span></span>
<span class="line">    <span class="token comment">//   stmt ::= IDENTIFIER STRING_LIT</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">parse</span><span class="token punctuation">(</span>root<span class="token operator">:</span> IElementType<span class="token punctuation">,</span> builder<span class="token operator">:</span> PsiBuilder<span class="token punctuation">)</span><span class="token operator">:</span> ASTNode <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">parseFile</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> builder<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> builder<span class="token punctuation">.</span>treeBuilt</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">parseFile</span><span class="token punctuation">(</span>root<span class="token operator">:</span> IElementType<span class="token punctuation">,</span> builder<span class="token operator">:</span> PsiBuilder<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">var</span> marker <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>builder<span class="token punctuation">.</span><span class="token function">eof</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">parseStmt</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// consume any remaining tokens (in case of error)</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>builder<span class="token punctuation">.</span><span class="token function">eof</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            builder<span class="token punctuation">.</span><span class="token function">advanceLexer</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        marker<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span>NimElement<span class="token punctuation">.</span>FILE<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">parseStmt</span><span class="token punctuation">(</span>builder<span class="token operator">:</span> PsiBuilder<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">var</span> marker <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>builder<span class="token punctuation">.</span>tokenType <span class="token operator">!=</span> NimToken<span class="token punctuation">.</span>IDENTIFIER<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">reportError</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;Expecting an identifier&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">            marker<span class="token punctuation">.</span><span class="token function">drop</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        builder<span class="token punctuation">.</span><span class="token function">advanceLexer</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>builder<span class="token punctuation">.</span>tokenType <span class="token operator">!=</span> NimToken<span class="token punctuation">.</span>STRING_LIT<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">reportError</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;Expecting a string literal&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">            marker<span class="token punctuation">.</span><span class="token function">drop</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        builder<span class="token punctuation">.</span><span class="token function">advanceLexer</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        marker<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span>NimElement<span class="token punctuation">.</span>STMT<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">reportError</span><span class="token punctuation">(</span>builder<span class="token operator">:</span> PsiBuilder<span class="token punctuation">,</span> message<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">var</span> marker <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        builder<span class="token punctuation">.</span><span class="token function">advanceLexer</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        marker<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We added a check for the end of the token stream in the <code>parseFile</code> method to ensure that we don&#39;t try to parse an empty file. The <code>reportError</code> method is used to mark the region as an error and report the error message to the user. If a rule fails, we drop the marker and return <code>false</code> to indicate that the rule was not successfully parsed.</p><p>Let&#39;s run the plugin again and test the error handling by creating a file with the contents <code>echo hello</code> (missing the string quotation marks).</p><p style="text-align:center;"><img src="/assets/psi-error-C3vs59-e.png" alt="PSI Error Reporting" width="550"></p><p>And it works! The token <code>hello</code> is marked as an error with a red squiggly line, and our error message is displayed when we hover over the token.</p><p>OK, we now have a good understanding of how to implement a parser by hand. In the next section, we will look at how to generate a parser using Grammar-Kit by defining the grammar in a BNF-like format. This will allow us to focus on the language grammar rules without worrying about the details of the lexer and parser implementation.</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/nimjet/05-parser" aria-label="Parser"><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span>Parser</span></div></a><a class="route-link auto-link next" href="/nimjet/07-grammarkit" aria-label="Grammar-Kit"><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span>Grammar-Kit</span></div></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BEnvQN0t.js" defer></script>
  </body>
</html>
