<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.15" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #22272e;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>Loading the Kernel (Part 2) | Khaled Hammouda</title><meta name="description" content="Building a 64-bit operating system from scratch in Nim">
    <link rel="preload" href="/assets/style-DFReAQZD.css" as="style"><link rel="stylesheet" href="/assets/style-DFReAQZD.css">
    <link rel="modulepreload" href="/assets/app-BEnvQN0t.js"><link rel="modulepreload" href="/assets/09-loading-the-kernel-p2.html-Bsyq9hJE.js">
    <link rel="prefetch" href="/assets/index.html-DN4baEjd.js" as="script"><link rel="prefetch" href="/assets/index.html-DTcVMSat.js" as="script"><link rel="prefetch" href="/assets/01-mm.html-DdVm3GHI.js" as="script"><link rel="prefetch" href="/assets/index.html-D8_cVHQe.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-Bq4FSDwn.js" as="script"><link rel="prefetch" href="/assets/02-setup.html-9f0UzP9I.js" as="script"><link rel="prefetch" href="/assets/03-filetype.html-DVtyN252.js" as="script"><link rel="prefetch" href="/assets/04-lexer.html-OooGwppm.js" as="script"><link rel="prefetch" href="/assets/05-parser.html-Dw5HPOU5.js" as="script"><link rel="prefetch" href="/assets/06-parser-p2.html-CHLJtldD.js" as="script"><link rel="prefetch" href="/assets/07-grammarkit.html-DALOmYeT.js" as="script"><link rel="prefetch" href="/assets/08-go-to-decl.html-DPftLCwO.js" as="script"><link rel="prefetch" href="/assets/09-scopes.html-BhA3Jfl5.js" as="script"><link rel="prefetch" href="/assets/10-rename-refactoring.html-CQ7xy6Op.js" as="script"><link rel="prefetch" href="/assets/11-indentation.html-BSbVKVoe.js" as="script"><link rel="prefetch" href="/assets/12-decl-sections.html-DM3D0T_j.js" as="script"><link rel="prefetch" href="/assets/13-comments.html-PACjUQ8Q.js" as="script"><link rel="prefetch" href="/assets/14-numeric-lit.html-Bx-wwqk6.js" as="script"><link rel="prefetch" href="/assets/15-expressions.html-26eNyM4d.js" as="script"><link rel="prefetch" href="/assets/99-tmp.html-gvMZWEF9.js" as="script"><link rel="prefetch" href="/assets/index.html-J4FG-UC7.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-BeNfzmF-.js" as="script"><link rel="prefetch" href="/assets/02-environment-setup.html-C8XAFCUU.js" as="script"><link rel="prefetch" href="/assets/03-targeting-uefi-p1.html-C9weobAl.js" as="script"><link rel="prefetch" href="/assets/04-targeting-uefi-p2.html-DtpCSkF_.js" as="script"><link rel="prefetch" href="/assets/05-bootloader-p1.html-nF5TI7gq.js" as="script"><link rel="prefetch" href="/assets/06-bootloader-p2.html-lTW7xvyF.js" as="script"><link rel="prefetch" href="/assets/07-kernel-image.html-Dbec7FcX.js" as="script"><link rel="prefetch" href="/assets/08-loading-the-kernel-p1.html-CgEWrWCh.js" as="script"><link rel="prefetch" href="/assets/10-loading-the-kernel-p3.html-Cz6f791z.js" as="script"><link rel="prefetch" href="/assets/11-physical-memory.html-Iko_lfyH.js" as="script"><link rel="prefetch" href="/assets/12-virtual-memory.html-BdHdqaeH.js" as="script"><link rel="prefetch" href="/assets/13-higher-half-kernel.html-U7sLCIG_.js" as="script"><link rel="prefetch" href="/assets/14-memory-segments.html-C0Wfonfg.js" as="script"><link rel="prefetch" href="/assets/15-interrupts.html-CuXOHXlP.js" as="script"><link rel="prefetch" href="/assets/16-user-mode.html-DI-QEaJn.js" as="script"><link rel="prefetch" href="/assets/17-tss.html-DedksTv0.js" as="script"><link rel="prefetch" href="/assets/18-system-calls.html-CANG8AhC.js" as="script"><link rel="prefetch" href="/assets/19-tasks.html-D_KA9R1n.js" as="script"><link rel="prefetch" href="/assets/20-position-independent-code.html-DcxhRHAD.js" as="script"><link rel="prefetch" href="/assets/21-elf-loader-p1.html-hRqOVejE.js" as="script"><link rel="prefetch" href="/assets/22-elf-loader-p2.html-CwKLac9X.js" as="script"><link rel="prefetch" href="/assets/23-coop-multitasking.html-CmjVNMNt.js" as="script"><link rel="prefetch" href="/assets/24-system-library.html-Chl8ifRh.js" as="script"><link rel="prefetch" href="/assets/25-interrupt-controller.html-i_QNpPOS.js" as="script"><link rel="prefetch" href="/assets/index.html--jTsfqNO.js" as="script"><link rel="prefetch" href="/assets/404.html-CYnd4SKg.js" as="script"><link rel="prefetch" href="/assets/SearchResult-ZUCfC4Sv.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">Khaled Hammouda</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading active" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a><ul class="vp-sidebar-children" style=""><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/01-intro" aria-label="Writing an OS in Nim"><!---->Writing an OS in Nim<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/02-environment-setup" aria-label="Environment Setup"><!---->Environment Setup<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/03-targeting-uefi-p1" aria-label="Targeting UEFI (Part 1)"><!---->Targeting UEFI (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/04-targeting-uefi-p2" aria-label="Targeting UEFI (Part 2)"><!---->Targeting UEFI (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/05-bootloader-p1" aria-label="UEFI Bootloader (Part 1)"><!---->UEFI Bootloader (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/06-bootloader-p2" aria-label="UEFI Bootloader (Part 2)"><!---->UEFI Bootloader (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/07-kernel-image" aria-label="Kernel Image"><!---->Kernel Image<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/08-loading-the-kernel-p1" aria-label="Loading the Kernel (Part 1)"><!---->Loading the Kernel (Part 1)<!----></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/osdev/09-loading-the-kernel-p2" aria-label="Loading the Kernel (Part 2)"><!---->Loading the Kernel (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/10-loading-the-kernel-p3" aria-label="Loading the Kernel (Part 3)"><!---->Loading the Kernel (Part 3)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/11-physical-memory" aria-label="Physical Memory"><!---->Physical Memory<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/12-virtual-memory" aria-label="Virtual Memory"><!---->Virtual Memory<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/13-higher-half-kernel" aria-label="Higher Half Kernel"><!---->Higher Half Kernel<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/14-memory-segments" aria-label="Memory Segments"><!---->Memory Segments<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/15-interrupts" aria-label="Interrupts"><!---->Interrupts<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/16-user-mode" aria-label="User Mode"><!---->User Mode<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/17-tss" aria-label="Task State Segment"><!---->Task State Segment<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/18-system-calls" aria-label="System Calls"><!---->System Calls<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/19-tasks" aria-label="Tasks"><!---->Tasks<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/20-position-independent-code" aria-label="Position Independent Code"><!---->Position Independent Code<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/21-elf-loader-p1" aria-label="ELF Loader (Part 1)"><!---->ELF Loader (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/22-elf-loader-p2" aria-label="ELF Loader (Part 2)"><!---->ELF Loader (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/23-coop-multitasking" aria-label="Cooperative Multitasking"><!---->Cooperative Multitasking<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/24-system-library" aria-label="System Library"><!---->System Library<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/25-interrupt-controller" aria-label="Interrupt Controller"><!---->Interrupt Controller<!----></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="loading-the-kernel-part-2" tabindex="-1"><a class="header-anchor" href="#loading-the-kernel-part-2"><span>Loading the Kernel (Part 2)</span></a></h1><p>In the previous section, we located the kernel image and determined its size. In this section, we&#39;ll continue with our plan. We&#39;ll allocate memory for the kernel image, read it into memory, exit the Boot Services, and jump to the kernel image.</p><h2 id="allocate-memory" tabindex="-1"><a class="header-anchor" href="#allocate-memory"><span>Allocate memory</span></a></h2><p>We&#39;ll use the Boot Services <code>AllocatePages</code> function to allocate enough pages, starting at address <code>0x100000</code> (1 MiB), to hold the kernel image. We&#39;ll also allocate a region of memory for the kernel stack. Let&#39;s define the <code>AllocatePages</code> function, which also requires defining the <code>EfiAllocateType</code> and <code>EfiPhysicalAddress</code> types.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/common/uefi.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  EfiBootServices<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    <span class="token operator">...</span></span>
<span class="line highlighted">    allocatePages<span class="token operator">*:</span> <span class="token function">proc</span> <span class="token punctuation">(</span></span>
<span class="line highlighted">        allocateType<span class="token operator">:</span> EfiAllocateType<span class="token punctuation">,</span></span>
<span class="line highlighted">        memoryType<span class="token operator">:</span> EfiMemoryType<span class="token punctuation">,</span></span>
<span class="line highlighted">        pages<span class="token operator">:</span> uint<span class="token punctuation">,</span></span>
<span class="line highlighted">        memory<span class="token operator">:</span> <span class="token keyword">ptr</span> EfiPhysicalAddress</span>
<span class="line highlighted">      <span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token punctuation">{.</span>cdecl<span class="token punctuation">.}</span></span>
<span class="line">    <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line highlighted">  EfiAllocateType<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">enum</span></span>
<span class="line highlighted">    AllocateAnyPages<span class="token punctuation">,</span></span>
<span class="line highlighted">    AllocateMaxAddress<span class="token punctuation">,</span></span>
<span class="line highlighted">    AllocateAddress<span class="token punctuation">,</span></span>
<span class="line highlighted">    MaxAllocateType</span>
<span class="line highlighted"></span>
<span class="line highlighted">  EfiPhysicalAddress<span class="token operator">*</span> <span class="token operator">=</span> uint64</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The <code>EfiAllocateType</code> enum is used to specify the type of allocation. We&#39;ll use <code>AllocateAddress</code> to allocate pages for the kernel image, starting at a specific address (in our case, <code>0x100000</code>). The <code>EfiMemoryType</code> enum is used to specify the type of memory to allocate, which we&#39;ll set to <code>OsvKernelCode</code>. For the kernel stack, we&#39;ll use <code>AllocateAnyPages</code> to allocate any pages, and set the memory type to <code>OsvKernelStack</code>.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/boot/bootx64.nim</span></span>
<span class="line"></span>
<span class="line highlighted"><span class="token keyword">const</span></span>
<span class="line highlighted">  PageSize <span class="token operator">=</span> <span class="token number">4096</span></span>
<span class="line highlighted">  KernelPhysicalBase <span class="token operator">=</span> <span class="token number">0x100000</span></span>
<span class="line highlighted">  KernelStackSize <span class="token operator">=</span> <span class="token number">128</span> <span class="token operator">*</span> <span class="token number">1024&#39;u64</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">EfiMainInner</span><span class="token punctuation">(</span>imgHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> sysTable<span class="token operator">:</span> <span class="token keyword">ptr</span> EFiSystemTable<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line highlighted">  consoleOut <span class="token operator">&amp;</span><span class="token string">&quot;boot: Allocating memory for kernel image &quot;</span></span>
<span class="line highlighted">  <span class="token keyword">let</span> kernelImageBase <span class="token operator">=</span> <span class="token function">cast[pointer]</span><span class="token punctuation">(</span>KernelPhysicalBase<span class="token punctuation">)</span></span>
<span class="line highlighted">  <span class="token keyword">let</span> kernelImagePages <span class="token operator">=</span> <span class="token punctuation">(</span>kernelInfo<span class="token operator">.</span>fileSize <span class="token operator">+</span> <span class="token number">0xFFF</span><span class="token punctuation">)</span><span class="token operator">.</span>uint <span class="token operator">div</span> PageSize<span class="token operator">.</span>uint <span class="token comment"># round up to nearest page</span></span>
<span class="line highlighted">  checkStatus uefi<span class="token operator">.</span>sysTable<span class="token operator">.</span>bootServices<span class="token operator">.</span><span class="token function">allocatePages</span><span class="token punctuation">(</span></span>
<span class="line highlighted">    AllocateAddress<span class="token punctuation">,</span></span>
<span class="line highlighted">    OsvKernelCode<span class="token punctuation">,</span></span>
<span class="line highlighted">    kernelImagePages<span class="token punctuation">,</span></span>
<span class="line highlighted">    <span class="token function">cast[ptr EfiPhysicalAddress]</span><span class="token punctuation">(</span><span class="token keyword">addr</span> kernelImageBase<span class="token punctuation">)</span></span>
<span class="line highlighted">  <span class="token punctuation">)</span></span>
<span class="line highlighted"></span>
<span class="line highlighted">  consoleOut <span class="token operator">&amp;</span><span class="token string">&quot;boot: Allocating memory for kernel stack (16 KiB) &quot;</span></span>
<span class="line highlighted">  <span class="token keyword">var</span> kernelStackBase<span class="token operator">:</span> uint64</span>
<span class="line highlighted">  <span class="token keyword">let</span> kernelStackPages <span class="token operator">=</span> KernelStackSize <span class="token operator">div</span> PageSize</span>
<span class="line highlighted">  checkStatus uefi<span class="token operator">.</span>sysTable<span class="token operator">.</span>bootServices<span class="token operator">.</span><span class="token function">allocatePages</span><span class="token punctuation">(</span></span>
<span class="line highlighted">    AllocateAnyPages<span class="token punctuation">,</span></span>
<span class="line highlighted">    OsvKernelStack<span class="token punctuation">,</span></span>
<span class="line highlighted">    kernelStackPages<span class="token punctuation">,</span></span>
<span class="line highlighted">    kernelStackBase<span class="token operator">.</span><span class="token keyword">addr</span><span class="token punctuation">,</span></span>
<span class="line highlighted">  <span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="read-kernel-image" tabindex="-1"><a class="header-anchor" href="#read-kernel-image"><span>Read kernel image</span></a></h2><p>The next step is to use the <code>read</code> function of the <code>EfiFileProtocol</code> to read the kernel image into memory. Let&#39;s define the <code>read</code> function.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/common/uefi.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  EfiFileProtocol<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    <span class="token operator">...</span></span>
<span class="line highlighted">    read<span class="token operator">*:</span> <span class="token function">proc</span> <span class="token punctuation">(</span></span>
<span class="line highlighted">        this<span class="token operator">:</span> <span class="token keyword">ptr</span> EfiFileProtocol<span class="token punctuation">,</span></span>
<span class="line highlighted">        bufferSize<span class="token operator">:</span> <span class="token keyword">ptr</span> uint<span class="token punctuation">,</span></span>
<span class="line highlighted">        buffer<span class="token operator">:</span> pointer</span>
<span class="line highlighted">      <span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token punctuation">{.</span>cdecl<span class="token punctuation">.}</span></span>
<span class="line highlighted">  <span class="token operator">...</span></span>
<span class="line highlighted"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We&#39;ll use the <code>read</code> function to read the kernel image into the memory we allocated earlier.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/boot/bootx64.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">EfiMainInner</span><span class="token punctuation">(</span>imgHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> sysTable<span class="token operator">:</span> <span class="token keyword">ptr</span> EFiSystemTable<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line highlighted">  <span class="token comment"># read the kernel into memory</span></span>
<span class="line highlighted">  consoleOut <span class="token string">&quot;boot: Reading kernel into memory&quot;</span></span>
<span class="line highlighted">  checkStatus kernelFile<span class="token operator">.</span><span class="token function">read</span><span class="token punctuation">(</span>kernelFile<span class="token punctuation">,</span> <span class="token function">cast[ptr uint]</span><span class="token punctuation">(</span><span class="token keyword">addr</span> kernelInfo<span class="token operator">.</span>fileSize<span class="token punctuation">)</span><span class="token punctuation">,</span> kernelImageBase<span class="token punctuation">)</span></span>
<span class="line highlighted"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="close-open-files" tabindex="-1"><a class="header-anchor" href="#close-open-files"><span>Close open files</span></a></h2><p>We&#39;re done with the kernel file and the root directory, so we can close them. It&#39;s not strictly needed, but I got in the habit of closing resources when I&#39;m done with them. Let&#39;s define the <code>close</code> function of the <code>EfiFileProtocol</code>.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/common/uefi.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  EfiFileProtocol<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    <span class="token operator">...</span></span>
<span class="line highlighted">    close<span class="token operator">*:</span> <span class="token function">proc</span> <span class="token punctuation">(</span>this<span class="token operator">:</span> <span class="token keyword">ptr</span> EfiFileProtocol<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token punctuation">{.</span>cdecl<span class="token punctuation">.}</span></span>
<span class="line">    <span class="token operator">...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/boot/bootx64.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">EfiMainInner</span><span class="token punctuation">(</span>imgHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> sysTable<span class="token operator">:</span> <span class="token keyword">ptr</span> EFiSystemTable<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line highlighted">  <span class="token comment"># close the kernel file</span></span>
<span class="line highlighted">  consoleOut <span class="token string">&quot;boot: Closing kernel file&quot;</span></span>
<span class="line highlighted">  checkStatus kernelFile<span class="token operator">.</span><span class="token function">close</span><span class="token punctuation">(</span>kernelFile<span class="token punctuation">)</span></span>
<span class="line highlighted"></span>
<span class="line highlighted">  <span class="token comment"># close the root directory</span></span>
<span class="line highlighted">  consoleOut <span class="token string">&quot;boot: Closing root directory&quot;</span></span>
<span class="line highlighted">  checkStatus rootDir<span class="token operator">.</span><span class="token function">close</span><span class="token punctuation">(</span>rootDir<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="/assets/boot-closefiles-CE9W-vXS.png" alt="Boot - Close files"></p><h2 id="get-memory-map" tabindex="-1"><a class="header-anchor" href="#get-memory-map"><span>Get memory map</span></a></h2><p>In order to get the memory map, we have to allocate memory for the map itself. But how do we know how much memory to allocate? Calling <code>getMemoryMap</code> with a buffer size of <code>0</code> will return the required buffer size in the <code>memoryMapSize</code> output parameter. We can then allocate the required memory and call <code>getMemoryMap</code> again to get the actual memory map.</p><p>Let&#39;s define the <code>getMemoryMap</code> function first (and the associated <code>EfiMemoryDescriptor</code> and <code>EfiVirtualAddress</code> types). We&#39;ll also define the <code>allocatePool</code> function of the <code>EfiBootServices</code> type, which we&#39;ll use to allocate the memory for the memory map. (The difference between <code>allocatePages</code> and <code>allocatePool</code> is that <code>allocatePages</code> allocates memory in page-sized chunks, whereas <code>allocatePool</code> allocates memory in byte-sized chunks. <code>allocatePool</code> also provides more control over the address of the allocated memory, which is why we used it to allocate memory for the kernel.)</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/common/uefi.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  EfiBootServices<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    <span class="token operator">...</span></span>
<span class="line highlighted">    getMemoryMap<span class="token operator">*:</span> <span class="token function">proc</span> <span class="token punctuation">(</span></span>
<span class="line highlighted">        memoryMapSize<span class="token operator">:</span> <span class="token keyword">ptr</span> uint<span class="token punctuation">,</span></span>
<span class="line highlighted">        memoryMap<span class="token operator">:</span> <span class="token keyword">ptr</span> EfiMemoryDescriptor<span class="token punctuation">,</span></span>
<span class="line highlighted">        mapKey<span class="token operator">:</span> <span class="token keyword">ptr</span> uint<span class="token punctuation">,</span></span>
<span class="line highlighted">        descriptorSize<span class="token operator">:</span> <span class="token keyword">ptr</span> uint<span class="token punctuation">,</span></span>
<span class="line highlighted">        descriptorVersion<span class="token operator">:</span> <span class="token keyword">ptr</span> uint32</span>
<span class="line highlighted">      <span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token punctuation">{.</span>cdecl<span class="token punctuation">.}</span></span>
<span class="line highlighted">    allocatePool<span class="token operator">*:</span> <span class="token function">proc</span> <span class="token punctuation">(</span></span>
<span class="line highlighted">        poolType<span class="token operator">:</span> EfiMemoryType<span class="token punctuation">,</span></span>
<span class="line highlighted">        size<span class="token operator">:</span> uint<span class="token punctuation">,</span></span>
<span class="line highlighted">        buffer<span class="token operator">:</span> <span class="token keyword">ptr</span> pointer</span>
<span class="line highlighted">      <span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token punctuation">{.</span>cdecl<span class="token punctuation">.}</span></span>
<span class="line">    <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line highlighted">  EfiMemoryDescriptor<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line highlighted">    <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token operator">*:</span> EfiMemoryType</span>
<span class="line highlighted">    physicalStart<span class="token operator">*:</span> EfiPhysicalAddress</span>
<span class="line highlighted">    virtualStart<span class="token operator">*:</span> EfiVirtualAddress</span>
<span class="line highlighted">    numberOfPages<span class="token operator">*:</span> uint64</span>
<span class="line highlighted">    attribute<span class="token operator">*:</span> uint64</span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line">  EfiPhysicalAddress<span class="token operator">*</span> <span class="token operator">=</span> uint64</span>
<span class="line highlighted">  EfiVirtualAddress<span class="token operator">*</span> <span class="token operator">=</span> uint64</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now we&#39;re ready to get the memory map.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/boot/bootx64.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">EfiMainInner</span><span class="token punctuation">(</span>imgHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> sysTable<span class="token operator">:</span> <span class="token keyword">ptr</span> EFiSystemTable<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line highlighted">  <span class="token comment"># memory map</span></span>
<span class="line highlighted">  <span class="token keyword">var</span> memoryMapSize <span class="token operator">=</span> <span class="token number">0.u</span>int</span>
<span class="line highlighted">  <span class="token keyword">var</span> memoryMap<span class="token operator">:</span> <span class="token keyword">ptr</span> UncheckedArray<span class="token punctuation">[</span>EfiMemoryDescriptor<span class="token punctuation">]</span></span>
<span class="line highlighted">  <span class="token keyword">var</span> memoryMapKey<span class="token operator">:</span> uint</span>
<span class="line highlighted">  <span class="token keyword">var</span> memoryMapDescriptorSize<span class="token operator">:</span> uint</span>
<span class="line highlighted">  <span class="token keyword">var</span> memoryMapDescriptorVersion<span class="token operator">:</span> uint32</span>
<span class="line highlighted"></span>
<span class="line highlighted">  <span class="token comment"># get memory map size</span></span>
<span class="line highlighted">  status <span class="token operator">=</span> uefi<span class="token operator">.</span>sysTable<span class="token operator">.</span>bootServices<span class="token operator">.</span><span class="token function">getMemoryMap</span><span class="token punctuation">(</span></span>
<span class="line highlighted">    <span class="token keyword">addr</span> memoryMapSize<span class="token punctuation">,</span></span>
<span class="line highlighted">    <span class="token function">cast[ptr EfiMemoryDescriptor]</span><span class="token punctuation">(</span><span class="token keyword">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line highlighted">    <span class="token function">cast[ptr uint]</span><span class="token punctuation">(</span><span class="token keyword">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line highlighted">    <span class="token function">cast[ptr uint]</span><span class="token punctuation">(</span><span class="token keyword">addr</span> memoryMapDescriptorSize<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line highlighted">    <span class="token function">cast[ptr uint32]</span><span class="token punctuation">(</span><span class="token keyword">nil</span><span class="token punctuation">)</span></span>
<span class="line highlighted">  <span class="token punctuation">)</span></span>
<span class="line highlighted">  <span class="token comment"># increase memory map size to account for the next call to allocatePool</span></span>
<span class="line highlighted">  inc memoryMapSize<span class="token punctuation">,</span> memoryMapDescriptorSize</span>
<span class="line highlighted"></span>
<span class="line highlighted">  <span class="token comment"># allocate pool for memory map (this changes the memory map size, hence the previous step)</span></span>
<span class="line highlighted">  consoleOut <span class="token string">&quot;boot: Allocating pool for memory map&quot;</span></span>
<span class="line highlighted">  checkStatus uefi<span class="token operator">.</span>sysTable<span class="token operator">.</span>bootServices<span class="token operator">.</span><span class="token function">allocatePool</span><span class="token punctuation">(</span></span>
<span class="line highlighted">    EfiLoaderData<span class="token punctuation">,</span> memoryMapSize<span class="token punctuation">,</span> <span class="token function">cast[ptr pointer]</span><span class="token punctuation">(</span><span class="token keyword">addr</span> memoryMap<span class="token punctuation">)</span></span>
<span class="line highlighted">  <span class="token punctuation">)</span></span>
<span class="line highlighted"></span>
<span class="line highlighted">  <span class="token comment"># now get the memory map</span></span>
<span class="line highlighted">  consoleOut <span class="token string">&quot;boot: Getting memory map&quot;</span></span>
<span class="line highlighted">  checkStatus uefi<span class="token operator">.</span>sysTable<span class="token operator">.</span>bootServices<span class="token operator">.</span><span class="token function">getMemoryMap</span><span class="token punctuation">(</span></span>
<span class="line highlighted">    <span class="token keyword">addr</span> memoryMapSize<span class="token punctuation">,</span></span>
<span class="line highlighted">    <span class="token function">cast[ptr EfiMemoryDescriptor]</span><span class="token punctuation">(</span>memoryMap<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line highlighted">    <span class="token keyword">addr</span> memoryMapKey<span class="token punctuation">,</span></span>
<span class="line highlighted">    <span class="token keyword">addr</span> memoryMapDescriptorSize<span class="token punctuation">,</span></span>
<span class="line highlighted">    <span class="token keyword">addr</span> memoryMapDescriptorVersion</span>
<span class="line highlighted">  <span class="token punctuation">)</span></span>
<span class="line highlighted"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="/assets/boot-getmemorymap-DN4ymQIU.png" alt="Boot - Get memory map"></p><h2 id="exit-boot-services" tabindex="-1"><a class="header-anchor" href="#exit-boot-services"><span>Exit boot services</span></a></h2><p>We have all the information we need to exit the Boot Services. Let&#39;s define the <code>exitBootServices</code> function.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/common/uefi.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  EfiBootServices<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    <span class="token operator">...</span></span>
<span class="line">    exitBootServices<span class="token operator">*:</span> <span class="token function">proc</span> <span class="token punctuation">(</span></span>
<span class="line">        imageHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span></span>
<span class="line">        mapKey<span class="token operator">:</span> uint</span>
<span class="line">      <span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token punctuation">{.</span>cdecl<span class="token punctuation">.}</span></span>
<span class="line">    <span class="token operator">...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The call to <code>exitBootServices</code> requires passing the <code>mapKey</code> that we got from <code>getMemoryMap</code>. This ensures that the memory map hasn&#39;t changed since we got it, otherwise the call will fail.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/boot/bootx64.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">EfiMainInner</span><span class="token punctuation">(</span>imgHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> sysTable<span class="token operator">:</span> <span class="token keyword">ptr</span> EFiSystemTable<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># exit boot services</span></span>
<span class="line">  consoleOut <span class="token string">&quot;boot: Exiting boot services&quot;</span></span>
<span class="line">  checkStatus uefi<span class="token operator">.</span>sysTable<span class="token operator">.</span>bootServices<span class="token operator">.</span><span class="token function">exitBootServices</span><span class="token punctuation">(</span>imgHandle<span class="token punctuation">,</span> memoryMapKey<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>If we compile and run now, we are faced with the following error:</p><p><img src="/assets/boot-exitbootserviceserror-DZhz2qY6.png" alt="Boot - Exit boot services error"></p><p>Status code 2 is <code>EfiInvalidParameter</code>, which means that the <code>mapKey</code> we passed to <code>exitBootServices</code> is invalid. How can the <code>mapKey</code> be invalid if we just got it from <code>getMemoryMap</code>? This took me a while to figure out, but it turns out that merely printing to the console (or any other boot service call) may allocate memory, which changes the memory map. So basically we have to call <code>exitBootServices</code> immediately after getting the memory map, without calling any other boot service function in between. So, unfortunately, we&#39;ll have to give up printing to the console from that point on, until we transfer control to the kernel.</p><p>Let&#39;s change the call to <code>checkStatus</code> to avoid printing to the console (we&#39;ll only print to the console in case of an error).</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/boot/bootx64.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">EfiMainInner</span><span class="token punctuation">(</span>imgHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> sysTable<span class="token operator">:</span> <span class="token keyword">ptr</span> EFiSystemTable<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># get memory map</span></span>
<span class="line">  echo <span class="token string">&quot;boot: Getting memory map and exiting boot services&quot;</span></span>
<span class="line highlighted">  status <span class="token operator">=</span> uefi<span class="token operator">.</span>sysTable<span class="token operator">.</span>bootServices<span class="token operator">.</span><span class="token function">getMemoryMap</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token keyword">addr</span> memoryMapSize<span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">cast[ptr EfiMemoryDescriptor]</span><span class="token punctuation">(</span>memoryMap<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">addr</span> memoryMapKey<span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">addr</span> memoryMapDescriptorSize<span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">addr</span> memoryMapDescriptorVersion</span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line highlighted"></span>
<span class="line highlighted">  <span class="token comment"># IMPORTANT: After this point we cannot output anything to the console, since doing</span></span>
<span class="line highlighted">  <span class="token comment"># so may allocate memory and change the memory map, invalidating our map key. We can</span></span>
<span class="line highlighted">  <span class="token comment"># only output to the console in case of an error (since we quit anyway).</span></span>
<span class="line highlighted"></span>
<span class="line highlighted">  <span class="token keyword">if</span> status <span class="token operator">!=</span> EfiSuccess<span class="token operator">:</span></span>
<span class="line highlighted">    echo <span class="token operator">&amp;</span><span class="token string">&quot;boot: Failed to get memory map: {status:#x}&quot;</span></span>
<span class="line highlighted">    <span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line highlighted"></span>
<span class="line highlighted">  status <span class="token operator">=</span> uefi<span class="token operator">.</span>sysTable<span class="token operator">.</span>bootServices<span class="token operator">.</span><span class="token function">exitBootServices</span><span class="token punctuation">(</span>imgHandle<span class="token punctuation">,</span> memoryMapKey<span class="token punctuation">)</span></span>
<span class="line highlighted">  <span class="token keyword">if</span> status <span class="token operator">!=</span> EfiSuccess<span class="token operator">:</span></span>
<span class="line highlighted">    echo <span class="token operator">&amp;</span><span class="token string">&quot;boot: Failed to exit boot services: {status:#x}&quot;</span></span>
<span class="line highlighted">    <span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line highlighted"></span>
<span class="line highlighted">  <span class="token comment"># ======= NO MORE UEFI BOOT SERVICES =======</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This time the call to <code>exitBootServices</code> should succeed, but we won&#39;t see a <code>[success]</code> message in the console. We&#39;ll know that it succeeded if no error messages are printed.</p><p><img src="/assets/boot-exitbootservices-Dt2Rlx1o.png" alt="Boot - Exit boot services"></p><p>Great! We&#39;re done with the UEFI Boot Services. Now we&#39;re ready to jump to the kernel image. We&#39;ll do this in the next section.</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/osdev/08-loading-the-kernel-p1" aria-label="Loading the Kernel (Part 1)"><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span>Loading the Kernel (Part 1)</span></div></a><a class="route-link auto-link next" href="/osdev/10-loading-the-kernel-p3" aria-label="Loading the Kernel (Part 3)"><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span>Loading the Kernel (Part 3)</span></div></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BEnvQN0t.js" defer></script>
  </body>
</html>
