<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.15" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #22272e;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>Tasks | Khaled Hammouda</title><meta name="description" content="Building a 64-bit operating system from scratch in Nim">
    <link rel="preload" href="/assets/style-DFReAQZD.css" as="style"><link rel="stylesheet" href="/assets/style-DFReAQZD.css">
    <link rel="modulepreload" href="/assets/app-BEnvQN0t.js"><link rel="modulepreload" href="/assets/19-tasks.html-D_KA9R1n.js">
    <link rel="prefetch" href="/assets/index.html-DN4baEjd.js" as="script"><link rel="prefetch" href="/assets/index.html-DTcVMSat.js" as="script"><link rel="prefetch" href="/assets/01-mm.html-DdVm3GHI.js" as="script"><link rel="prefetch" href="/assets/index.html-D8_cVHQe.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-Bq4FSDwn.js" as="script"><link rel="prefetch" href="/assets/02-setup.html-9f0UzP9I.js" as="script"><link rel="prefetch" href="/assets/03-filetype.html-DVtyN252.js" as="script"><link rel="prefetch" href="/assets/04-lexer.html-OooGwppm.js" as="script"><link rel="prefetch" href="/assets/05-parser.html-Dw5HPOU5.js" as="script"><link rel="prefetch" href="/assets/06-parser-p2.html-CHLJtldD.js" as="script"><link rel="prefetch" href="/assets/07-grammarkit.html-DALOmYeT.js" as="script"><link rel="prefetch" href="/assets/08-go-to-decl.html-DPftLCwO.js" as="script"><link rel="prefetch" href="/assets/09-scopes.html-BhA3Jfl5.js" as="script"><link rel="prefetch" href="/assets/10-rename-refactoring.html-CQ7xy6Op.js" as="script"><link rel="prefetch" href="/assets/11-indentation.html-BSbVKVoe.js" as="script"><link rel="prefetch" href="/assets/12-decl-sections.html-DM3D0T_j.js" as="script"><link rel="prefetch" href="/assets/13-comments.html-PACjUQ8Q.js" as="script"><link rel="prefetch" href="/assets/14-numeric-lit.html-Bx-wwqk6.js" as="script"><link rel="prefetch" href="/assets/15-expressions.html-26eNyM4d.js" as="script"><link rel="prefetch" href="/assets/99-tmp.html-gvMZWEF9.js" as="script"><link rel="prefetch" href="/assets/index.html-J4FG-UC7.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-BeNfzmF-.js" as="script"><link rel="prefetch" href="/assets/02-environment-setup.html-C8XAFCUU.js" as="script"><link rel="prefetch" href="/assets/03-targeting-uefi-p1.html-C9weobAl.js" as="script"><link rel="prefetch" href="/assets/04-targeting-uefi-p2.html-DtpCSkF_.js" as="script"><link rel="prefetch" href="/assets/05-bootloader-p1.html-nF5TI7gq.js" as="script"><link rel="prefetch" href="/assets/06-bootloader-p2.html-lTW7xvyF.js" as="script"><link rel="prefetch" href="/assets/07-kernel-image.html-Dbec7FcX.js" as="script"><link rel="prefetch" href="/assets/08-loading-the-kernel-p1.html-CgEWrWCh.js" as="script"><link rel="prefetch" href="/assets/09-loading-the-kernel-p2.html-Bsyq9hJE.js" as="script"><link rel="prefetch" href="/assets/10-loading-the-kernel-p3.html-Cz6f791z.js" as="script"><link rel="prefetch" href="/assets/11-physical-memory.html-Iko_lfyH.js" as="script"><link rel="prefetch" href="/assets/12-virtual-memory.html-BdHdqaeH.js" as="script"><link rel="prefetch" href="/assets/13-higher-half-kernel.html-U7sLCIG_.js" as="script"><link rel="prefetch" href="/assets/14-memory-segments.html-C0Wfonfg.js" as="script"><link rel="prefetch" href="/assets/15-interrupts.html-CuXOHXlP.js" as="script"><link rel="prefetch" href="/assets/16-user-mode.html-DI-QEaJn.js" as="script"><link rel="prefetch" href="/assets/17-tss.html-DedksTv0.js" as="script"><link rel="prefetch" href="/assets/18-system-calls.html-CANG8AhC.js" as="script"><link rel="prefetch" href="/assets/20-position-independent-code.html-DcxhRHAD.js" as="script"><link rel="prefetch" href="/assets/21-elf-loader-p1.html-hRqOVejE.js" as="script"><link rel="prefetch" href="/assets/22-elf-loader-p2.html-CwKLac9X.js" as="script"><link rel="prefetch" href="/assets/23-coop-multitasking.html-CmjVNMNt.js" as="script"><link rel="prefetch" href="/assets/24-system-library.html-Chl8ifRh.js" as="script"><link rel="prefetch" href="/assets/25-interrupt-controller.html-i_QNpPOS.js" as="script"><link rel="prefetch" href="/assets/index.html--jTsfqNO.js" as="script"><link rel="prefetch" href="/assets/404.html-CYnd4SKg.js" as="script"><link rel="prefetch" href="/assets/SearchResult-ZUCfC4Sv.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">Khaled Hammouda</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading active" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a><ul class="vp-sidebar-children" style=""><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/01-intro" aria-label="Writing an OS in Nim"><!---->Writing an OS in Nim<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/02-environment-setup" aria-label="Environment Setup"><!---->Environment Setup<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/03-targeting-uefi-p1" aria-label="Targeting UEFI (Part 1)"><!---->Targeting UEFI (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/04-targeting-uefi-p2" aria-label="Targeting UEFI (Part 2)"><!---->Targeting UEFI (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/05-bootloader-p1" aria-label="UEFI Bootloader (Part 1)"><!---->UEFI Bootloader (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/06-bootloader-p2" aria-label="UEFI Bootloader (Part 2)"><!---->UEFI Bootloader (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/07-kernel-image" aria-label="Kernel Image"><!---->Kernel Image<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/08-loading-the-kernel-p1" aria-label="Loading the Kernel (Part 1)"><!---->Loading the Kernel (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/09-loading-the-kernel-p2" aria-label="Loading the Kernel (Part 2)"><!---->Loading the Kernel (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/10-loading-the-kernel-p3" aria-label="Loading the Kernel (Part 3)"><!---->Loading the Kernel (Part 3)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/11-physical-memory" aria-label="Physical Memory"><!---->Physical Memory<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/12-virtual-memory" aria-label="Virtual Memory"><!---->Virtual Memory<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/13-higher-half-kernel" aria-label="Higher Half Kernel"><!---->Higher Half Kernel<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/14-memory-segments" aria-label="Memory Segments"><!---->Memory Segments<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/15-interrupts" aria-label="Interrupts"><!---->Interrupts<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/16-user-mode" aria-label="User Mode"><!---->User Mode<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/17-tss" aria-label="Task State Segment"><!---->Task State Segment<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/18-system-calls" aria-label="System Calls"><!---->System Calls<!----></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/osdev/19-tasks" aria-label="Tasks"><!---->Tasks<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/20-position-independent-code" aria-label="Position Independent Code"><!---->Position Independent Code<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/21-elf-loader-p1" aria-label="ELF Loader (Part 1)"><!---->ELF Loader (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/22-elf-loader-p2" aria-label="ELF Loader (Part 2)"><!---->ELF Loader (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/23-coop-multitasking" aria-label="Cooperative Multitasking"><!---->Cooperative Multitasking<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/24-system-library" aria-label="System Library"><!---->System Library<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/25-interrupt-controller" aria-label="Interrupt Controller"><!---->Interrupt Controller<!----></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="tasks" tabindex="-1"><a class="header-anchor" href="#tasks"><span>Tasks</span></a></h1><p>We&#39;re starting to accumulate a number of things about the user program that the kernel needs to track: the user page table, the user stack, the kernel switch stack, and the user <code>rsp</code> when executing <code>syscall</code>. These are all currently tracked in global variables. Once we start having more than one user task, it will be hard to keep track of all these things.</p><h2 id="task-definition" tabindex="-1"><a class="header-anchor" href="#task-definition"><span>Task definition</span></a></h2><p>Let&#39;s define a <code>Task</code> type to encapsulate all this information. This will prepare us for having multiple tasks. Let&#39;s create a new module <code>tasks.nim</code> for this.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/tasks.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> common<span class="token operator">/</span>pagetables</span>
<span class="line"><span class="token keyword">import</span> vmm</span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  TaskStack<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    data<span class="token operator">*:</span> <span class="token keyword">ptr</span> uint8</span>
<span class="line">    size<span class="token operator">*:</span> uint64</span>
<span class="line">    bottom<span class="token operator">*:</span> uint64</span>
<span class="line"></span>
<span class="line">  Task<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">ref</span> <span class="token keyword">object</span></span>
<span class="line">    id<span class="token operator">*:</span> uint64</span>
<span class="line">    pml4<span class="token operator">*:</span> <span class="token keyword">ptr</span> PML4Table</span>
<span class="line">    ustack<span class="token operator">*:</span> TaskStack</span>
<span class="line">    kstack<span class="token operator">*:</span> TaskStack</span>
<span class="line">    rsp<span class="token operator">*:</span> uint64</span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span></span>
<span class="line">  nextId<span class="token operator">*:</span> uint64 <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Each task has a unique <code>id</code>, a pointer to its page table, and two stacks: one for user mode and one for kernel mode. The <code>rsp</code> field is where the user stack pointer is stored when the task is executing in kernel mode (e.g. when executing a system call). We also define a <code>TaskStack</code> type to encapsulate the stack address, size, and the bottom of the stack (i.e. the address just beyond the end of the stack). The <code>nextId</code> variable will be used to assign unique IDs to each task.</p><p>Before we can start creating tasks, we need a way to allocate virtual memory within an address space. Let&#39;s add a few things to the virtual memory manager to support this.</p><h2 id="address-space-abstraction" tabindex="-1"><a class="header-anchor" href="#address-space-abstraction"><span>Address space abstraction</span></a></h2><p>For a particular address space, we need to track which regions are currently allocated, and a way to allocate more regions. We&#39;ll use this to allocate the user stack and kernel stack. To make it easy to refer to a particular address space, and track which regions are currently allocated in it, we&#39;ll define a <code>VMAddressSpace</code> type.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/vmm.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  VMRegion<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    start<span class="token operator">:</span> VirtAddr</span>
<span class="line">    npages<span class="token operator">:</span> uint64</span>
<span class="line"></span>
<span class="line">  VMAddressSpace<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    minAddress<span class="token operator">*:</span> VirtAddr</span>
<span class="line">    maxAddress<span class="token operator">*:</span> VirtAddr</span>
<span class="line">    regions<span class="token operator">*:</span> seq<span class="token punctuation">[</span>VMRegion<span class="token punctuation">]</span></span>
<span class="line">    pml4<span class="token operator">*:</span> <span class="token keyword">ptr</span> PML4Table</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Notice that I also defined a <code>VMRegion</code> type to represent a contiguous region of virtual memory. Notice also that I defined two fields <code>minAddress</code> and <code>maxAddress</code> in <code>VMAddressSpace</code> to track the minimum and maximum addresses in the address space. This will make it easy to confine the address space to the lower half (for user space) or upper half (for kernel space) of the virtual address space.</p><p>Let&#39;s make a slight modification to the <code>Task</code> type to use the new <code>VMAddressSpace</code> type instead of a pointer to a <code>PML4Table</code>.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line">  Task<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">ref</span> <span class="token keyword">object</span></span>
<span class="line">    id<span class="token operator">*:</span> uint64</span>
<span class="line highlighted">    space<span class="token operator">*:</span> VMAddressSpace</span>
<span class="line">    ustack<span class="token operator">*:</span> TaskStack</span>
<span class="line">    kstack<span class="token operator">*:</span> TaskStack</span>
<span class="line">    rsp<span class="token operator">*:</span> uint64</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Let&#39;s now add a proc to allocate virtual memory in an address space.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/vmm.nim</span></span>
<span class="line"><span class="token keyword">import</span> std<span class="token operator">/</span>algorithm</span>
<span class="line"><span class="token operator">...</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">vmalloc<span class="token operator">*</span></span><span class="token punctuation">(</span></span>
<span class="line">  space<span class="token operator">:</span> <span class="token keyword">var</span> VMAddressSpace<span class="token punctuation">,</span></span>
<span class="line">  pageCount<span class="token operator">:</span> uint64<span class="token punctuation">,</span></span>
<span class="line">  pageAccess<span class="token operator">:</span> PageAccess<span class="token punctuation">,</span></span>
<span class="line">  pageMode<span class="token operator">:</span> PageMode<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span>VirtAddr<span class="token punctuation">]</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token comment"># find a free region</span></span>
<span class="line">  <span class="token keyword">var</span> virtAddr<span class="token operator">:</span> VirtAddr <span class="token operator">=</span> space<span class="token operator">.</span>minAddress</span>
<span class="line">  <span class="token keyword">for</span> region <span class="token operator">in</span> space<span class="token operator">.</span>regions<span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">if</span> virtAddr <span class="token operator">+!</span> pageCount <span class="token operator">*</span> PageSize <span class="token operator">&lt;=</span> region<span class="token operator">.</span>start<span class="token operator">:</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    virtAddr <span class="token operator">=</span> region<span class="token operator">.</span>start <span class="token operator">+!</span> region<span class="token operator">.</span>npages <span class="token operator">*</span> PageSize</span>
<span class="line"></span>
<span class="line">  <span class="token comment"># allocate physical memory and map it</span></span>
<span class="line">  <span class="token keyword">let</span> physAddr <span class="token operator">=</span> <span class="token function">pmalloc</span><span class="token punctuation">(</span>pageCount<span class="token punctuation">)</span><span class="token operator">.</span>get <span class="token comment"># TODO: handle allocation failure</span></span>
<span class="line">  <span class="token function">mapRegion</span><span class="token punctuation">(</span>space<span class="token operator">.</span>pml4<span class="token punctuation">,</span> virtAddr<span class="token punctuation">,</span> physAddr<span class="token punctuation">,</span> pageCount<span class="token punctuation">,</span> pageAccess<span class="token punctuation">,</span> pageMode<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># add the region to the address space</span></span>
<span class="line">  space<span class="token operator">.</span>regions<span class="token operator">.</span>add <span class="token function">VMRegion</span><span class="token punctuation">(</span>start<span class="token operator">:</span> virtAddr<span class="token punctuation">,</span> npages<span class="token operator">:</span> pageCount<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># sort the regions by start address</span></span>
<span class="line">  space<span class="token operator">.</span>regions <span class="token operator">=</span> space<span class="token operator">.</span>regions<span class="token operator">.</span><span class="token function">sortedByIt</span><span class="token punctuation">(</span>it<span class="token operator">.</span>start<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  result <span class="token operator">=</span> some virtAddr</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The <code>vmalloc</code> proc finds a free region in the address space, allocates physical memory, and maps it into the address space. It returns the virtual address of the allocated region. We then sort the regions by start address, so that we can easily find a free region in the future. (Ideally, the standard library should provide a sorted container that we can use here, but for now, we&#39;ll just sort the regions manually after adding a new one.)</p><p>We also need a way to add existing VM regions to an address space. We&#39;ll need this to add the existing kernel VM regions (code/data and stack) to its address space.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/vmm.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">vmAddRegion<span class="token operator">*</span></span><span class="token punctuation">(</span>space<span class="token operator">:</span> <span class="token keyword">var</span> VMAddressSpace<span class="token punctuation">,</span> start<span class="token operator">:</span> VirtAddr<span class="token punctuation">,</span> npages<span class="token operator">:</span> uint64<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line">  space<span class="token operator">.</span>regions<span class="token operator">.</span>add <span class="token function">VMRegion</span><span class="token punctuation">(</span>start<span class="token operator">:</span> start<span class="token punctuation">,</span> npages<span class="token operator">:</span> npages<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="kernel-address-space" tabindex="-1"><a class="header-anchor" href="#kernel-address-space"><span>Kernel address space</span></a></h2><p>The kernel itself needs its own address space. Let&#39;s create a global variable <code>kspace</code> to track it.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/vmm.nim</span></span>
<span class="line"><span class="token operator">...</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span></span>
<span class="line">  KernelSpaceMinAddress<span class="token operator">*</span> <span class="token operator">=</span> <span class="token number">0xffff800000000000&#39;u64</span><span class="token operator">.</span>VirtAddr</span>
<span class="line">  KernelSpaceMaxAddress<span class="token operator">*</span> <span class="token operator">=</span> <span class="token number">0xffffffffffffffff&#39;u64</span><span class="token operator">.</span>VirtAddr</span>
<span class="line">  UserSpaceMinAddress<span class="token operator">*</span> <span class="token operator">=</span> <span class="token number">0x0000000000000000&#39;u64</span><span class="token operator">.</span>VirtAddr</span>
<span class="line">  UserSpaceMaxAddress<span class="token operator">*</span> <span class="token operator">=</span> <span class="token number">0x00007fffffffffff&#39;u64</span><span class="token operator">.</span>VirtAddr</span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span></span>
<span class="line">  kspace<span class="token operator">*:</span> VMAddressSpace</span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">vmInit<span class="token operator">*</span></span><span class="token punctuation">(</span>physMemoryVirtualBase<span class="token operator">:</span> uint64<span class="token punctuation">,</span> physAlloc<span class="token operator">:</span> PhysAlloc<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line">  physicalMemoryVirtualBase <span class="token operator">=</span> physMemoryVirtualBase</span>
<span class="line">  pmalloc <span class="token operator">=</span> physAlloc</span>
<span class="line">  kspace <span class="token operator">=</span> <span class="token function">VMAddressSpace</span><span class="token punctuation">(</span></span>
<span class="line">    minAddress<span class="token operator">:</span> KernelSpaceMinAddress<span class="token punctuation">,</span></span>
<span class="line">    maxAddress<span class="token operator">:</span> KernelSpaceMaxAddress<span class="token punctuation">,</span></span>
<span class="line">    regions<span class="token operator">:</span> <span class="token operator">@</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    pml4<span class="token operator">:</span> <span class="token function">getActivePML4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Let&#39;s also add the existing kernel VM regions to it (code/data and stack).</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/main.nim</span></span>
<span class="line"><span class="token operator">...</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">KernelMain</span><span class="token punctuation">(</span>bootInfo<span class="token operator">:</span> <span class="token keyword">ptr</span> BootInfo<span class="token punctuation">)</span> <span class="token punctuation">{.</span>exportc<span class="token punctuation">.}</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line">  debug <span class="token string">&quot;kernel: Initializing virtual memory manager &quot;</span></span>
<span class="line">  <span class="token function">vmInit</span><span class="token punctuation">(</span>bootInfo<span class="token operator">.</span>physicalMemoryVirtualBase<span class="token punctuation">,</span> pmm<span class="token operator">.</span>pmAlloc<span class="token punctuation">)</span></span>
<span class="line">  <span class="token function">vmAddRegion</span><span class="token punctuation">(</span>kspace<span class="token punctuation">,</span> bootInfo<span class="token operator">.</span>kernelImageVirtualBase<span class="token operator">.</span>VirtAddr<span class="token punctuation">,</span> bootInfo<span class="token operator">.</span>kernelImagePages<span class="token punctuation">)</span></span>
<span class="line">  <span class="token function">vmAddRegion</span><span class="token punctuation">(</span>kspace<span class="token punctuation">,</span> bootInfo<span class="token operator">.</span>kernelStackVirtualBase<span class="token operator">.</span>VirtAddr<span class="token punctuation">,</span> bootInfo<span class="token operator">.</span>kernelStackPages<span class="token punctuation">)</span></span>
<span class="line">  debugln <span class="token string">&quot;[success]&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="creating-a-task" tabindex="-1"><a class="header-anchor" href="#creating-a-task"><span>Creating a task</span></a></h2><p>Creating a task involves the following steps:</p><ol><li>Creating a VM address space and allocating a page table</li><li>Mapping the task image (code and data) into the task page table</li><li>Mapping the kernel space into the task page table</li><li>Allocating and mapping a user stack (in user space)</li><li>Allocating and mapping a kernel stack (in kernel space)</li><li>Creating an interrupt stack frame on the kernel stack (for switching to user mode)</li><li>Setting the <code>rsp</code> field to point to the interrupt stack frame</li></ol><p>This seems like a lot of steps, but it&#39;s not too bad. Let&#39;s add a <code>createTask</code> proc to the <code>tasks</code> module to do all this. We&#39;ll also add a <code>createStack</code> helper proc to allocate a stack in a particular address space.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/tasks.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">createStack<span class="token operator">*</span></span><span class="token punctuation">(</span>space<span class="token operator">:</span> <span class="token keyword">var</span> VMAddressSpace<span class="token punctuation">,</span> npages<span class="token operator">:</span> uint64<span class="token punctuation">,</span> mode<span class="token operator">:</span> PageMode<span class="token punctuation">)</span><span class="token operator">:</span> TaskStack <span class="token operator">=</span></span>
<span class="line">  <span class="token keyword">let</span> stackPtr <span class="token operator">=</span> <span class="token function">vmalloc</span><span class="token punctuation">(</span>space<span class="token punctuation">,</span> npages<span class="token punctuation">,</span> paReadWrite<span class="token punctuation">,</span> mode<span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">if</span> stackPtr<span class="token operator">.</span>isNone<span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">raise</span> <span class="token function">newException</span><span class="token punctuation">(</span>Exception<span class="token punctuation">,</span> <span class="token string">&quot;tasks: Failed to allocate stack&quot;</span><span class="token punctuation">)</span></span>
<span class="line">  result<span class="token operator">.</span>data <span class="token operator">=</span> <span class="token keyword">cast</span><span class="token punctuation">[</span><span class="token keyword">ptr</span> UncheckedArray<span class="token punctuation">[</span>uint64<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span>stackPtr<span class="token operator">.</span>get<span class="token punctuation">)</span></span>
<span class="line">  result<span class="token operator">.</span>size <span class="token operator">=</span> npages <span class="token operator">*</span> PageSize</span>
<span class="line">  result<span class="token operator">.</span>bottom <span class="token operator">=</span> <span class="token function">cast[uint64]</span><span class="token punctuation">(</span>result<span class="token operator">.</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> result<span class="token operator">.</span>size</span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">createTask<span class="token operator">*</span></span><span class="token punctuation">(</span></span>
<span class="line">  imageVirtAddr<span class="token operator">:</span> VirtAddr<span class="token punctuation">,</span></span>
<span class="line">  imagePhysAddr<span class="token operator">:</span> PhysAddr<span class="token punctuation">,</span></span>
<span class="line">  imagePageCount<span class="token operator">:</span> uint64<span class="token punctuation">,</span></span>
<span class="line">  entryPoint<span class="token operator">:</span> VirtAddr</span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> Task <span class="token operator">=</span></span>
<span class="line">  <span class="token function">new</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">let</span> taskId <span class="token operator">=</span> nextId</span>
<span class="line">  inc nextId</span>
<span class="line"></span>
<span class="line">  <span class="token keyword">var</span> uspace <span class="token operator">=</span> <span class="token function">VMAddressSpace</span><span class="token punctuation">(</span></span>
<span class="line">    minAddress<span class="token operator">:</span> UserSpaceMinAddress<span class="token punctuation">,</span></span>
<span class="line">    maxAddress<span class="token operator">:</span> UserSpaceMaxAddress<span class="token punctuation">,</span></span>
<span class="line">    pml4<span class="token operator">:</span> <span class="token function">cast[ptr PML4Table]</span><span class="token punctuation">(</span>new PML4Table<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># map task image</span></span>
<span class="line">  <span class="token function">mapRegion</span><span class="token punctuation">(</span></span>
<span class="line">    pml4 <span class="token operator">=</span> uspace<span class="token operator">.</span>pml4<span class="token punctuation">,</span></span>
<span class="line">    virtAddr <span class="token operator">=</span> imageVirtAddr<span class="token punctuation">,</span></span>
<span class="line">    physAddr <span class="token operator">=</span> imagePhysAddr<span class="token punctuation">,</span></span>
<span class="line">    pageCount <span class="token operator">=</span> imagePageCount<span class="token punctuation">,</span></span>
<span class="line">    pageAccess <span class="token operator">=</span> paReadWrite<span class="token punctuation">,</span></span>
<span class="line">    pageMode <span class="token operator">=</span> pmUser<span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># map kernel space</span></span>
<span class="line">  <span class="token keyword">var</span> kpml4 <span class="token operator">=</span> <span class="token function">getActivePML4</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">for</span> i <span class="token operator">in</span> <span class="token number">256</span> <span class="token operator">..&lt;</span> <span class="token number">512</span><span class="token operator">:</span></span>
<span class="line">    uspace<span class="token operator">.</span>pml4<span class="token operator">.</span>entries<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> kpml4<span class="token operator">.</span>entries<span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># create user and kernel stacks</span></span>
<span class="line">  <span class="token keyword">let</span> ustack <span class="token operator">=</span> <span class="token function">createStack</span><span class="token punctuation">(</span>uspace<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> pmUser<span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">let</span> kstack <span class="token operator">=</span> <span class="token function">createStack</span><span class="token punctuation">(</span>kspace<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> pmSupervisor<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># create interrupt stack frame on the kernel stack</span></span>
<span class="line">  <span class="token keyword">var</span> index <span class="token operator">=</span> kstack<span class="token operator">.</span>size <span class="token operator">div</span> <span class="token number">8</span></span>
<span class="line">  kstack<span class="token operator">.</span>data<span class="token punctuation">[</span>index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cast[uint64]</span><span class="token punctuation">(</span>DataSegmentSelector<span class="token punctuation">)</span> <span class="token comment"># SS</span></span>
<span class="line">  kstack<span class="token operator">.</span>data<span class="token punctuation">[</span>index <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cast[uint64]</span><span class="token punctuation">(</span>ustack<span class="token operator">.</span>bottom<span class="token punctuation">)</span> <span class="token comment"># RSP</span></span>
<span class="line">  kstack<span class="token operator">.</span>data<span class="token punctuation">[</span>index <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cast[uint64]</span><span class="token punctuation">(</span><span class="token number">0x202</span><span class="token punctuation">)</span> <span class="token comment"># RFLAGS</span></span>
<span class="line">  kstack<span class="token operator">.</span>data<span class="token punctuation">[</span>index <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cast[uint64]</span><span class="token punctuation">(</span>UserCodeSegmentSelector<span class="token punctuation">)</span> <span class="token comment"># CS</span></span>
<span class="line">  kstack<span class="token operator">.</span>data<span class="token punctuation">[</span>index <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cast[uint64]</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">)</span> <span class="token comment"># RIP</span></span>
<span class="line"></span>
<span class="line">  result<span class="token operator">.</span>id <span class="token operator">=</span> taskId</span>
<span class="line">  result<span class="token operator">.</span>space <span class="token operator">=</span> uspace</span>
<span class="line">  result<span class="token operator">.</span>ustack <span class="token operator">=</span> ustack</span>
<span class="line">  result<span class="token operator">.</span>kstack <span class="token operator">=</span> kstack</span>
<span class="line">  result<span class="token operator">.</span>rsp <span class="token operator">=</span> <span class="token function">cast[uint64]</span><span class="token punctuation">(</span>kstack<span class="token operator">.</span>data<span class="token punctuation">[</span>index <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token keyword">addr</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Most of this code is not new; we just put it together in one place. The only new thing is calling <code>vmalloc</code> to allocate the user stack and kernel stack (which in turn allocates the backing physical memory). We no longer need to create global arrays to statically allocate the stacks.</p><h2 id="switching-to-a-task" tabindex="-1"><a class="header-anchor" href="#switching-to-a-task"><span>Switching to a task</span></a></h2><p>The part responsible for switching to a task was at the end of the <code>KernelMainInner</code> proc. Let&#39;s move it to the <code>tasks</code> module.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/tasks.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">switchTo<span class="token operator">*</span></span><span class="token punctuation">(</span>task<span class="token operator">:</span> <span class="token keyword">var</span> Task<span class="token punctuation">)</span> <span class="token punctuation">{.</span>noreturn<span class="token punctuation">.}</span> <span class="token operator">=</span></span>
<span class="line">  tss<span class="token operator">.</span>rsp0 <span class="token operator">=</span> task<span class="token operator">.</span>kstack<span class="token operator">.</span>bottom</span>
<span class="line">  <span class="token keyword">let</span> rsp <span class="token operator">=</span> task<span class="token operator">.</span>rsp</span>
<span class="line">  <span class="token function">setActivePML4</span><span class="token punctuation">(</span>task<span class="token operator">.</span>space<span class="token operator">.</span>pml4<span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">asm</span> <span class="token string">&quot;&quot;&quot;</span>
<span class="line">    mov rbp, 0</span>
<span class="line">    mov rsp, %0</span>
<span class="line">    iretq</span>
<span class="line">    :</span>
<span class="line">    : &quot;r&quot;(`rsp`)</span>
<span class="line">  &quot;&quot;&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We update <code>tss.rsp0</code> to point to the kernel stack (so it can be used when the task switches to kernel mode), set the active page table to the task&#39;s page table, set the <code>rsp</code> register to the task&#39;s <code>rsp</code> field (which should point to the interrupt stack frame), and then execute <code>iretq</code> to switch to the task.</p><h2 id="trying-it-out" tabindex="-1"><a class="header-anchor" href="#trying-it-out"><span>Trying it out</span></a></h2><p>We can now replace a big chunk of the code we had in <code>KernelMainInner</code> with a call to <code>createTask</code> and <code>switchTo</code>.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/main.nim</span></span>
<span class="line"><span class="token operator">...</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">KernelMain</span><span class="token punctuation">(</span>bootInfo<span class="token operator">:</span> <span class="token keyword">ptr</span> BootInfo<span class="token punctuation">)</span> <span class="token punctuation">{.</span>exportc<span class="token punctuation">.}</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line">  debugln <span class="token string">&quot;kernel: Creating user task&quot;</span></span>
<span class="line">  <span class="token keyword">var</span> task <span class="token operator">=</span> <span class="token function">createTask</span><span class="token punctuation">(</span></span>
<span class="line">    imageVirtAddr <span class="token operator">=</span> UserImageVirtualBase<span class="token operator">.</span>VirtAddr<span class="token punctuation">,</span></span>
<span class="line">    imagePhysAddr <span class="token operator">=</span> bootInfo<span class="token operator">.</span>userImagePhysicalBase<span class="token operator">.</span>PhysAddr<span class="token punctuation">,</span></span>
<span class="line">    imagePageCount <span class="token operator">=</span> bootInfo<span class="token operator">.</span>userImagePages<span class="token punctuation">,</span></span>
<span class="line">    entryPoint <span class="token operator">=</span> UserImageVirtualBase<span class="token operator">.</span>VirtAddr</span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  debug <span class="token string">&quot;kernel: Initializing Syscalls &quot;</span></span>
<span class="line">  <span class="token function">syscallInit</span><span class="token punctuation">(</span>task<span class="token operator">.</span>kstack<span class="token operator">.</span>bottom<span class="token punctuation">)</span></span>
<span class="line">  debugln <span class="token string">&quot;[success]&quot;</span></span>
<span class="line"></span>
<span class="line">  debugln <span class="token string">&quot;kernel: Switching to user mode&quot;</span></span>
<span class="line">  <span class="token function">switchTo</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Let&#39;s try it out.</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">kernel: Initializing GDT [success]</span>
<span class="line">kernel: Initializing IDT [success]</span>
<span class="line">kernel: Creating user task</span>
<span class="line">kernel: Initializing Syscalls [success]</span>
<span class="line">kernel: Switching to user mode</span>
<span class="line">syscall: num=2</span>
<span class="line">syscall: print</span>
<span class="line">user: Hello from user mode!</span>
<span class="line">syscall: num=1</span>
<span class="line">syscall: exit: code=0</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Great! It&#39;s nice to be able to encapsulate all the task information in a <code>Task</code> object, and to be able to create a task and switch to it with just a few lines of code.</p><p>There&#39;s one thing that I still don&#39;t like, which is that we initialize the system calls with the kernel stack of the task. The system call entry point should be able to switch to the current task&#39;s kernel stack on its own, without relying on a global variable for the kernel stack. Once we start having multiple tasks, we need to be able to switch to the kernel stack of the current task.</p><h2 id="tracking-the-current-task" tabindex="-1"><a class="header-anchor" href="#tracking-the-current-task"><span>Tracking the current task</span></a></h2><p>We can solve this problem by tracking the current task in a global variable. Let&#39;s add a <code>currentTask</code> variable to the <code>tasks</code> module, and set it in the <code>switchTo</code> proc. One thing we&#39;ll do differently here is that we&#39;ll add the <code>exportc</code> pragma to this variable, so that we can access it from inline assembly later.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/tasks.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span></span>
<span class="line">  currentTask<span class="token operator">*</span> <span class="token punctuation">{.</span>exportc<span class="token punctuation">.}</span><span class="token operator">:</span> Task</span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">switchTo<span class="token operator">*</span></span><span class="token punctuation">(</span>task<span class="token operator">:</span> <span class="token keyword">var</span> Task<span class="token punctuation">)</span> <span class="token punctuation">{.</span>noreturn<span class="token punctuation">.}</span> <span class="token operator">=</span></span>
<span class="line">  currentTask <span class="token operator">=</span> task</span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now, we can change the system call entry point to switch to the current task&#39;s kernel stack.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/syscalls.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> tasks</span>
<span class="line"><span class="token operator">...</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span></span>
<span class="line">  syscallTable<span class="token operator">:</span> array<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> SyscallHandler<span class="token punctuation">]</span></span>
<span class="line">  tss <span class="token punctuation">{.</span>importc<span class="token punctuation">.}</span><span class="token operator">:</span> TaskStateSegment</span>
<span class="line highlighted">  currentTask <span class="token punctuation">{.</span>importc<span class="token punctuation">.}</span><span class="token operator">:</span> Task</span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">syscallEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{.</span>asmNoStackFrame<span class="token punctuation">.}</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token keyword">asm</span> <span class="token string">&quot;&quot;&quot;</span>
<span class="line">    # switch to kernel stack</span>
<span class="line">    mov %0, rsp</span>
<span class="line">    mov rsp, %1</span>
<span class="line"></span>
<span class="line">    ...</span>
<span class="line"></span>
<span class="line">    # switch to user stack</span>
<span class="line">    mov rsp, %0</span>
<span class="line"></span>
<span class="line">    sysretq</span>
<span class="line highlighted">    : &quot;+r&quot;(`currentTask`-&gt;rsp)</span>
<span class="line highlighted">    : &quot;m&quot;(`currentTask`-&gt;kstack.bottom)</span>
<span class="line">    : &quot;rcx&quot;, &quot;r11&quot;, &quot;rdi&quot;, &quot;rsi&quot;, &quot;rdx&quot;, &quot;rcx&quot;, &quot;r8&quot;, &quot;r9&quot;, &quot;rax&quot;</span>
<span class="line">  &quot;&quot;&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We can now remove the argument to <code>syscallInit</code>.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/syscalls.nim</span></span>
<span class="line"><span class="token operator">...</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">syscallInit<span class="token operator">*</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>And make the corresponding change in <code>KernelMainInner</code>. Also, since we don&#39;t need the kernel stack to initialize system calls anymore, we can move the call to <code>syscallInit</code> before creating the task.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/main.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">KernelMainInner</span><span class="token punctuation">(</span>bootInfo<span class="token operator">:</span> <span class="token keyword">ptr</span> BootInfo<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line">  debug <span class="token string">&quot;kernel: Initializing Syscalls &quot;</span></span>
<span class="line">  <span class="token function">syscallInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  debugln <span class="token string">&quot;[success]&quot;</span></span>
<span class="line"></span>
<span class="line">  debugln <span class="token string">&quot;kernel: Creating user task&quot;</span></span>
<span class="line">  <span class="token keyword">var</span> task <span class="token operator">=</span> <span class="token function">createTask</span><span class="token punctuation">(</span></span>
<span class="line">    imageVirtAddr <span class="token operator">=</span> UserImageVirtualBase<span class="token operator">.</span>VirtAddr<span class="token punctuation">,</span></span>
<span class="line">    imagePhysAddr <span class="token operator">=</span> bootInfo<span class="token operator">.</span>userImagePhysicalBase<span class="token operator">.</span>PhysAddr<span class="token punctuation">,</span></span>
<span class="line">    imagePageCount <span class="token operator">=</span> bootInfo<span class="token operator">.</span>userImagePages<span class="token punctuation">,</span></span>
<span class="line">    entryPoint <span class="token operator">=</span> UserImageVirtualBase<span class="token operator">.</span>VirtAddr</span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  debugln <span class="token string">&quot;kernel: Switching to user mode&quot;</span></span>
<span class="line">  <span class="token function">switchTo</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Much simpler. Let&#39;s try it out.</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">kernel: Initializing GDT [success]</span>
<span class="line">kernel: Initializing IDT [success]</span>
<span class="line">kernel: Initializing Syscalls [success]</span>
<span class="line">kernel: Creating user task</span>
<span class="line">kernel: Switching to user mode</span>
<span class="line">syscall: num=2</span>
<span class="line">syscall: print</span>
<span class="line">user: Hello from user mode!</span>
<span class="line">syscall: num=1</span>
<span class="line">syscall: exit: code=0</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>All good! We&#39;re in a much better place than we were before.</p><p>Ideally, we should now be able to create multiple tasks and switch between them. But, since we&#39;re creating a single address space OS, we need to be able to load tasks at different virtual addresses. So far, we&#39;ve been using a fixed virtual address for the user task; i.e., the task image is not relocatable. This means we have to link every user program at a different virtual address, which is not ideal. Traditional operating systems use a separate address space for each task, so linking the task image at a fixed virtual address is not a problem. In our case, we need to make the task image relocatable, so that we can load it at an arbitrary virtual address. That&#39;s what we&#39;ll do next.</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/osdev/18-system-calls" aria-label="System Calls"><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span>System Calls</span></div></a><a class="route-link auto-link next" href="/osdev/20-position-independent-code" aria-label="Position Independent Code"><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span>Position Independent Code</span></div></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BEnvQN0t.js" defer></script>
  </body>
</html>
