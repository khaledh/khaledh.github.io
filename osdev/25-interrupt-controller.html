<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.15" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #22272e;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>Interrupt Controller | Khaled Hammouda</title><meta name="description" content="Building a 64-bit operating system from scratch in Nim">
    <link rel="preload" href="/assets/style-DFReAQZD.css" as="style"><link rel="stylesheet" href="/assets/style-DFReAQZD.css">
    <link rel="modulepreload" href="/assets/app-BEnvQN0t.js"><link rel="modulepreload" href="/assets/25-interrupt-controller.html-i_QNpPOS.js">
    <link rel="prefetch" href="/assets/index.html-DN4baEjd.js" as="script"><link rel="prefetch" href="/assets/index.html-DTcVMSat.js" as="script"><link rel="prefetch" href="/assets/01-mm.html-DdVm3GHI.js" as="script"><link rel="prefetch" href="/assets/index.html-D8_cVHQe.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-Bq4FSDwn.js" as="script"><link rel="prefetch" href="/assets/02-setup.html-9f0UzP9I.js" as="script"><link rel="prefetch" href="/assets/03-filetype.html-DVtyN252.js" as="script"><link rel="prefetch" href="/assets/04-lexer.html-OooGwppm.js" as="script"><link rel="prefetch" href="/assets/05-parser.html-Dw5HPOU5.js" as="script"><link rel="prefetch" href="/assets/06-parser-p2.html-CHLJtldD.js" as="script"><link rel="prefetch" href="/assets/07-grammarkit.html-DALOmYeT.js" as="script"><link rel="prefetch" href="/assets/08-go-to-decl.html-DPftLCwO.js" as="script"><link rel="prefetch" href="/assets/09-scopes.html-BhA3Jfl5.js" as="script"><link rel="prefetch" href="/assets/10-rename-refactoring.html-CQ7xy6Op.js" as="script"><link rel="prefetch" href="/assets/11-indentation.html-BSbVKVoe.js" as="script"><link rel="prefetch" href="/assets/12-decl-sections.html-DM3D0T_j.js" as="script"><link rel="prefetch" href="/assets/13-comments.html-PACjUQ8Q.js" as="script"><link rel="prefetch" href="/assets/14-numeric-lit.html-Bx-wwqk6.js" as="script"><link rel="prefetch" href="/assets/15-expressions.html-26eNyM4d.js" as="script"><link rel="prefetch" href="/assets/99-tmp.html-gvMZWEF9.js" as="script"><link rel="prefetch" href="/assets/index.html-J4FG-UC7.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-BeNfzmF-.js" as="script"><link rel="prefetch" href="/assets/02-environment-setup.html-C8XAFCUU.js" as="script"><link rel="prefetch" href="/assets/03-targeting-uefi-p1.html-C9weobAl.js" as="script"><link rel="prefetch" href="/assets/04-targeting-uefi-p2.html-DtpCSkF_.js" as="script"><link rel="prefetch" href="/assets/05-bootloader-p1.html-nF5TI7gq.js" as="script"><link rel="prefetch" href="/assets/06-bootloader-p2.html-lTW7xvyF.js" as="script"><link rel="prefetch" href="/assets/07-kernel-image.html-Dbec7FcX.js" as="script"><link rel="prefetch" href="/assets/08-loading-the-kernel-p1.html-CgEWrWCh.js" as="script"><link rel="prefetch" href="/assets/09-loading-the-kernel-p2.html-Bsyq9hJE.js" as="script"><link rel="prefetch" href="/assets/10-loading-the-kernel-p3.html-Cz6f791z.js" as="script"><link rel="prefetch" href="/assets/11-physical-memory.html-Iko_lfyH.js" as="script"><link rel="prefetch" href="/assets/12-virtual-memory.html-BdHdqaeH.js" as="script"><link rel="prefetch" href="/assets/13-higher-half-kernel.html-U7sLCIG_.js" as="script"><link rel="prefetch" href="/assets/14-memory-segments.html-C0Wfonfg.js" as="script"><link rel="prefetch" href="/assets/15-interrupts.html-CuXOHXlP.js" as="script"><link rel="prefetch" href="/assets/16-user-mode.html-DI-QEaJn.js" as="script"><link rel="prefetch" href="/assets/17-tss.html-DedksTv0.js" as="script"><link rel="prefetch" href="/assets/18-system-calls.html-CANG8AhC.js" as="script"><link rel="prefetch" href="/assets/19-tasks.html-D_KA9R1n.js" as="script"><link rel="prefetch" href="/assets/20-position-independent-code.html-DcxhRHAD.js" as="script"><link rel="prefetch" href="/assets/21-elf-loader-p1.html-hRqOVejE.js" as="script"><link rel="prefetch" href="/assets/22-elf-loader-p2.html-CwKLac9X.js" as="script"><link rel="prefetch" href="/assets/23-coop-multitasking.html-CmjVNMNt.js" as="script"><link rel="prefetch" href="/assets/24-system-library.html-Chl8ifRh.js" as="script"><link rel="prefetch" href="/assets/index.html--jTsfqNO.js" as="script"><link rel="prefetch" href="/assets/404.html-CYnd4SKg.js" as="script"><link rel="prefetch" href="/assets/SearchResult-ZUCfC4Sv.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">Khaled Hammouda</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading active" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a><ul class="vp-sidebar-children" style=""><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/01-intro" aria-label="Writing an OS in Nim"><!---->Writing an OS in Nim<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/02-environment-setup" aria-label="Environment Setup"><!---->Environment Setup<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/03-targeting-uefi-p1" aria-label="Targeting UEFI (Part 1)"><!---->Targeting UEFI (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/04-targeting-uefi-p2" aria-label="Targeting UEFI (Part 2)"><!---->Targeting UEFI (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/05-bootloader-p1" aria-label="UEFI Bootloader (Part 1)"><!---->UEFI Bootloader (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/06-bootloader-p2" aria-label="UEFI Bootloader (Part 2)"><!---->UEFI Bootloader (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/07-kernel-image" aria-label="Kernel Image"><!---->Kernel Image<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/08-loading-the-kernel-p1" aria-label="Loading the Kernel (Part 1)"><!---->Loading the Kernel (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/09-loading-the-kernel-p2" aria-label="Loading the Kernel (Part 2)"><!---->Loading the Kernel (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/10-loading-the-kernel-p3" aria-label="Loading the Kernel (Part 3)"><!---->Loading the Kernel (Part 3)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/11-physical-memory" aria-label="Physical Memory"><!---->Physical Memory<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/12-virtual-memory" aria-label="Virtual Memory"><!---->Virtual Memory<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/13-higher-half-kernel" aria-label="Higher Half Kernel"><!---->Higher Half Kernel<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/14-memory-segments" aria-label="Memory Segments"><!---->Memory Segments<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/15-interrupts" aria-label="Interrupts"><!---->Interrupts<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/16-user-mode" aria-label="User Mode"><!---->User Mode<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/17-tss" aria-label="Task State Segment"><!---->Task State Segment<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/18-system-calls" aria-label="System Calls"><!---->System Calls<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/19-tasks" aria-label="Tasks"><!---->Tasks<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/20-position-independent-code" aria-label="Position Independent Code"><!---->Position Independent Code<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/21-elf-loader-p1" aria-label="ELF Loader (Part 1)"><!---->ELF Loader (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/22-elf-loader-p2" aria-label="ELF Loader (Part 2)"><!---->ELF Loader (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/23-coop-multitasking" aria-label="Cooperative Multitasking"><!---->Cooperative Multitasking<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/24-system-library" aria-label="System Library"><!---->System Library<!----></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/osdev/25-interrupt-controller" aria-label="Interrupt Controller"><!---->Interrupt Controller<!----></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="interrupt-controller" tabindex="-1"><a class="header-anchor" href="#interrupt-controller"><span>Interrupt Controller</span></a></h1><p>The legacy x86 architecture featured a single interrupt controller, the 8259A Programmable Interrupt Controller (PIC), responsible for managing hardware interrupts. The PIC is a simple device that is limited to 8 interrupts per controller (15 interrupts total when cascaded with another PIC, as one interrupt line is used for the cascade), and is limited in terms of interrupt priority, routing flexibility, and multiprocessor support.</p><p>The PIC is now considered obsolete, and modern x86 systems use the Advanced Programmable Interrupt Controller (APIC) architecture. The APIC architecture consists of two main components: the I/O APIC and the Local APIC. The I/O APIC is responsible for managing interrupts from external devices (usually there is only one in the system), while the Local APIC is integrated into each CPU core and is responsible for managing interrupts delivered to the CPU core (whether from the I/O APIC or from the Local APIC of other CPU cores), as well as interrupts from internal sources such as the Local APIC timer. For this reason, we will focus on the Local APIC in this section.</p><h2 id="local-apic" tabindex="-1"><a class="header-anchor" href="#local-apic"><span>Local APIC</span></a></h2><p>The Local APIC is responsible for managing interrupts delivered to its associated core. The interrupts it delivers can originate from internal sources, such as its timer, thermal sensors, and performance monitoring counters, or from external sources, such as the I/O APIC and Inter-Processor Interrupts (IPIs).</p><p>The following is a simplified diagram of the relevant components of the Local APIC (there are more components, but we won&#39;t need them for now):</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">┌─────────────────────────────┐</span>
<span class="line">│      Version Register       │</span>
<span class="line">└─────────────────────────────┘</span>
<span class="line"></span>
<span class="line">┌──────────────────────────────┐ ◄──┐</span>
<span class="line">│    Current Count Register    │    │</span>
<span class="line">├──────────────────────────────┤    │</span>
<span class="line">│    Initial Count Register    │    ├── Timer Registers</span>
<span class="line">├──────────────────────────────┤    │</span>
<span class="line">│     Divide Configuration     │    │</span>
<span class="line">└──────────────────────────────┘ ◄──┘</span>
<span class="line"></span>
<span class="line">┌──────────────────────────────┐ ◄──┐</span>
<span class="line">│            Timer             │    │</span>
<span class="line">├──────────────────────────────┤    │</span>
<span class="line">│          Local INT0          │    │</span>
<span class="line">├──────────────────────────────┤    │</span>
<span class="line">│          Local INT1          │    │</span>
<span class="line">├──────────────────────────────┤    ├── Local Vector Table (LVT)</span>
<span class="line">│  Perf. Monitoring Counters   │    │</span>
<span class="line">├──────────────────────────────┤    │</span>
<span class="line">│        Thermal Sensors       │    │</span>
<span class="line">├──────────────────────────────┤    │</span>
<span class="line">│        Error Register        │    │</span>
<span class="line">└──────────────────────────────┘ ◄──┘</span>
<span class="line"></span>
<span class="line">┌──────────────────────────────┐</span>
<span class="line">┆       Other registers...     ┆</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The Local APIC is memory-mapped, typically at physical address <code>0xFEE00000</code>; the actual address should be read from the <code>IA32_APIC_BASE</code> MSR. Although the address is the same for all cores, they operate independently and can be programmed separately. Here&#39;s a diagram of this MSR:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">                                IA32_APIC_BASE MSR</span>
<span class="line"> </span>
<span class="line"> 63             MAX_PHYS_ADDR                          12 11 10  9  8 7         0</span>
<span class="line">┌────────────────────────────┬───────────────────────────┬──┬─────┬──┬───────────┐</span>
<span class="line">│░░░░░░░░░░░░░░░░░░░░░░░░░░░░│         APIC Base         │  │░░░░░│  │░░░░░░░░░░░│</span>
<span class="line">└────────────────────────────┴───────────────────────────┴──┴─────┴──┴───────────┘</span>
<span class="line">                                           ▲               ▲        ▲</span>
<span class="line">              Physical base address ───────┘               │        │</span>
<span class="line">         APIC global enable/disable ───────────────────────┘        │</span>
<span class="line">             BSP - Processor is BSP ────────────────────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The APIC is programmed by writing to its registers, which are 32 bits wide and located at fixed offsets from the base address. The registers occupy a 4KB page of physical memory address space, from <code>0xFEE00000</code> to <code>0xFEE00FFF</code>, with each register aligned on a 16-byte boundary.</p><p>Since the base address we get from the <code>IA32_APIC_BASE</code> MSR is a physical address, we can&#39;t use it directly; we need to map a page of virtual memory to it first, and then use that virtual memory region to access the APIC registers. Also note this description from the Intel manual:</p><blockquote><p><strong>APIC Base field, bits 12 through 35</strong>: Specifies the base address of the APIC registers. This 24-bit value is extended by 12 bits at the low end to form the base address. This automatically aligns the address on a 4-KByte boundary.</p></blockquote><p>So we&#39;ll need to shift the base address left by 12 bits to get the physical address of the APIC. Since the address is already aligned to a page boundary, we can use it directly when mapping it to virtual memory.</p><p>Let&#39;s start by creating a new module <code>lapic.nim</code> and defining a type for the <code>IA32_APIC_BASE</code> MSR so that we can read it and get the physical address of the Local APIC.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/lapic.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  IA32ApicBaseMsr <span class="token punctuation">{.</span>packed<span class="token punctuation">.}</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    reserved1   <span class="token punctuation">{.</span>bitsize<span class="token operator">:</span>  <span class="token number">8.</span><span class="token punctuation">}</span><span class="token operator">:</span> uint64</span>
<span class="line">    isBsp       <span class="token punctuation">{.</span>bitsize<span class="token operator">:</span>  <span class="token number">1.</span><span class="token punctuation">}</span><span class="token operator">:</span> uint64  <span class="token comment"># Is Bootstrap Processor?</span></span>
<span class="line">    reserved2   <span class="token punctuation">{.</span>bitsize<span class="token operator">:</span>  <span class="token number">2.</span><span class="token punctuation">}</span><span class="token operator">:</span> uint64</span>
<span class="line">    enabled     <span class="token punctuation">{.</span>bitsize<span class="token operator">:</span>  <span class="token number">1.</span><span class="token punctuation">}</span><span class="token operator">:</span> uint64  <span class="token comment"># APIC Enabled?</span></span>
<span class="line">    baseAddress <span class="token punctuation">{.</span>bitsize<span class="token operator">:</span> <span class="token number">24.</span><span class="token punctuation">}</span><span class="token operator">:</span> uint64  <span class="token comment"># Physical Base Address (bits 12-35)</span></span>
<span class="line">    reserved3   <span class="token punctuation">{.</span>bitsize<span class="token operator">:</span> <span class="token number">28.</span><span class="token punctuation">}</span><span class="token operator">:</span> uint64</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Let&#39;s import our <code>vmm</code> module so that we can map the APIC region, and let&#39;s define a proc to initialize the base virtual address of the APIC.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token keyword">import</span> vmm</span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span></span>
<span class="line">  apicBaseAddress<span class="token operator">:</span> uint64</span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">initBaseAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token keyword">let</span> apicBaseMsr <span class="token operator">=</span> <span class="token function">cast[IA32ApicBaseMsr]</span><span class="token punctuation">(</span><span class="token function">readMSR</span><span class="token punctuation">(</span>IA32_APIC_BASE<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">let</span> apicPhysAddr <span class="token operator">=</span> <span class="token punctuation">(</span>apicBaseMsr<span class="token operator">.</span>baseAddress <span class="token operator">shl</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token operator">.</span>PhysAddr</span>
<span class="line">  <span class="token comment"># by definition, apicPhysAddr is aligned to a page boundary, so we map it directly</span></span>
<span class="line">  <span class="token keyword">let</span> apicVMRegion <span class="token operator">=</span> <span class="token function">vmalloc</span><span class="token punctuation">(</span>kspace<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token function">mapRegion</span><span class="token punctuation">(</span></span>
<span class="line">    pml4 <span class="token operator">=</span> kpml4<span class="token punctuation">,</span></span>
<span class="line">    virtAddr <span class="token operator">=</span> apicVMRegion<span class="token operator">.</span>start<span class="token punctuation">,</span></span>
<span class="line">    physAddr <span class="token operator">=</span> apicPhysAddr<span class="token punctuation">,</span></span>
<span class="line">    pageCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">    pageAccess <span class="token operator">=</span> paReadWrite<span class="token punctuation">,</span></span>
<span class="line">    pageMode <span class="token operator">=</span> pmSupervisor<span class="token punctuation">,</span></span>
<span class="line">    noExec <span class="token operator">=</span> true</span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line">  apicBaseAddress <span class="token operator">=</span> apicVMRegion<span class="token operator">.</span>start<span class="token operator">.</span>uint64</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The APIC has many registers at different offsets from the base address, each register is 32 bits wide. Let&#39;s define the offsets of those registers. The registers we are interested in are pointed out with comments, as we&#39;ll use them later to initialize the APIC and program the timer. And while we&#39;re at it, let&#39;s also add a couple of procs to read from and write to the APIC registers.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token keyword">type</span></span>
<span class="line">  LapicOffset <span class="token operator">=</span> <span class="token keyword">enum</span></span>
<span class="line">    LapicId            <span class="token operator">=</span> <span class="token number">0x020</span></span>
<span class="line">    LapicVersion       <span class="token operator">=</span> <span class="token number">0x030</span></span>
<span class="line">    TaskPriority       <span class="token operator">=</span> <span class="token number">0x080</span></span>
<span class="line">    ProcessorPriority  <span class="token operator">=</span> <span class="token number">0x0a0</span></span>
<span class="line">    Eoi                <span class="token operator">=</span> <span class="token number">0x0b0</span> <span class="token comment"># ◄────── End Of Interrupt Register</span></span>
<span class="line">    LogicalDestination <span class="token operator">=</span> <span class="token number">0x0d0</span></span>
<span class="line">    DestinationFormat  <span class="token operator">=</span> <span class="token number">0x0e0</span></span>
<span class="line">    SpuriousInterrupt  <span class="token operator">=</span> <span class="token number">0x0f0</span> <span class="token comment"># ◄────── Spurious Interrupt Vector Register</span></span>
<span class="line">    InService          <span class="token operator">=</span> <span class="token number">0x100</span></span>
<span class="line">    TriggerMode        <span class="token operator">=</span> <span class="token number">0x180</span></span>
<span class="line">    InterruptRequest   <span class="token operator">=</span> <span class="token number">0x200</span></span>
<span class="line">    ErrorStatus        <span class="token operator">=</span> <span class="token number">0x280</span></span>
<span class="line">    LvtCmci            <span class="token operator">=</span> <span class="token number">0x2f0</span></span>
<span class="line">    InterruptCommandLo <span class="token operator">=</span> <span class="token number">0x300</span></span>
<span class="line">    InterruptCommandHi <span class="token operator">=</span> <span class="token number">0x310</span></span>
<span class="line">    LvtTimer           <span class="token operator">=</span> <span class="token number">0x320</span> <span class="token comment"># ◄────── LVT Timer Register</span></span>
<span class="line">    LvtThermalSensor   <span class="token operator">=</span> <span class="token number">0x330</span></span>
<span class="line">    LvtPerfMonCounters <span class="token operator">=</span> <span class="token number">0x340</span></span>
<span class="line">    LvtLint0           <span class="token operator">=</span> <span class="token number">0x350</span></span>
<span class="line">    LvtLint1           <span class="token operator">=</span> <span class="token number">0x360</span></span>
<span class="line">    LvtError           <span class="token operator">=</span> <span class="token number">0x370</span></span>
<span class="line">    TimerInitialCount  <span class="token operator">=</span> <span class="token number">0x380</span>  <span class="token comment"># ◄──┐</span></span>
<span class="line">    TimerCurrentCount  <span class="token operator">=</span> <span class="token number">0x390</span>  <span class="token comment">#    ├── Timer Config Registers</span></span>
<span class="line">    TimerDivideConfig  <span class="token operator">=</span> <span class="token number">0x3e0</span>  <span class="token comment"># ◄──┘</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">readRegister</span><span class="token punctuation">(</span>offset<span class="token operator">:</span> LapicOffset<span class="token punctuation">)</span><span class="token operator">:</span> uint32 <span class="token punctuation">{.</span>inline<span class="token punctuation">.}</span> <span class="token operator">=</span></span>
<span class="line">  result <span class="token operator">=</span> <span class="token function">cast[ptr uint32]</span><span class="token punctuation">(</span>apicBaseAddress <span class="token operator">+</span> offset<span class="token operator">.</span>uint16<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">writeRegister</span><span class="token punctuation">(</span>offset<span class="token operator">:</span> LapicOffset<span class="token punctuation">,</span> value<span class="token operator">:</span> uint32<span class="token punctuation">)</span> <span class="token punctuation">{.</span>inline<span class="token punctuation">.}</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token function">cast[ptr uint32]</span><span class="token punctuation">(</span>apicBaseAddress <span class="token operator">+</span> offset<span class="token operator">.</span>uint16<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> value</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="initializing-the-apic" tabindex="-1"><a class="header-anchor" href="#initializing-the-apic"><span>Initializing the APIC</span></a></h2><p>There are two places that control whether the APIC is enabled or not: the <code>IA32_APIC_BASE</code> MSR APIC global enable/disable flag (bit 11), and the APIC software enable/disable flag in the spurious-interrupt vector register.</p><div class="hint-container note"><p class="hint-container-title">Note</p><p>Spurious interrupts can occur in rare situations when the processor receives an interrupt at a lower priority than the current interrupt being processed, causing it to become pending. While the ISR for the current interrupt is executing, it may mask the pending interrupt. The APIC will then deliver a spurious interrupt to the processor, which will cause the processor to execute the ISR configured for spurious interrupts. In this case the spurious interrupt handler should just ignore the interrupt and return without an EOI.</p></div><p>The APIC global enable/disable flag is enabled by default, so we don&#39;t need to worry about it. This is not the case for the enable/disable bit in the spurious-interrupt vector register, so we need to set it to enable the APIC. Let&#39;s first look at a diagram of the spurious-interrupt vector register.</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">                       Spurious Interrupt Vector Register</span>
<span class="line"> </span>
<span class="line"> 31                                               12 11 10  9  8 7             0</span>
<span class="line">┌────────────────────────────────────────────────┬──┬─────┬──┬──┬───────────────┐</span>
<span class="line">│░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░│  │░░░░░│  │  │               │</span>
<span class="line">└────────────────────────────────────────────────┴──┴─────┴──┴──┴───────────────┘</span>
<span class="line">                                                  ▲         ▲  ▲       ▲</span>
<span class="line">                 EOI Broadcast Suppression ───────┘         │  │       │</span>
<span class="line">                  Focus Processor Checking ─────────────────┘  │       │</span>
<span class="line">              APIC Software Enable/Disable ────────────────────┘       │</span>
<span class="line">                 Spurious Interrupt Vector ────────────────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The bits we are interested in are the APIC software enable/disable bit (bit 8) and the spurious interrupt vector (bits 7-0). The vector is set to <code>0xFF</code> by the CPU by default, which we will keep as is, and will add a new interrupt handler for. Let&#39;s create a type for the spurious interrupt vector register so we can easily access its fields.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token keyword">type</span></span>
<span class="line">  SpuriousInterruptVectorRegister <span class="token punctuation">{.</span>packed<span class="token punctuation">.}</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    vector                  <span class="token punctuation">{.</span>bitsize<span class="token operator">:</span>  <span class="token number">8.</span><span class="token punctuation">}</span><span class="token operator">:</span> uint32</span>
<span class="line">    apicEnabled             <span class="token punctuation">{.</span>bitsize<span class="token operator">:</span>  <span class="token number">1.</span><span class="token punctuation">}</span><span class="token operator">:</span> uint32</span>
<span class="line">    focusProcessorChecking  <span class="token punctuation">{.</span>bitsize<span class="token operator">:</span>  <span class="token number">1.</span><span class="token punctuation">}</span><span class="token operator">:</span> uint32</span>
<span class="line">    reserved0               <span class="token punctuation">{.</span>bitsize<span class="token operator">:</span>  <span class="token number">2.</span><span class="token punctuation">}</span><span class="token operator">:</span> uint32</span>
<span class="line">    eoiBroadcastSuppression <span class="token punctuation">{.</span>bitsize<span class="token operator">:</span>  <span class="token number">1.</span><span class="token punctuation">}</span><span class="token operator">:</span> uint32</span>
<span class="line">    reserved1               <span class="token punctuation">{.</span>bitsize<span class="token operator">:</span> <span class="token number">19.</span><span class="token punctuation">}</span><span class="token operator">:</span> uint32</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Let&#39;s create the spurious interrupt handler, which ignores those interrupts.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token keyword">import</span> idt</span>
<span class="line"><span class="token operator">...</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">spuriousInterruptHandler<span class="token operator">*</span></span><span class="token punctuation">(</span>frame<span class="token operator">:</span> <span class="token keyword">ptr</span> InterruptFrame<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">{.</span>cdecl<span class="token punctuation">,</span> codegenDecl<span class="token operator">:</span> <span class="token string">&quot;__attribute__ ((interrupt)) $# $#$#&quot;</span><span class="token punctuation">.}</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token comment"># Ignore spurious interrupts; do not send an EOI</span></span>
<span class="line">  <span class="token keyword">return</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now let&#39;s create a proc to initialize the APIC. This proc will first call <code>initBaseAddress</code> to initialize the base address of the APIC, write the spurious interrupt vector register to enable the APIC, and finally install the spurious interrupt handler in the IDT.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token keyword">proc</span> <span class="token function">lapicInit<span class="token operator">*</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token function">initBaseAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token comment"># enable APIC</span></span>
<span class="line">  <span class="token keyword">let</span> sivr <span class="token operator">=</span> <span class="token function">SpuriousInterruptVectorRegister</span><span class="token punctuation">(</span>vector<span class="token operator">:</span> <span class="token number">0xff</span><span class="token punctuation">,</span> apicEnabled<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token function">writeRegister</span><span class="token punctuation">(</span>LapicOffset<span class="token operator">.</span>SpuriousInterrupt<span class="token punctuation">,</span> <span class="token function">cast[uint32]</span><span class="token punctuation">(</span>sivr<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token comment"># install spurious interrupt handler</span></span>
<span class="line">  <span class="token function">installHandler</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">,</span> spuriousInterruptHandler<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Finally, we need to call <code>lapicInit</code> from the kernel&#39;s <code>main</code> proc to initialize the APIC.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/main.nim</span></span>
<span class="line"></span>
<span class="line highlighted"><span class="token keyword">import</span> lapic</span>
<span class="line"><span class="token operator">...</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">KernelMainInner</span><span class="token punctuation">(</span>bootInfo<span class="token operator">:</span> <span class="token keyword">ptr</span> BootInfo<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line">  logger<span class="token operator">.</span>info <span class="token string">&quot;init idt&quot;</span></span>
<span class="line">  <span class="token function">idtInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line highlighted">  logger<span class="token operator">.</span>info <span class="token string">&quot;init lapic&quot;</span></span>
<span class="line highlighted">  <span class="token function">lapicInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The Local APIC should now be initialized and ready to receive interrupts. In the next section, we&#39;ll look at how to program the Local APIC timer to generate periodic interrupts.</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/osdev/24-system-library" aria-label="System Library"><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span>System Library</span></div></a><!----></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BEnvQN0t.js" defer></script>
  </body>
</html>
