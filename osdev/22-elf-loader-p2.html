<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.15" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #22272e;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>ELF Loader (Part 2) | Khaled Hammouda</title><meta name="description" content="Building a 64-bit operating system from scratch in Nim">
    <link rel="preload" href="/assets/style-DFReAQZD.css" as="style"><link rel="stylesheet" href="/assets/style-DFReAQZD.css">
    <link rel="modulepreload" href="/assets/app-BEnvQN0t.js"><link rel="modulepreload" href="/assets/22-elf-loader-p2.html-CwKLac9X.js">
    <link rel="prefetch" href="/assets/index.html-DN4baEjd.js" as="script"><link rel="prefetch" href="/assets/index.html-DTcVMSat.js" as="script"><link rel="prefetch" href="/assets/01-mm.html-DdVm3GHI.js" as="script"><link rel="prefetch" href="/assets/index.html-D8_cVHQe.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-Bq4FSDwn.js" as="script"><link rel="prefetch" href="/assets/02-setup.html-9f0UzP9I.js" as="script"><link rel="prefetch" href="/assets/03-filetype.html-DVtyN252.js" as="script"><link rel="prefetch" href="/assets/04-lexer.html-OooGwppm.js" as="script"><link rel="prefetch" href="/assets/05-parser.html-Dw5HPOU5.js" as="script"><link rel="prefetch" href="/assets/06-parser-p2.html-CHLJtldD.js" as="script"><link rel="prefetch" href="/assets/07-grammarkit.html-DALOmYeT.js" as="script"><link rel="prefetch" href="/assets/08-go-to-decl.html-DPftLCwO.js" as="script"><link rel="prefetch" href="/assets/09-scopes.html-BhA3Jfl5.js" as="script"><link rel="prefetch" href="/assets/10-rename-refactoring.html-CQ7xy6Op.js" as="script"><link rel="prefetch" href="/assets/11-indentation.html-BSbVKVoe.js" as="script"><link rel="prefetch" href="/assets/12-decl-sections.html-DM3D0T_j.js" as="script"><link rel="prefetch" href="/assets/13-comments.html-PACjUQ8Q.js" as="script"><link rel="prefetch" href="/assets/14-numeric-lit.html-Bx-wwqk6.js" as="script"><link rel="prefetch" href="/assets/15-expressions.html-26eNyM4d.js" as="script"><link rel="prefetch" href="/assets/99-tmp.html-gvMZWEF9.js" as="script"><link rel="prefetch" href="/assets/index.html-J4FG-UC7.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-BeNfzmF-.js" as="script"><link rel="prefetch" href="/assets/02-environment-setup.html-C8XAFCUU.js" as="script"><link rel="prefetch" href="/assets/03-targeting-uefi-p1.html-C9weobAl.js" as="script"><link rel="prefetch" href="/assets/04-targeting-uefi-p2.html-DtpCSkF_.js" as="script"><link rel="prefetch" href="/assets/05-bootloader-p1.html-nF5TI7gq.js" as="script"><link rel="prefetch" href="/assets/06-bootloader-p2.html-lTW7xvyF.js" as="script"><link rel="prefetch" href="/assets/07-kernel-image.html-Dbec7FcX.js" as="script"><link rel="prefetch" href="/assets/08-loading-the-kernel-p1.html-CgEWrWCh.js" as="script"><link rel="prefetch" href="/assets/09-loading-the-kernel-p2.html-Bsyq9hJE.js" as="script"><link rel="prefetch" href="/assets/10-loading-the-kernel-p3.html-Cz6f791z.js" as="script"><link rel="prefetch" href="/assets/11-physical-memory.html-Iko_lfyH.js" as="script"><link rel="prefetch" href="/assets/12-virtual-memory.html-BdHdqaeH.js" as="script"><link rel="prefetch" href="/assets/13-higher-half-kernel.html-U7sLCIG_.js" as="script"><link rel="prefetch" href="/assets/14-memory-segments.html-C0Wfonfg.js" as="script"><link rel="prefetch" href="/assets/15-interrupts.html-CuXOHXlP.js" as="script"><link rel="prefetch" href="/assets/16-user-mode.html-DI-QEaJn.js" as="script"><link rel="prefetch" href="/assets/17-tss.html-DedksTv0.js" as="script"><link rel="prefetch" href="/assets/18-system-calls.html-CANG8AhC.js" as="script"><link rel="prefetch" href="/assets/19-tasks.html-D_KA9R1n.js" as="script"><link rel="prefetch" href="/assets/20-position-independent-code.html-DcxhRHAD.js" as="script"><link rel="prefetch" href="/assets/21-elf-loader-p1.html-hRqOVejE.js" as="script"><link rel="prefetch" href="/assets/23-coop-multitasking.html-CmjVNMNt.js" as="script"><link rel="prefetch" href="/assets/24-system-library.html-Chl8ifRh.js" as="script"><link rel="prefetch" href="/assets/25-interrupt-controller.html-i_QNpPOS.js" as="script"><link rel="prefetch" href="/assets/index.html--jTsfqNO.js" as="script"><link rel="prefetch" href="/assets/404.html-CYnd4SKg.js" as="script"><link rel="prefetch" href="/assets/SearchResult-ZUCfC4Sv.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">Khaled Hammouda</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading active" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a><ul class="vp-sidebar-children" style=""><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/01-intro" aria-label="Writing an OS in Nim"><!---->Writing an OS in Nim<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/02-environment-setup" aria-label="Environment Setup"><!---->Environment Setup<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/03-targeting-uefi-p1" aria-label="Targeting UEFI (Part 1)"><!---->Targeting UEFI (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/04-targeting-uefi-p2" aria-label="Targeting UEFI (Part 2)"><!---->Targeting UEFI (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/05-bootloader-p1" aria-label="UEFI Bootloader (Part 1)"><!---->UEFI Bootloader (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/06-bootloader-p2" aria-label="UEFI Bootloader (Part 2)"><!---->UEFI Bootloader (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/07-kernel-image" aria-label="Kernel Image"><!---->Kernel Image<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/08-loading-the-kernel-p1" aria-label="Loading the Kernel (Part 1)"><!---->Loading the Kernel (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/09-loading-the-kernel-p2" aria-label="Loading the Kernel (Part 2)"><!---->Loading the Kernel (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/10-loading-the-kernel-p3" aria-label="Loading the Kernel (Part 3)"><!---->Loading the Kernel (Part 3)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/11-physical-memory" aria-label="Physical Memory"><!---->Physical Memory<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/12-virtual-memory" aria-label="Virtual Memory"><!---->Virtual Memory<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/13-higher-half-kernel" aria-label="Higher Half Kernel"><!---->Higher Half Kernel<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/14-memory-segments" aria-label="Memory Segments"><!---->Memory Segments<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/15-interrupts" aria-label="Interrupts"><!---->Interrupts<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/16-user-mode" aria-label="User Mode"><!---->User Mode<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/17-tss" aria-label="Task State Segment"><!---->Task State Segment<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/18-system-calls" aria-label="System Calls"><!---->System Calls<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/19-tasks" aria-label="Tasks"><!---->Tasks<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/20-position-independent-code" aria-label="Position Independent Code"><!---->Position Independent Code<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/21-elf-loader-p1" aria-label="ELF Loader (Part 1)"><!---->ELF Loader (Part 1)<!----></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/osdev/22-elf-loader-p2" aria-label="ELF Loader (Part 2)"><!---->ELF Loader (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/23-coop-multitasking" aria-label="Cooperative Multitasking"><!---->Cooperative Multitasking<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/24-system-library" aria-label="System Library"><!---->System Library<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/25-interrupt-controller" aria-label="Interrupt Controller"><!---->Interrupt Controller<!----></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="elf-loader-part-2" tabindex="-1"><a class="header-anchor" href="#elf-loader-part-2"><span>ELF Loader (Part 2)</span></a></h1><p>So far we have the code that loads the task image into memory in the <code>tasks</code> module. We also have code that applies relocations in the <code>loader</code> module. Now that we&#39;re going to deal with ELF, it&#39;s time to move all task loading code into the <code>loader</code> module (which will use the <code>elf</code> module to read the ELF file).</p><h2 id="loading-elf" tabindex="-1"><a class="header-anchor" href="#loading-elf"><span>Loading ELF</span></a></h2><p>We don&#39;t have a filesystem yet, so we are still going to rely on the user task being loaded by the bootloader into memory, until we implement a filesystem. The task loader will use the in-memory ELF binary to &quot;load&quot; the task by:</p><ul><li>allocating enough virtual memory for the task</li><li>mapping virtual memory to physical memory with the correct permissions</li><li>copying the loadable segments into their respective virtual memory regions</li><li>applying relocation entries to the loaded segments</li><li>identifying the entry point and returning it to the caller</li></ul><p>Let&#39;s start by adding a new proc to the <code>loader</code> module to load an ELF binary, given the address of the raw ELF image in memory. The first step is to iterate over the segments and build a corresponding list of page-aligned VM regions.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/loader.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> elf</span>
<span class="line"><span class="token keyword">import</span> vmm</span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">load<span class="token operator">*</span></span><span class="token punctuation">(</span>imagePtr<span class="token operator">:</span> pointer<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token keyword">let</span> image <span class="token operator">=</span> <span class="token function">initElfImage</span><span class="token punctuation">(</span>imagePtr<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># get a list of page-aligned memory regions to be mapped</span></span>
<span class="line">  <span class="token keyword">var</span> vmRegions<span class="token operator">:</span> seq<span class="token punctuation">[</span>VMRegion<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">@</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token function">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> ph<span class="token punctuation">)</span> <span class="token operator">in</span> <span class="token function">segments</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">if</span> ph<span class="token operator">.</span><span class="token keyword">type</span> <span class="token operator">==</span> ElfProgramHeaderType<span class="token operator">.</span>Load<span class="token operator">:</span></span>
<span class="line">      <span class="token keyword">if</span> ph<span class="token operator">.</span>align <span class="token operator">!=</span> PageSize<span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">raise</span> <span class="token function">newException</span><span class="token punctuation">(</span>LoaderError<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token string">&quot;Unsupported alignment {ph.align:#x} for segment {i}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">let</span> startOffset <span class="token operator">=</span> ph<span class="token operator">.</span>vaddr <span class="token operator">mod</span> PageSize</span>
<span class="line">      <span class="token keyword">let</span> startPage <span class="token operator">=</span> ph<span class="token operator">.</span>vaddr <span class="token operator">-</span> startOffset</span>
<span class="line">      <span class="token keyword">let</span> numPages <span class="token operator">=</span> <span class="token punctuation">(</span>startOffset <span class="token operator">+</span> ph<span class="token operator">.</span>memsz <span class="token operator">+</span> PageSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">div</span> PageSize</span>
<span class="line">      <span class="token keyword">let</span> region <span class="token operator">=</span> <span class="token function">VMRegion</span><span class="token punctuation">(</span></span>
<span class="line">        start<span class="token operator">:</span> startPage<span class="token operator">.</span>VirtAddr<span class="token punctuation">,</span></span>
<span class="line">        npages<span class="token operator">:</span> numPages<span class="token punctuation">,</span></span>
<span class="line">        flags<span class="token operator">:</span> <span class="token function">cast[VMRegionFlags]</span><span class="token punctuation">(</span>ph<span class="token operator">.</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">)</span></span>
<span class="line">      vmRegions<span class="token operator">.</span><span class="token function">add</span><span class="token punctuation">(</span>region<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Notice that we need to keep track of the segment flags as well, as they will be used to set the page permissions. We didn&#39;t have that <code>flags</code> field on <code>VMRegion</code> before, so let&#39;s add it now:</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/vmm.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  VMRegion<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    start<span class="token operator">*:</span> VirtAddr</span>
<span class="line">    npages<span class="token operator">*:</span> uint64</span>
<span class="line highlighted">    flags<span class="token operator">*:</span> VMRegionFlags</span>
<span class="line highlighted"></span>
<span class="line highlighted">  VMRegionFlag<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">enum</span></span>
<span class="line highlighted">    Execute <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;E&quot;</span><span class="token punctuation">)</span></span>
<span class="line highlighted">    Write   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;W&quot;</span><span class="token punctuation">)</span></span>
<span class="line highlighted">    Read    <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;R&quot;</span><span class="token punctuation">)</span></span>
<span class="line highlighted">  VMRegionFlags<span class="token operator">*</span> <span class="token punctuation">{.</span>size<span class="token operator">:</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>uint32<span class="token punctuation">)</span><span class="token punctuation">.}</span> <span class="token operator">=</span> set<span class="token punctuation">[</span>VMRegionFlag<span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now, let&#39;s validate a couple of assumptions: (1) there must be at least one segment, and (2) the address of the start page of the first segment must be zero, since the ELF binary is supposed to be relocatable (i.e. a PIE).</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/loader.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  LoaderError<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">of</span> CatchableError</span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">load<span class="token operator">*</span></span><span class="token punctuation">(</span>imagePtr<span class="token operator">:</span> pointer<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> vmRegions<span class="token operator">.</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">raise</span> <span class="token function">newException</span><span class="token punctuation">(</span>LoaderError<span class="token punctuation">,</span> <span class="token string">&quot;No loadable segments found&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> vmRegions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">.</span>start<span class="token operator">.</span>uint64 <span class="token operator">!=</span> <span class="token number">0</span><span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">raise</span> <span class="token function">newException</span><span class="token punctuation">(</span>LoaderError<span class="token punctuation">,</span> <span class="token string">&quot;Expecting a PIE binary with a base address of 0&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now, we have two options to allocate the required VM regions:</p><ol><li>Allocate a single large region that spans all segments</li><li>Allocate one region per segment</li></ol><p>The first option is simpler, but it may waste memory if the segments are not contiguous. The second is more complex because we have to maintain the relative positions of the segments to the base of the first segment. Our virtual memory allocator is not prepared to handle this yet (it allocates regions in a best-fit manner), so we&#39;ll go with the first option for now.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/loader.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> std<span class="token operator">/</span>algorithm</span>
<span class="line"><span class="token operator">...</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">load<span class="token operator">*</span></span><span class="token punctuation">(</span>imagePtr<span class="token operator">:</span> pointer<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># calculate total memory size</span></span>
<span class="line">  vmRegions <span class="token operator">=</span> vmRegions<span class="token operator">.</span><span class="token function">sortedByIt</span><span class="token punctuation">(</span>it<span class="token operator">.</span>start<span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">let</span> memSize <span class="token operator">=</span> vmRegions<span class="token punctuation">[</span><span class="token operator">^</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token keyword">end</span> <span class="token operator">-!</span> vmRegions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">.</span>start</span>
<span class="line">  <span class="token keyword">let</span> pageCount <span class="token operator">=</span> <span class="token punctuation">(</span>memSize <span class="token operator">+</span> PageSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">div</span> PageSize</span>
<span class="line"></span>
<span class="line">  <span class="token comment"># allocate a single contiguous region for the user image</span></span>
<span class="line">  <span class="token keyword">let</span> taskRegion <span class="token operator">=</span> <span class="token function">vmalloc</span><span class="token punctuation">(</span>uspace<span class="token punctuation">,</span> pageCount<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Remember that the individual regions in the <code>vmRegions</code> list assume that the first region starts at 0. We need to adjust the start of each region to the base of the <code>taskRegion</code>:</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/loader.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">load<span class="token operator">*</span></span><span class="token punctuation">(</span>imagePtr<span class="token operator">:</span> pointer<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># adjust the individual regions&#39; start addresses based on taskRegion.start</span></span>
<span class="line">  <span class="token keyword">for</span> region <span class="token operator">in</span> vmRegions<span class="token operator">.</span>mitems<span class="token operator">:</span></span>
<span class="line">    region<span class="token operator">.</span>start <span class="token operator">=</span> taskRegion<span class="token operator">.</span>start <span class="token operator">+!</span> region<span class="token operator">.</span>start<span class="token operator">.</span>uint64</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now we need to map the regions to physical memory. In addition to mapping them in the user address space, we also need to temporarily map them in the kernel address space so we can copy the segments into the user space.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/loader.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">load<span class="token operator">*</span></span><span class="token punctuation">(</span>imagePtr<span class="token operator">:</span> pointer<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># map each region into the page tables, making sure to set the R/W and NX flags as needed</span></span>
<span class="line">  <span class="token keyword">var</span> kpml4 <span class="token operator">=</span> <span class="token function">getActivePML4</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">for</span> region <span class="token operator">in</span> vmRegions<span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">let</span> access <span class="token operator">=</span> <span class="token keyword">if</span> region<span class="token operator">.</span>flags<span class="token operator">.</span><span class="token function">contains</span><span class="token punctuation">(</span>Write<span class="token punctuation">)</span><span class="token operator">:</span> paReadWrite <span class="token keyword">else</span><span class="token operator">:</span> paRead</span>
<span class="line">    <span class="token keyword">let</span> noExec <span class="token operator">=</span> <span class="token operator">not</span> region<span class="token operator">.</span>flags<span class="token operator">.</span><span class="token function">contains</span><span class="token punctuation">(</span>Execute<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">let</span> physAddr <span class="token operator">=</span> <span class="token function">vmmap</span><span class="token punctuation">(</span>region<span class="token punctuation">,</span> pml4<span class="token punctuation">,</span> access<span class="token punctuation">,</span> pmUser<span class="token punctuation">,</span> noExec<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># temporarily map the region in kernel space so that we can copy the segments and apply relocations</span></span>
<span class="line">    <span class="token function">mapRegion</span><span class="token punctuation">(</span></span>
<span class="line">      pml4 <span class="token operator">=</span> kpml4<span class="token punctuation">,</span></span>
<span class="line">      virtAddr <span class="token operator">=</span> region<span class="token operator">.</span>start<span class="token punctuation">,</span></span>
<span class="line">      physAddr <span class="token operator">=</span> physAddr<span class="token punctuation">,</span></span>
<span class="line">      pageCount <span class="token operator">=</span> region<span class="token operator">.</span>npages<span class="token punctuation">,</span></span>
<span class="line">      pageAccess <span class="token operator">=</span> paReadWrite<span class="token punctuation">,</span></span>
<span class="line">      pageMode <span class="token operator">=</span> pmSupervisor<span class="token punctuation">,</span></span>
<span class="line">      noExec <span class="token operator">=</span> true<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>OK, we&#39;re now ready to copy the segments into their respective regions. Remember that some segments may have a memory size (<code>memsz</code>) that is larger than the corresponding size in the file (<code>filesz</code>), as is the case with BSS segments. In such cases, we need to zero-fill the remaining memory.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/loader.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">load<span class="token operator">*</span></span><span class="token punctuation">(</span>imagePtr<span class="token operator">:</span> pointer<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># copy loadable segments from the image to the user memory</span></span>
<span class="line">  <span class="token function">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> ph<span class="token punctuation">)</span> <span class="token operator">in</span> <span class="token function">segments</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">if</span> ph<span class="token operator">.</span><span class="token keyword">type</span> <span class="token operator">!=</span> ElfProgramHeaderType<span class="token operator">.</span>Load<span class="token operator">:</span></span>
<span class="line">      <span class="token keyword">continue</span></span>
<span class="line">    <span class="token keyword">let</span> dest <span class="token operator">=</span> <span class="token function">cast[pointer]</span><span class="token punctuation">(</span>taskRegion<span class="token operator">.</span>start <span class="token operator">+!</span> ph<span class="token operator">.</span>vaddr<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">let</span> src <span class="token operator">=</span> <span class="token function">cast[pointer]</span><span class="token punctuation">(</span>imagePtr <span class="token operator">+!</span> ph<span class="token operator">.</span>offset<span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">copyMem</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> src<span class="token punctuation">,</span> ph<span class="token operator">.</span>filesz<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> ph<span class="token operator">.</span>filesz <span class="token operator">&lt;</span> ph<span class="token operator">.</span>memsz<span class="token operator">:</span></span>
<span class="line">      <span class="token function">zeroMem</span><span class="token punctuation">(</span><span class="token function">cast[pointer]</span><span class="token punctuation">(</span><span class="token function">cast[uint64]</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span> <span class="token operator">+</span> ph<span class="token operator">.</span>filesz<span class="token punctuation">)</span><span class="token punctuation">,</span> ph<span class="token operator">.</span>memsz <span class="token operator">-</span> ph<span class="token operator">.</span>filesz<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The segments are now loaded into memory. The next step is to apply any relocations that may be needed. Relocation metadata is stored in a segment of type <code>DYNAMIC</code>. We need to find this segment in the ELF image and pass its offset to the <code>applyRelocations</code> proc.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/loader.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">load<span class="token operator">*</span></span><span class="token punctuation">(</span>imagePtr<span class="token operator">:</span> pointer<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">var</span> dynOffset<span class="token operator">:</span> int <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> ph<span class="token punctuation">)</span> <span class="token operator">in</span> <span class="token function">segments</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">if</span> ph<span class="token operator">.</span><span class="token keyword">type</span> <span class="token operator">==</span> ElfProgramHeaderType<span class="token operator">.</span>Dynamic<span class="token operator">:</span></span>
<span class="line">      dynOffset <span class="token operator">=</span> <span class="token function">cast[int]</span><span class="token punctuation">(</span>ph<span class="token operator">.</span>vaddr<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> dynOffset <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">raise</span> <span class="token function">newException</span><span class="token punctuation">(</span>LoaderError<span class="token punctuation">,</span> <span class="token string">&quot;No dynamic section found&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">applyRelocations</span><span class="token punctuation">(</span></span>
<span class="line">    image <span class="token operator">=</span> <span class="token keyword">cast</span><span class="token punctuation">[</span><span class="token keyword">ptr</span> UncheckedArray<span class="token punctuation">[</span>byte<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span>taskRegion<span class="token operator">.</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    dynOffset <span class="token operator">=</span> <span class="token function">cast[uint64]</span><span class="token punctuation">(</span>dynOffset<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We&#39;re almost done. We no longer need the kernel&#39;s temporary mapping of the user task&#39;s memory, so we can unmap the regions now.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/loader.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">load<span class="token operator">*</span></span><span class="token punctuation">(</span>imagePtr<span class="token operator">:</span> pointer<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># unmap the user image from kernel space</span></span>
<span class="line">  <span class="token keyword">for</span> region <span class="token operator">in</span> vmRegions<span class="token operator">:</span></span>
<span class="line">    <span class="token function">unmapRegion</span><span class="token punctuation">(</span>kpml4<span class="token punctuation">,</span> region<span class="token operator">.</span>start<span class="token punctuation">,</span> region<span class="token operator">.</span>npages<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Finally, we need to return information about the loaded task to the caller, particularly the VM region where the task was loaded and the entry point.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/kernel/loader.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  LoadedElfImage<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    vmRegion<span class="token operator">*:</span> VMRegion</span>
<span class="line">    entryPoint<span class="token operator">*:</span> pointer</span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">load<span class="token operator">*</span></span><span class="token punctuation">(</span>imagePtr<span class="token operator">:</span> pointer<span class="token punctuation">)</span><span class="token operator">:</span> LoadedElfImage <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line">  result <span class="token operator">=</span> <span class="token function">LoadedElfImage</span><span class="token punctuation">(</span></span>
<span class="line">    vmRegion<span class="token operator">:</span> taskRegion<span class="token punctuation">,</span></span>
<span class="line">    entryPoint<span class="token operator">:</span> <span class="token function">cast[pointer]</span><span class="token punctuation">(</span>taskRegion<span class="token operator">.</span>start <span class="token operator">+!</span> image<span class="token operator">.</span>header<span class="token operator">.</span>entry<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/osdev/21-elf-loader-p1" aria-label="ELF Loader (Part 1)"><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span>ELF Loader (Part 1)</span></div></a><a class="route-link auto-link next" href="/osdev/23-coop-multitasking" aria-label="Cooperative Multitasking"><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span>Cooperative Multitasking</span></div></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BEnvQN0t.js" defer></script>
  </body>
</html>
