<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.15" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #22272e;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>Loading the Kernel (Part 1) | Khaled Hammouda</title><meta name="description" content="Building a 64-bit operating system from scratch in Nim">
    <link rel="preload" href="/assets/style-DFReAQZD.css" as="style"><link rel="stylesheet" href="/assets/style-DFReAQZD.css">
    <link rel="modulepreload" href="/assets/app-BEnvQN0t.js"><link rel="modulepreload" href="/assets/08-loading-the-kernel-p1.html-CgEWrWCh.js">
    <link rel="prefetch" href="/assets/index.html-DN4baEjd.js" as="script"><link rel="prefetch" href="/assets/index.html-DTcVMSat.js" as="script"><link rel="prefetch" href="/assets/01-mm.html-DdVm3GHI.js" as="script"><link rel="prefetch" href="/assets/index.html-D8_cVHQe.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-Bq4FSDwn.js" as="script"><link rel="prefetch" href="/assets/02-setup.html-9f0UzP9I.js" as="script"><link rel="prefetch" href="/assets/03-filetype.html-DVtyN252.js" as="script"><link rel="prefetch" href="/assets/04-lexer.html-OooGwppm.js" as="script"><link rel="prefetch" href="/assets/05-parser.html-Dw5HPOU5.js" as="script"><link rel="prefetch" href="/assets/06-parser-p2.html-CHLJtldD.js" as="script"><link rel="prefetch" href="/assets/07-grammarkit.html-DALOmYeT.js" as="script"><link rel="prefetch" href="/assets/08-go-to-decl.html-DPftLCwO.js" as="script"><link rel="prefetch" href="/assets/09-scopes.html-BhA3Jfl5.js" as="script"><link rel="prefetch" href="/assets/10-rename-refactoring.html-CQ7xy6Op.js" as="script"><link rel="prefetch" href="/assets/11-indentation.html-BSbVKVoe.js" as="script"><link rel="prefetch" href="/assets/12-decl-sections.html-DM3D0T_j.js" as="script"><link rel="prefetch" href="/assets/13-comments.html-PACjUQ8Q.js" as="script"><link rel="prefetch" href="/assets/14-numeric-lit.html-Bx-wwqk6.js" as="script"><link rel="prefetch" href="/assets/15-expressions.html-26eNyM4d.js" as="script"><link rel="prefetch" href="/assets/99-tmp.html-gvMZWEF9.js" as="script"><link rel="prefetch" href="/assets/index.html-J4FG-UC7.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-BeNfzmF-.js" as="script"><link rel="prefetch" href="/assets/02-environment-setup.html-C8XAFCUU.js" as="script"><link rel="prefetch" href="/assets/03-targeting-uefi-p1.html-C9weobAl.js" as="script"><link rel="prefetch" href="/assets/04-targeting-uefi-p2.html-DtpCSkF_.js" as="script"><link rel="prefetch" href="/assets/05-bootloader-p1.html-nF5TI7gq.js" as="script"><link rel="prefetch" href="/assets/06-bootloader-p2.html-lTW7xvyF.js" as="script"><link rel="prefetch" href="/assets/07-kernel-image.html-Dbec7FcX.js" as="script"><link rel="prefetch" href="/assets/09-loading-the-kernel-p2.html-Bsyq9hJE.js" as="script"><link rel="prefetch" href="/assets/10-loading-the-kernel-p3.html-Cz6f791z.js" as="script"><link rel="prefetch" href="/assets/11-physical-memory.html-Iko_lfyH.js" as="script"><link rel="prefetch" href="/assets/12-virtual-memory.html-BdHdqaeH.js" as="script"><link rel="prefetch" href="/assets/13-higher-half-kernel.html-U7sLCIG_.js" as="script"><link rel="prefetch" href="/assets/14-memory-segments.html-C0Wfonfg.js" as="script"><link rel="prefetch" href="/assets/15-interrupts.html-CuXOHXlP.js" as="script"><link rel="prefetch" href="/assets/16-user-mode.html-DI-QEaJn.js" as="script"><link rel="prefetch" href="/assets/17-tss.html-DedksTv0.js" as="script"><link rel="prefetch" href="/assets/18-system-calls.html-CANG8AhC.js" as="script"><link rel="prefetch" href="/assets/19-tasks.html-D_KA9R1n.js" as="script"><link rel="prefetch" href="/assets/20-position-independent-code.html-DcxhRHAD.js" as="script"><link rel="prefetch" href="/assets/21-elf-loader-p1.html-hRqOVejE.js" as="script"><link rel="prefetch" href="/assets/22-elf-loader-p2.html-CwKLac9X.js" as="script"><link rel="prefetch" href="/assets/23-coop-multitasking.html-CmjVNMNt.js" as="script"><link rel="prefetch" href="/assets/24-system-library.html-Chl8ifRh.js" as="script"><link rel="prefetch" href="/assets/25-interrupt-controller.html-i_QNpPOS.js" as="script"><link rel="prefetch" href="/assets/index.html--jTsfqNO.js" as="script"><link rel="prefetch" href="/assets/404.html-CYnd4SKg.js" as="script"><link rel="prefetch" href="/assets/SearchResult-ZUCfC4Sv.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">Khaled Hammouda</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading active" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a><ul class="vp-sidebar-children" style=""><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/01-intro" aria-label="Writing an OS in Nim"><!---->Writing an OS in Nim<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/02-environment-setup" aria-label="Environment Setup"><!---->Environment Setup<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/03-targeting-uefi-p1" aria-label="Targeting UEFI (Part 1)"><!---->Targeting UEFI (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/04-targeting-uefi-p2" aria-label="Targeting UEFI (Part 2)"><!---->Targeting UEFI (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/05-bootloader-p1" aria-label="UEFI Bootloader (Part 1)"><!---->UEFI Bootloader (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/06-bootloader-p2" aria-label="UEFI Bootloader (Part 2)"><!---->UEFI Bootloader (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/07-kernel-image" aria-label="Kernel Image"><!---->Kernel Image<!----></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/osdev/08-loading-the-kernel-p1" aria-label="Loading the Kernel (Part 1)"><!---->Loading the Kernel (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/09-loading-the-kernel-p2" aria-label="Loading the Kernel (Part 2)"><!---->Loading the Kernel (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/10-loading-the-kernel-p3" aria-label="Loading the Kernel (Part 3)"><!---->Loading the Kernel (Part 3)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/11-physical-memory" aria-label="Physical Memory"><!---->Physical Memory<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/12-virtual-memory" aria-label="Virtual Memory"><!---->Virtual Memory<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/13-higher-half-kernel" aria-label="Higher Half Kernel"><!---->Higher Half Kernel<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/14-memory-segments" aria-label="Memory Segments"><!---->Memory Segments<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/15-interrupts" aria-label="Interrupts"><!---->Interrupts<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/16-user-mode" aria-label="User Mode"><!---->User Mode<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/17-tss" aria-label="Task State Segment"><!---->Task State Segment<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/18-system-calls" aria-label="System Calls"><!---->System Calls<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/19-tasks" aria-label="Tasks"><!---->Tasks<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/20-position-independent-code" aria-label="Position Independent Code"><!---->Position Independent Code<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/21-elf-loader-p1" aria-label="ELF Loader (Part 1)"><!---->ELF Loader (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/22-elf-loader-p2" aria-label="ELF Loader (Part 2)"><!---->ELF Loader (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/23-coop-multitasking" aria-label="Cooperative Multitasking"><!---->Cooperative Multitasking<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/24-system-library" aria-label="System Library"><!---->System Library<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/25-interrupt-controller" aria-label="Interrupt Controller"><!---->Interrupt Controller<!----></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="loading-the-kernel-part-1" tabindex="-1"><a class="header-anchor" href="#loading-the-kernel-part-1"><span>Loading the Kernel (Part 1)</span></a></h1><p>In the last section we built a raw binary kernel image. We&#39;ll pick up where we left off in the bootloader and load the kernel image into memory. We&#39;ll rely on UEFI Boot Services to do so.</p><h2 id="uefi-boot-services" tabindex="-1"><a class="header-anchor" href="#uefi-boot-services"><span>UEFI Boot Services</span></a></h2><p>UEFI Boot Services provides a number of services to help us, including accessing the file system, getting information about a file, allocating memory, and reading a file into memory. Here&#39;s the plan:</p><ul><li>Use the bootloader image <code>EfiHandle</code> (which is passed to the entry point) to get its <code>EfiLoadedImageProtocol</code>.</li><li>Use the <code>EfiLoadedImageProtocol</code> device handle to get the <code>EfiSimpleFileSystemProtocol</code> of that device.</li><li>Use the <code>EfiSimpleFileSystemProtocol</code> to get the <code>EfiFileSystemInfo</code> representing the root directory of the file system.</li><li>Use the <code>EfiSimpleFileSystemProtocol</code> and the kernel image path on the file system to get the <code>EfiFileProtocol</code> of the kernel file.</li><li>Use the <code>EfiFileProtocol</code> to get the <code>EfiFileInfo</code> of the kernel file, which contains the size of the file.</li><li>Use the Boot Services <code>AllocatePages</code> function to allocate enough pages, starting at address <code>0x100000</code> (1 MiB), to hold the kernel image.</li><li>Use <code>AllocatePages</code> to allocate a region for the kernel stack.</li><li>Use the <code>EfiFileProtocol</code> function to read the kernel image into memory.</li></ul><p>After reading the kernel into memory, and before jumping to it, we&#39;ll need to call the Boot Services <code>ExitBootServices</code> function to signal to the UEFI firmware that we&#39;re done with the Boot Services. To do so, we&#39;re required to also call the <code>GetMemoryMap</code> function to get the memory map, which contains a key that we&#39;ll pass to <code>ExitBootServices</code>. We&#39;ll also eventually pass this memory map to the kernel. So in addition to the plan above, we&#39;ll also:</p><ul><li>Use the Boot Services <code>GetMemoryMap</code> function to get the memory map.</li><li>Use the Boot Services <code>ExitBootServices</code> function, passing it the memory map key.</li><li>Jump to the kernel image starting address.</li></ul><p>This is a lot to take in, but this is how the UEFI spec was designed ¯\<em>(ツ)</em>/¯. We&#39;ll take it one step at a time.</p><h2 id="boot-device-handle" tabindex="-1"><a class="header-anchor" href="#boot-device-handle"><span>Boot device handle</span></a></h2><p>Since we plan on storing the kernel image on the same device as the bootloader, we want to access the file system of the device from which the bootloader was loaded. The <code>EfiLoadedImageProtocol</code> (which we can get through the bootloader image handle) has a <code>DeviceHandle</code> field that we can use to get the <code>EfiSimpleFileSystemProtocol</code> of that device. So let&#39;s define the <code>EfiLoadedImageProtocol</code> in <code>src/common/uefi.nim</code>.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/common/uefi.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line">  EfiLoadedImageProtocol<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    revision<span class="token operator">*:</span> uint32</span>
<span class="line">    parentHandle<span class="token operator">*:</span> EfiHandle</span>
<span class="line">    systemTable<span class="token operator">*:</span> <span class="token keyword">ptr</span> EfiSystemTable</span>
<span class="line">    <span class="token comment"># Source location of the image</span></span>
<span class="line highlighted">    deviceHandle<span class="token operator">*:</span> EfiHandle</span>
<span class="line">    filePath<span class="token operator">*:</span> pointer</span>
<span class="line">    reserved<span class="token operator">*:</span> pointer</span>
<span class="line">    <span class="token comment"># Image&#39;s load options</span></span>
<span class="line">    loadOptionsSize<span class="token operator">*:</span> uint32</span>
<span class="line">    loadOptions<span class="token operator">*:</span> pointer</span>
<span class="line">    <span class="token comment"># Location where image was loaded</span></span>
<span class="line">    imageBase<span class="token operator">*:</span> pointer</span>
<span class="line">    imageSize<span class="token operator">*:</span> uint64</span>
<span class="line">    imageCodeType<span class="token operator">*:</span> EfiMemoryType</span>
<span class="line">    imageDataType<span class="token operator">*:</span> EfiMemoryType</span>
<span class="line">    unload<span class="token operator">*:</span> pointer</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The <code>EfiMemoryType</code> defines the various types of memory in the system. At some point, we&#39;ll need to allocate memory for the kernel (code, data, and stack), so we&#39;ll need to differentiate between these types of memory. The UEFI spec doesn&#39;t define kernel memory types, so we&#39;ll add a few more custom types to the enum, which fall in the range of OSV (Operating System Vendor) defined memory types (<code>0x80000000</code> to <code>0xFFFFFFFF</code>).</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line">  EfiMemoryType<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">enum</span></span>
<span class="line">    EfiReservedMemory</span>
<span class="line">    EfiLoaderCode</span>
<span class="line">    EfiLoaderData</span>
<span class="line">    EfiBootServicesCode</span>
<span class="line">    EfiBootServicesData</span>
<span class="line">    EfiRuntimeServicesCode</span>
<span class="line">    EfiRuntimeServicesData</span>
<span class="line">    EfiConventionalMemory</span>
<span class="line">    EfiUnusableMemory</span>
<span class="line">    EfiACPIReclaimMemory</span>
<span class="line">    EfiACPIMemoryNVS</span>
<span class="line">    EfiMemoryMappedIO</span>
<span class="line">    EfiMemoryMappedIOPortSpace</span>
<span class="line">    EfiPalCode</span>
<span class="line">    EfiPersistentMemory</span>
<span class="line">    EfiUnacceptedMemory</span>
<span class="line">    OsvKernelCode <span class="token operator">=</span> <span class="token number">0x80000000</span></span>
<span class="line">    OsvKernelData <span class="token operator">=</span> <span class="token number">0x80000001</span></span>
<span class="line">    OsvKernelStack <span class="token operator">=</span> <span class="token number">0x80000002</span></span>
<span class="line">    EfiMaxMemoryType</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>To get the <code>EfiLoadedImageProtocol</code> from the bootloader image handle, we&#39;ll use the <code>handleProtocol</code> function of the Boot Services. So let&#39;s define the <code>BootServices</code> type and the <code>handleProtocol</code> function in <code>src/common/uefi.nim</code>. It&#39;s a large type with many functions, so I won&#39;t define the type of every field; we&#39;ll use <code>pointer</code> for those fields until we need to use them.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/common/uefi.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  EfiBootServices<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    hdr<span class="token operator">*:</span> EfiTableHeader</span>
<span class="line">    <span class="token comment"># task priority services</span></span>
<span class="line">    raiseTpl<span class="token operator">*:</span> pointer</span>
<span class="line">    restoreTpl<span class="token operator">*:</span> pointer</span>
<span class="line">    <span class="token comment"># memory services</span></span>
<span class="line">    allocatePages<span class="token operator">*:</span> pointer</span>
<span class="line">    freePages<span class="token operator">*:</span> pointer</span>
<span class="line">    getMemoryMap<span class="token operator">*:</span> pointer</span>
<span class="line">    allocatePool<span class="token operator">*:</span> pointer</span>
<span class="line">    freePool<span class="token operator">*:</span> pointer</span>
<span class="line">    <span class="token comment"># event &amp; timer services</span></span>
<span class="line">    createEvent<span class="token operator">*:</span> pointer</span>
<span class="line">    setTimer<span class="token operator">*:</span> pointer</span>
<span class="line">    waitForEvent<span class="token operator">*:</span> pointer</span>
<span class="line">    signalEvent<span class="token operator">*:</span> pointer</span>
<span class="line">    closeEvent<span class="token operator">*:</span> pointer</span>
<span class="line">    checkEvent<span class="token operator">*:</span> pointer</span>
<span class="line">    <span class="token comment"># protocol handler services</span></span>
<span class="line">    installProtocolInterface<span class="token operator">*:</span> pointer</span>
<span class="line">    reinstallProtocolInterface<span class="token operator">*:</span> pointer</span>
<span class="line">    uninstallProtocolInterface<span class="token operator">*:</span> pointer</span>
<span class="line">    handleProtocol<span class="token operator">*:</span> <span class="token function">proc</span> <span class="token punctuation">(</span>handle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> protocol<span class="token operator">:</span> EfiGuid<span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>interface<span class="token punctuation">`</span></span><span class="token operator">:</span> <span class="token keyword">ptr</span> pointer<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token punctuation">{.</span>cdecl<span class="token punctuation">.}</span></span>
<span class="line">    reserved<span class="token operator">*:</span> pointer</span>
<span class="line">    registerProtocolNotify<span class="token operator">*:</span> pointer</span>
<span class="line">    locateHandle<span class="token operator">*:</span> pointer</span>
<span class="line">    locateDevicePath<span class="token operator">*:</span> pointer</span>
<span class="line">    installConfigurationTable<span class="token operator">*:</span> pointer</span>
<span class="line">    <span class="token comment"># image services</span></span>
<span class="line">    loadImage<span class="token operator">*:</span> pointer</span>
<span class="line">    startImage<span class="token operator">*:</span> pointer</span>
<span class="line">    exit<span class="token operator">*:</span> pointer</span>
<span class="line">    unloadImage<span class="token operator">*:</span> pointer</span>
<span class="line">    exitBootServices<span class="token operator">*:</span> pointer</span>
<span class="line">    <span class="token comment"># misc services</span></span>
<span class="line">    getNextMonotonicCount<span class="token operator">*:</span> pointer</span>
<span class="line">    stall<span class="token operator">*:</span> pointer</span>
<span class="line">    setWatchdogTimer<span class="token operator">*:</span> pointer</span>
<span class="line">    <span class="token comment"># driver support services</span></span>
<span class="line">    connectController<span class="token operator">*:</span> pointer</span>
<span class="line">    disconnectController<span class="token operator">*:</span> pointer</span>
<span class="line">    <span class="token comment"># open and close protocol services</span></span>
<span class="line">    openProtocol<span class="token operator">*:</span> pointer</span>
<span class="line">    closeProtocol<span class="token operator">*:</span> pointer</span>
<span class="line">    openProtocolInformation<span class="token operator">*:</span> pointer</span>
<span class="line">    <span class="token comment"># library services</span></span>
<span class="line">    protocolsPerHandle<span class="token operator">*:</span> pointer</span>
<span class="line">    locateHandleBuffer<span class="token operator">*:</span> pointer</span>
<span class="line">    locateProtocol<span class="token operator">*:</span> pointer</span>
<span class="line">    installMultipleProtocolInterfaces<span class="token operator">*:</span> pointer</span>
<span class="line">    uninstallMultipleProtocolInterfaces<span class="token operator">*:</span> pointer</span>
<span class="line">    <span class="token comment"># 32-bit CRC services</span></span>
<span class="line">    calculateCrc32<span class="token operator">*:</span> pointer</span>
<span class="line">    <span class="token comment"># misc services</span></span>
<span class="line">    copyMem<span class="token operator">*:</span> pointer</span>
<span class="line">    setMem<span class="token operator">*:</span> pointer</span>
<span class="line">    createEventEx<span class="token operator">*:</span> pointer</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>One of the parameters of the <code>handleProtocol</code> function is of type <code>EfiGuid</code>. Let&#39;s define it as well.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token keyword">type</span></span>
<span class="line">  EfiGuid<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    data1<span class="token operator">:</span> uint32</span>
<span class="line">    data2<span class="token operator">:</span> uint16</span>
<span class="line">    data3<span class="token operator">:</span> uint16</span>
<span class="line">    data4<span class="token operator">:</span> array<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> uint8<span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We&#39;re interested in the <code>EfiLoadedImageProtocol</code>, so we need to define its GUID.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token keyword">const</span></span>
<span class="line">  EfiLoadedImageProtocolGuid<span class="token operator">*</span> <span class="token operator">=</span> <span class="token function">EfiGuid</span><span class="token punctuation">(</span></span>
<span class="line">    data1<span class="token operator">:</span> <span class="token number">0x5B1B31A1</span><span class="token punctuation">,</span> data2<span class="token operator">:</span> <span class="token number">0x9562</span><span class="token punctuation">,</span> data3<span class="token operator">:</span> <span class="token number">0x11d2</span><span class="token punctuation">,</span></span>
<span class="line">    data4<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0x8e</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xa0</span><span class="token punctuation">,</span> <span class="token number">0xc9</span><span class="token punctuation">,</span> <span class="token number">0x69</span><span class="token punctuation">,</span> <span class="token number">0x72</span><span class="token punctuation">,</span> <span class="token number">0x3b</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now we&#39;re ready to call the <code>handleProtocol</code> function to get the <code>EfiLoadedImageProtocol</code> from the bootloader image handle.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/boot/bootx64.nim</span></span>
<span class="line"></span>
<span class="line highlighted"><span class="token keyword">import</span> common<span class="token operator">/</span>uefi</span>
<span class="line"><span class="token operator">...</span></span>
<span class="line"></span>
<span class="line highlighted"><span class="token keyword">proc</span> <span class="token function">checkStatus<span class="token operator">*</span></span><span class="token punctuation">(</span>status<span class="token operator">:</span> EfiStatus<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line highlighted">  <span class="token keyword">if</span> status <span class="token operator">!=</span> EfiSuccess<span class="token operator">:</span></span>
<span class="line highlighted">    consoleOut <span class="token operator">&amp;</span><span class="token string">&quot; [failed, status = {status:#x}]&quot;</span></span>
<span class="line highlighted">    <span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line highlighted">  consoleOut <span class="token string">&quot; [success]\r\n&quot;</span></span>
<span class="line highlighted"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">EfiMainInner</span><span class="token punctuation">(</span>imgHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> sysTable<span class="token operator">:</span> <span class="token keyword">ptr</span> EFiSystemTable<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token operator">=</span></span>
<span class="line highlighted">  echo <span class="token string">&quot;Fusion OS Bootloader&quot;</span></span>
<span class="line highlighted"></span>
<span class="line highlighted">  <span class="token keyword">var</span> status<span class="token operator">:</span> EfiStatus</span>
<span class="line highlighted"></span>
<span class="line highlighted">  <span class="token comment"># get the LoadedImage protocol from the image handle</span></span>
<span class="line highlighted">  <span class="token keyword">var</span> loadedImage<span class="token operator">:</span> <span class="token keyword">ptr</span> EfiLoadedImageProtocol</span>
<span class="line highlighted"></span>
<span class="line highlighted">  consoleOut <span class="token string">&quot;boot: Acquiring LoadedImage protocol&quot;</span></span>
<span class="line highlighted">  checkStatus uefi<span class="token operator">.</span>sysTable<span class="token operator">.</span>bootServices<span class="token operator">.</span><span class="token function">handleProtocol</span><span class="token punctuation">(</span></span>
<span class="line highlighted">    imgHandle<span class="token punctuation">,</span> EfiLoadedImageProtocolGuid<span class="token punctuation">,</span> <span class="token function">cast[ptr pointer]</span><span class="token punctuation">(</span><span class="token keyword">addr</span> loadedImage<span class="token punctuation">)</span></span>
<span class="line highlighted">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Let&#39;s compile and run everything using <code>just run</code>. We should see the following output (The colored output is for nice visuals only. I didn&#39;t show it in the code above; I&#39;m leaving it as an exercise for the reader):</p><p><img src="/assets/boot-loadedimage-CgOQRvkZ.png" alt="Boot - LoadedImage"></p><h2 id="file-system" tabindex="-1"><a class="header-anchor" href="#file-system"><span>File system</span></a></h2><p>Now that we have the <code>EfiLoadedImageProtocol</code> device handle, we can get the <code>EfiSimpleFileSystemProtocol</code> of that device. Let&#39;s define the <code>EfiSimpleFileSystemProtocol</code> type and the corresponding GUID in <code>src/common/uefi.nim</code>.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/common/uefi.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  EfiSimpleFileSystemProtocol<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    revision<span class="token operator">*:</span> uint64</span>
<span class="line">    openVolume<span class="token operator">*:</span> pointer</span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span></span>
<span class="line">  EfiSimpleFileSystemProtocolGuid<span class="token operator">*</span> <span class="token operator">=</span> <span class="token function">EfiGuid</span><span class="token punctuation">(</span></span>
<span class="line">    data1<span class="token operator">:</span> <span class="token number">0x964e5b22&#39;u32</span><span class="token punctuation">,</span> data2<span class="token operator">:</span> <span class="token number">0x6459</span><span class="token punctuation">,</span> data3<span class="token operator">:</span> <span class="token number">0x11d2</span><span class="token punctuation">,</span></span>
<span class="line">    data4<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0x8e</span><span class="token punctuation">,</span> <span class="token number">0x39</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xa0</span><span class="token punctuation">,</span> <span class="token number">0xc9</span><span class="token punctuation">,</span> <span class="token number">0x69</span><span class="token punctuation">,</span> <span class="token number">0x72</span><span class="token punctuation">,</span> <span class="token number">0x3b</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now we&#39;re ready to get the <code>EfiSimpleFileSystemProtocol</code> from the <code>EfiLoadedImageProtocol</code> device handle.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token keyword">proc</span> <span class="token function">EfiMainInner</span><span class="token punctuation">(</span>imgHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> sysTable<span class="token operator">:</span> <span class="token keyword">ptr</span> EFiSystemTable<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line highlighted">  <span class="token comment"># get the FileSystem protocol from the device handle</span></span>
<span class="line highlighted">  <span class="token keyword">var</span> fileSystem<span class="token operator">:</span> <span class="token keyword">ptr</span> EfiSimpleFileSystemProtocol</span>
<span class="line highlighted"></span>
<span class="line highlighted">  consoleOut <span class="token string">&quot;boot: Acquiring SimpleFileSystem protocol&quot;</span></span>
<span class="line highlighted">  checkStatus uefi<span class="token operator">.</span>sysTable<span class="token operator">.</span>bootServices<span class="token operator">.</span><span class="token function">handleProtocol</span><span class="token punctuation">(</span></span>
<span class="line highlighted">    loadedImage<span class="token operator">.</span>deviceHandle<span class="token punctuation">,</span> EfiSimpleFileSystemProtocolGuid<span class="token punctuation">,</span> <span class="token function">cast[ptr pointer]</span><span class="token punctuation">(</span><span class="token keyword">addr</span> fileSystem<span class="token punctuation">)</span></span>
<span class="line highlighted">  <span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>If we compile and run we should see the following output:</p><p><img src="/assets/boot-simplefilesystem-CXb1hauC.png" alt="Alt text"></p><h2 id="root-directory" tabindex="-1"><a class="header-anchor" href="#root-directory"><span>Root directory</span></a></h2><p>Next, we need to get the <code>EfiFileInfo</code> representing the root directory of the file system. Let&#39;s define the <code>EfiFileInfo</code> type (we also need to define the <code>EfiTime</code> type, which is used in <code>EfiFileInfo</code>) .</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/common/uefi.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  EfiFileInfo<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    size<span class="token operator">*:</span> uint64</span>
<span class="line">    fileSize<span class="token operator">*:</span> uint64</span>
<span class="line">    physicalSize<span class="token operator">*:</span> uint64</span>
<span class="line">    createTime<span class="token operator">*:</span> EfiTime</span>
<span class="line">    lastAccessTime<span class="token operator">*:</span> EfiTime</span>
<span class="line">    modificationTime<span class="token operator">*:</span> EfiTime</span>
<span class="line">    attribute<span class="token operator">*:</span> uint64</span>
<span class="line">    fileName<span class="token operator">*:</span> array<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> Utf16Char<span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">  EfiTime<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    year<span class="token operator">*:</span> uint16</span>
<span class="line">    month<span class="token operator">*:</span> uint8</span>
<span class="line">    day<span class="token operator">*:</span> uint8</span>
<span class="line">    hour<span class="token operator">*:</span> uint8</span>
<span class="line">    minute<span class="token operator">*:</span> uint8</span>
<span class="line">    second<span class="token operator">*:</span> uint8</span>
<span class="line">    pad1<span class="token operator">*:</span> uint8</span>
<span class="line">    nanosecond<span class="token operator">*:</span> uint32</span>
<span class="line">    timeZone<span class="token operator">*:</span> int16</span>
<span class="line">    daylight<span class="token operator">*:</span> uint8</span>
<span class="line">    pad2<span class="token operator">*:</span> uint8</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The <code>fileName</code> field in the UEFI spec is a C <a href="https://en.wikipedia.org/wiki/Flexible_array_member" target="_blank" rel="noopener noreferrer">flexible array member</a>, which is not supported in Nim. So I&#39;m using a fixed size array here.</p><p>Let&#39;s use the <code>openVolume</code> function of the <code>EfiSimpleFileSystemProtocol</code> to get the <code>EfiFileInfo</code> of the root directory. First, we need to update the signature of <code>openVolume</code>, which also requires defining the <code>EfiFileProtocol</code> type.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/common/uefi.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  EfiSimpleFileSystemProtocol<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    revision<span class="token operator">*:</span> uint64</span>
<span class="line highlighted">    openVolume<span class="token operator">*:</span> <span class="token function">proc</span> <span class="token punctuation">(</span>this<span class="token operator">:</span> <span class="token keyword">ptr</span> EfiSimpleFileSystemProtocol<span class="token punctuation">,</span> root<span class="token operator">:</span> <span class="token keyword">ptr</span> <span class="token keyword">ptr</span> EfiFileProtocol<span class="token punctuation">)</span><span class="token operator">:</span></span>
<span class="line highlighted">      EfiStatus <span class="token punctuation">{.</span>cdecl<span class="token punctuation">.}</span></span>
<span class="line highlighted"></span>
<span class="line highlighted">  EfiFileProtocol<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line highlighted">    revision<span class="token operator">*:</span> uint64</span>
<span class="line highlighted">    open<span class="token operator">*:</span> pointer</span>
<span class="line highlighted">    close<span class="token operator">*:</span> pointer</span>
<span class="line highlighted">    delete<span class="token operator">*:</span> pointer</span>
<span class="line highlighted">    read<span class="token operator">*:</span> pointer</span>
<span class="line highlighted">    write<span class="token operator">*:</span> pointer</span>
<span class="line highlighted">    getPosition<span class="token operator">*:</span> pointer</span>
<span class="line highlighted">    setPosition<span class="token operator">*:</span> pointer</span>
<span class="line highlighted">    getInfo<span class="token operator">*:</span> pointer</span>
<span class="line highlighted">    setInfo<span class="token operator">*:</span> pointer</span>
<span class="line highlighted">    flush<span class="token operator">*:</span> pointer</span>
<span class="line highlighted">    openEx<span class="token operator">*:</span> pointer</span>
<span class="line highlighted">    readEx<span class="token operator">*:</span> pointer</span>
<span class="line highlighted">    writeEx<span class="token operator">*:</span> pointer</span>
<span class="line highlighted">    flushEx<span class="token operator">*:</span> pointer</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now we&#39;re ready to get the <code>EfiFileInfo</code> of the root directory.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/boot/bootx64.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">EfiMainInner</span><span class="token punctuation">(</span>imgHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> sysTable<span class="token operator">:</span> <span class="token keyword">ptr</span> EFiSystemTable<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line highlighted">  <span class="token comment"># open the root directory</span></span>
<span class="line highlighted">  <span class="token keyword">var</span> rootDir<span class="token operator">:</span> <span class="token keyword">ptr</span> EfiFileProtocol</span>
<span class="line highlighted"></span>
<span class="line highlighted">  consoleOut <span class="token string">&quot;boot: Opening root directory&quot;</span></span>
<span class="line highlighted">  checkStatus fileSystem<span class="token operator">.</span><span class="token function">openVolume</span><span class="token punctuation">(</span>fileSystem<span class="token punctuation">,</span> <span class="token keyword">addr</span> rootDir<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This should also compile and run successfully.</p><h2 id="kernel-image-file" tabindex="-1"><a class="header-anchor" href="#kernel-image-file"><span>Kernel image file</span></a></h2><p>We have the <code>EfiFileProtocol</code> of the root directory, so we can use it to get the <code>EfiFileProtocol</code> of the kernel image file, given its path. To open the kernel file, we&#39;ll need to define the <code>open</code> function of the <code>EfiFileProtocol</code>.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/common/uefi.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  EfiFileProtocol<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    revision<span class="token operator">*:</span> uint64</span>
<span class="line highlighted">    open<span class="token operator">*:</span> <span class="token function">proc</span> <span class="token punctuation">(</span></span>
<span class="line highlighted">        this<span class="token operator">:</span> <span class="token keyword">ptr</span> EfiFileProtocol<span class="token punctuation">,</span></span>
<span class="line highlighted">        newHandle<span class="token operator">:</span> <span class="token keyword">ptr</span> <span class="token keyword">ptr</span> EfiFileProtocol<span class="token punctuation">,</span></span>
<span class="line highlighted">        fileName<span class="token operator">:</span> WideCString<span class="token punctuation">,</span></span>
<span class="line highlighted">        openMode<span class="token operator">:</span> uint64<span class="token punctuation">,</span></span>
<span class="line highlighted">        attributes<span class="token operator">:</span> uint64</span>
<span class="line highlighted">      <span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token punctuation">{.</span>cdecl<span class="token punctuation">.}</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now we&#39;re ready to open the kernel file.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/boot/bootx64.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">EfiMainInner</span><span class="token punctuation">(</span>imgHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> sysTable<span class="token operator">:</span> <span class="token keyword">ptr</span> EFiSystemTable<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line highlighted">  <span class="token comment"># open the kernel file</span></span>
<span class="line highlighted">  <span class="token keyword">var</span> kernelFile<span class="token operator">:</span> <span class="token keyword">ptr</span> EfiFileProtocol</span>
<span class="line highlighted">  <span class="token keyword">let</span> kernelPath <span class="token operator">=</span> <span class="token string">W&quot;efi\fusion\kernel.bin&quot;</span></span>
<span class="line highlighted"></span>
<span class="line highlighted">  consoleOut <span class="token string">&quot;boot: Opening kernel file: &quot;</span></span>
<span class="line highlighted">  consoleOut kernelPath</span>
<span class="line highlighted">  checkStatus rootDir<span class="token operator">.</span><span class="token function">open</span><span class="token punctuation">(</span>rootDir<span class="token punctuation">,</span> <span class="token keyword">addr</span> kernelFile<span class="token punctuation">,</span> kernelPath<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This should also compile and run successfully.</p><p><img src="/assets/boot-openkernelfile-BCIAOz9r.png" alt="Boot - Open kernel file"></p><p>Let&#39;s now get the size of the kernel file. To do so, we&#39;ll need to define the <code>getInfo</code> function of the <code>EfiFileProtocol</code>. We&#39;ll also need to define <code>EfiFileInfoGuid</code>.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/common/uefi.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  EfiFileProtocol<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">    <span class="token operator">...</span></span>
<span class="line highlighted">    getInfo<span class="token operator">*:</span> <span class="token function">proc</span> <span class="token punctuation">(</span></span>
<span class="line highlighted">        this<span class="token operator">:</span> <span class="token keyword">ptr</span> EfiFileProtocol<span class="token punctuation">,</span></span>
<span class="line highlighted">        infoType<span class="token operator">:</span> <span class="token keyword">ptr</span> EfiGuid<span class="token punctuation">,</span></span>
<span class="line highlighted">        infoSize<span class="token operator">:</span> <span class="token keyword">ptr</span> uint<span class="token punctuation">,</span></span>
<span class="line highlighted">        info<span class="token operator">:</span> pointer</span>
<span class="line highlighted">      <span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token punctuation">{.</span>cdecl<span class="token punctuation">.}</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span></span>
<span class="line highlighted">  EfiFileInfoGuid<span class="token operator">*</span> <span class="token operator">=</span> <span class="token function">EfiGuid</span><span class="token punctuation">(</span></span>
<span class="line highlighted">    data1<span class="token operator">:</span> <span class="token number">0x09576e92&#39;u32</span><span class="token punctuation">,</span> data2<span class="token operator">:</span> <span class="token number">0x6d3f</span><span class="token punctuation">,</span> data3<span class="token operator">:</span> <span class="token number">0x11d2</span><span class="token punctuation">,</span></span>
<span class="line highlighted">    data4<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0x8e</span><span class="token punctuation">,</span> <span class="token number">0x39</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xa0</span><span class="token punctuation">,</span> <span class="token number">0xc9</span><span class="token punctuation">,</span> <span class="token number">0x69</span><span class="token punctuation">,</span> <span class="token number">0x72</span><span class="token punctuation">,</span> <span class="token number">0x3b</span><span class="token punctuation">]</span></span>
<span class="line highlighted">  <span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Let&#39;s call the <code>getInfo</code> function on the kernel file.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/boot/bootx64.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">EfiMainInner</span><span class="token punctuation">(</span>imgHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> sysTable<span class="token operator">:</span> <span class="token keyword">ptr</span> EFiSystemTable<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line highlighted">  <span class="token comment"># get kernel file size</span></span>
<span class="line highlighted">  <span class="token keyword">var</span> kernelInfo<span class="token operator">:</span> EfiFileInfo</span>
<span class="line highlighted">  <span class="token keyword">var</span> kernelInfoSize <span class="token operator">=</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>EfiFileInfo<span class="token punctuation">)</span><span class="token operator">.</span>uint</span>
<span class="line highlighted"></span>
<span class="line highlighted">  consoleOut <span class="token string">&quot;boot: Getting kernel file info&quot;</span></span>
<span class="line highlighted">  checkStatus kernelFile<span class="token operator">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span>kernelFile<span class="token punctuation">,</span> <span class="token keyword">addr</span> EfiFileInfoGuid<span class="token punctuation">,</span> <span class="token keyword">addr</span> kernelInfoSize<span class="token punctuation">,</span> <span class="token keyword">addr</span> kernelInfo<span class="token punctuation">)</span></span>
<span class="line highlighted">  echo <span class="token operator">&amp;</span><span class="token string">&quot;boot: Kernel file size: {kernelInfo.fileSize} bytes&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>If all goes well, we should see the kernel file size in the output:</p><p><img src="/assets/boot-kernelfilesize-LMZUay_C.png" alt="Boot - Kernel file size"></p><p>Great! The kernel image size is what we expect (around 1.1 MiB). In the next section we&#39;ll continue to allocate memory for the kernel image and read it into memory.</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/osdev/07-kernel-image" aria-label="Kernel Image"><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span>Kernel Image</span></div></a><a class="route-link auto-link next" href="/osdev/09-loading-the-kernel-p2" aria-label="Loading the Kernel (Part 2)"><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span>Loading the Kernel (Part 2)</span></div></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BEnvQN0t.js" defer></script>
  </body>
</html>
