<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.15" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #22272e;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>UEFI Bootloader (Part 2) | Khaled Hammouda</title><meta name="description" content="Building a 64-bit operating system from scratch in Nim">
    <link rel="preload" href="/assets/style-DFReAQZD.css" as="style"><link rel="stylesheet" href="/assets/style-DFReAQZD.css">
    <link rel="modulepreload" href="/assets/app-BEnvQN0t.js"><link rel="modulepreload" href="/assets/06-bootloader-p2.html-lTW7xvyF.js">
    <link rel="prefetch" href="/assets/index.html-DN4baEjd.js" as="script"><link rel="prefetch" href="/assets/index.html-DTcVMSat.js" as="script"><link rel="prefetch" href="/assets/01-mm.html-DdVm3GHI.js" as="script"><link rel="prefetch" href="/assets/index.html-D8_cVHQe.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-Bq4FSDwn.js" as="script"><link rel="prefetch" href="/assets/02-setup.html-9f0UzP9I.js" as="script"><link rel="prefetch" href="/assets/03-filetype.html-DVtyN252.js" as="script"><link rel="prefetch" href="/assets/04-lexer.html-OooGwppm.js" as="script"><link rel="prefetch" href="/assets/05-parser.html-Dw5HPOU5.js" as="script"><link rel="prefetch" href="/assets/06-parser-p2.html-CHLJtldD.js" as="script"><link rel="prefetch" href="/assets/07-grammarkit.html-DALOmYeT.js" as="script"><link rel="prefetch" href="/assets/08-go-to-decl.html-DPftLCwO.js" as="script"><link rel="prefetch" href="/assets/09-scopes.html-BhA3Jfl5.js" as="script"><link rel="prefetch" href="/assets/10-rename-refactoring.html-CQ7xy6Op.js" as="script"><link rel="prefetch" href="/assets/11-indentation.html-BSbVKVoe.js" as="script"><link rel="prefetch" href="/assets/12-decl-sections.html-DM3D0T_j.js" as="script"><link rel="prefetch" href="/assets/13-comments.html-PACjUQ8Q.js" as="script"><link rel="prefetch" href="/assets/14-numeric-lit.html-Bx-wwqk6.js" as="script"><link rel="prefetch" href="/assets/15-expressions.html-26eNyM4d.js" as="script"><link rel="prefetch" href="/assets/99-tmp.html-gvMZWEF9.js" as="script"><link rel="prefetch" href="/assets/index.html-J4FG-UC7.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-BeNfzmF-.js" as="script"><link rel="prefetch" href="/assets/02-environment-setup.html-C8XAFCUU.js" as="script"><link rel="prefetch" href="/assets/03-targeting-uefi-p1.html-C9weobAl.js" as="script"><link rel="prefetch" href="/assets/04-targeting-uefi-p2.html-DtpCSkF_.js" as="script"><link rel="prefetch" href="/assets/05-bootloader-p1.html-nF5TI7gq.js" as="script"><link rel="prefetch" href="/assets/07-kernel-image.html-Dbec7FcX.js" as="script"><link rel="prefetch" href="/assets/08-loading-the-kernel-p1.html-CgEWrWCh.js" as="script"><link rel="prefetch" href="/assets/09-loading-the-kernel-p2.html-Bsyq9hJE.js" as="script"><link rel="prefetch" href="/assets/10-loading-the-kernel-p3.html-Cz6f791z.js" as="script"><link rel="prefetch" href="/assets/11-physical-memory.html-Iko_lfyH.js" as="script"><link rel="prefetch" href="/assets/12-virtual-memory.html-BdHdqaeH.js" as="script"><link rel="prefetch" href="/assets/13-higher-half-kernel.html-U7sLCIG_.js" as="script"><link rel="prefetch" href="/assets/14-memory-segments.html-C0Wfonfg.js" as="script"><link rel="prefetch" href="/assets/15-interrupts.html-CuXOHXlP.js" as="script"><link rel="prefetch" href="/assets/16-user-mode.html-DI-QEaJn.js" as="script"><link rel="prefetch" href="/assets/17-tss.html-DedksTv0.js" as="script"><link rel="prefetch" href="/assets/18-system-calls.html-CANG8AhC.js" as="script"><link rel="prefetch" href="/assets/19-tasks.html-D_KA9R1n.js" as="script"><link rel="prefetch" href="/assets/20-position-independent-code.html-DcxhRHAD.js" as="script"><link rel="prefetch" href="/assets/21-elf-loader-p1.html-hRqOVejE.js" as="script"><link rel="prefetch" href="/assets/22-elf-loader-p2.html-CwKLac9X.js" as="script"><link rel="prefetch" href="/assets/23-coop-multitasking.html-CmjVNMNt.js" as="script"><link rel="prefetch" href="/assets/24-system-library.html-Chl8ifRh.js" as="script"><link rel="prefetch" href="/assets/25-interrupt-controller.html-i_QNpPOS.js" as="script"><link rel="prefetch" href="/assets/index.html--jTsfqNO.js" as="script"><link rel="prefetch" href="/assets/404.html-CYnd4SKg.js" as="script"><link rel="prefetch" href="/assets/SearchResult-ZUCfC4Sv.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">Khaled Hammouda</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading active" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a><ul class="vp-sidebar-children" style=""><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/01-intro" aria-label="Writing an OS in Nim"><!---->Writing an OS in Nim<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/02-environment-setup" aria-label="Environment Setup"><!---->Environment Setup<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/03-targeting-uefi-p1" aria-label="Targeting UEFI (Part 1)"><!---->Targeting UEFI (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/04-targeting-uefi-p2" aria-label="Targeting UEFI (Part 2)"><!---->Targeting UEFI (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/05-bootloader-p1" aria-label="UEFI Bootloader (Part 1)"><!---->UEFI Bootloader (Part 1)<!----></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/osdev/06-bootloader-p2" aria-label="UEFI Bootloader (Part 2)"><!---->UEFI Bootloader (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/07-kernel-image" aria-label="Kernel Image"><!---->Kernel Image<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/08-loading-the-kernel-p1" aria-label="Loading the Kernel (Part 1)"><!---->Loading the Kernel (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/09-loading-the-kernel-p2" aria-label="Loading the Kernel (Part 2)"><!---->Loading the Kernel (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/10-loading-the-kernel-p3" aria-label="Loading the Kernel (Part 3)"><!---->Loading the Kernel (Part 3)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/11-physical-memory" aria-label="Physical Memory"><!---->Physical Memory<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/12-virtual-memory" aria-label="Virtual Memory"><!---->Virtual Memory<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/13-higher-half-kernel" aria-label="Higher Half Kernel"><!---->Higher Half Kernel<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/14-memory-segments" aria-label="Memory Segments"><!---->Memory Segments<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/15-interrupts" aria-label="Interrupts"><!---->Interrupts<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/16-user-mode" aria-label="User Mode"><!---->User Mode<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/17-tss" aria-label="Task State Segment"><!---->Task State Segment<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/18-system-calls" aria-label="System Calls"><!---->System Calls<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/19-tasks" aria-label="Tasks"><!---->Tasks<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/20-position-independent-code" aria-label="Position Independent Code"><!---->Position Independent Code<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/21-elf-loader-p1" aria-label="ELF Loader (Part 1)"><!---->ELF Loader (Part 1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/22-elf-loader-p2" aria-label="ELF Loader (Part 2)"><!---->ELF Loader (Part 2)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/23-coop-multitasking" aria-label="Cooperative Multitasking"><!---->Cooperative Multitasking<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/24-system-library" aria-label="System Library"><!---->System Library<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/osdev/25-interrupt-controller" aria-label="Interrupt Controller"><!---->Interrupt Controller<!----></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="uefi-bootloader-part-2" tabindex="-1"><a class="header-anchor" href="#uefi-bootloader-part-2"><span>UEFI Bootloader (Part 2)</span></a></h1><p>In the previous section, we wrote a simple UEFI entry point for the bootloader. In this section, we&#39;ll use the UEFI API provided to us through the UEFI system table to print a simple message to the screen.</p><h2 id="uefi-system-table" tabindex="-1"><a class="header-anchor" href="#uefi-system-table"><span>UEFI System Table</span></a></h2><p>The UEFI system table is a data structure that is passed to the bootloader by the UEFI firmware. It contains pointers to various UEFI services, such as the console, file system, and memory management. We&#39;ll start by defining the system table in <code>src/bootx64.nim</code>:</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/bootx64.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  EfiStatus <span class="token operator">=</span> uint</span>
<span class="line"></span>
<span class="line">  EfiHandle <span class="token operator">=</span> pointer</span>
<span class="line"></span>
<span class="line highlighted">  EfiTableHeader <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line highlighted">    signature<span class="token operator">:</span> uint64</span>
<span class="line highlighted">    revision<span class="token operator">:</span> uint32</span>
<span class="line highlighted">    headerSize<span class="token operator">:</span> uint32</span>
<span class="line highlighted">    crc32<span class="token operator">:</span> uint32</span>
<span class="line highlighted">    reserved<span class="token operator">:</span> uint32</span>
<span class="line highlighted"></span>
<span class="line highlighted">  EfiSystemTable <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line highlighted">    header<span class="token operator">:</span> EfiTableHeader</span>
<span class="line highlighted">    firmwareVendor<span class="token operator">:</span> WideCString</span>
<span class="line highlighted">    firmwareRevision<span class="token operator">:</span> uint32</span>
<span class="line highlighted">    consoleInHandle<span class="token operator">:</span> EfiHandle</span>
<span class="line highlighted">    conIn<span class="token operator">:</span> pointer</span>
<span class="line highlighted">    consoleOutHandle<span class="token operator">:</span> EfiHandle</span>
<span class="line highlighted">    conOut<span class="token operator">:</span> <span class="token keyword">ptr</span> SimpleTextOutputProtocol</span>
<span class="line highlighted">    standardErrorHandle<span class="token operator">:</span> EfiHandle</span>
<span class="line highlighted">    stdErr<span class="token operator">:</span> SimpleTextOutputProtocol</span>
<span class="line highlighted">    runtimeServices<span class="token operator">:</span> pointer</span>
<span class="line highlighted">    bootServices<span class="token operator">:</span> pointer</span>
<span class="line highlighted">    numTableEntries<span class="token operator">:</span> uint</span>
<span class="line highlighted">    configTable<span class="token operator">:</span> pointer</span>
<span class="line highlighted">  </span>
<span class="line highlighted">  SimpleTextOutputProtocol <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line highlighted">    reset<span class="token operator">:</span> pointer</span>
<span class="line highlighted">    outputString<span class="token operator">:</span> <span class="token function">proc</span> <span class="token punctuation">(</span>this<span class="token operator">:</span> <span class="token keyword">ptr</span> SimpleTextOutputProtocol<span class="token punctuation">,</span> str<span class="token operator">:</span> WideCString<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token punctuation">{.</span>cdecl<span class="token punctuation">.}</span></span>
<span class="line highlighted">    testString<span class="token operator">:</span> pointer</span>
<span class="line highlighted">    queryMode<span class="token operator">:</span> pointer</span>
<span class="line highlighted">    setMode<span class="token operator">:</span> pointer</span>
<span class="line highlighted">    setAttribute<span class="token operator">:</span> pointer</span>
<span class="line highlighted">    clearScreen<span class="token operator">:</span> <span class="token function">proc</span> <span class="token punctuation">(</span>this<span class="token operator">:</span> <span class="token keyword">ptr</span> SimpleTextOutputProtocol<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token punctuation">{.</span>cdecl<span class="token punctuation">.}</span></span>
<span class="line highlighted">    setCursorPos<span class="token operator">:</span> pointer</span>
<span class="line highlighted">    enableCursor<span class="token operator">:</span> pointer</span>
<span class="line highlighted">    mode<span class="token operator">:</span> <span class="token keyword">ptr</span> pointer</span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span></span>
<span class="line">  EfiSuccess <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">  EfiLoadError <span class="token operator">=</span> <span class="token number">1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We&#39;re particularly interested in the <code>conOut</code> field, which is a pointer to the console output interface <code>SimpleTextOutputProtocol</code>. We&#39;ll use this to clear the screen (using the <code>clearScreen</code> function) and print to the screen (using the <code>outputString</code> function).</p><h2 id="printing-to-the-screen" tabindex="-1"><a class="header-anchor" href="#printing-to-the-screen"><span>Printing to the Screen</span></a></h2><p>Let&#39;s start by clearing the screen. To avoid returning to the UEFI shell, we&#39;ll call the <code>quit</code> function, which eventually calls the <code>exit</code> function we implemented earlier, which halts the CPU.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/bootx64.nim</span></span>
<span class="line"><span class="token operator">...</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">EfiMain</span><span class="token punctuation">(</span>imgHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> sysTable<span class="token operator">:</span> <span class="token keyword">ptr</span> EFiSystemTable<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token punctuation">{.</span>exportc<span class="token punctuation">.}</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token function">NimMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line highlighted">  <span class="token keyword">discard</span> sysTable<span class="token operator">.</span>conOut<span class="token operator">.</span><span class="token function">clearScreen</span><span class="token punctuation">(</span>sysTable<span class="token operator">.</span>conOut<span class="token punctuation">)</span></span>
<span class="line">  <span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>When we compile and load this in QEMU, we see a blank screen, as expected.</p><p>Next, let&#39;s print a simple message to the screen. We&#39;ll use the <code>outputString</code> function, which takes a pointer to a null-terminated UTF-16 string. Nim supports UTF-16 strings through the <code>Utf16Char</code> and <code>WideCString</code> types. Before we start using <code>WideCString</code>, I want to highlight a difference in how Nim declares this type in the presence of a <code>nimv2</code> flag. Without this flag, Nim defines <code>WideCString</code> as a <code>ref UncheckedArray[Utf16Char]</code>. With the <code>nimv2</code> flag, Nim defines <code>WideCString</code> as a <code>ptr UncheckedArray[Utf16Char]</code>.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># nim-2.0.0/lib/std/widestrs.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">when</span> <span class="token function">defined</span><span class="token punctuation">(</span>nimv2<span class="token punctuation">)</span><span class="token operator">:</span></span>
<span class="line">  <span class="token keyword">type</span></span>
<span class="line">    WideCString<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">ptr</span> UncheckedArray<span class="token punctuation">[</span>Utf16Char<span class="token punctuation">]</span></span>
<span class="line">    WideCStringObj<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span></span>
<span class="line">      bytes<span class="token operator">:</span> int</span>
<span class="line">      data<span class="token operator">:</span> WideCString</span>
<span class="line"> <span class="token operator">...</span></span>
<span class="line">    <span class="token keyword">converter</span> <span class="token function">toWideCString<span class="token operator">*</span></span><span class="token punctuation">(</span>x<span class="token operator">:</span> WideCStringObj<span class="token punctuation">)</span><span class="token operator">:</span> WideCString <span class="token punctuation">{.</span>inline<span class="token punctuation">.}</span> <span class="token operator">=</span></span>
<span class="line">      result <span class="token operator">=</span> x<span class="token operator">.</span>data</span>
<span class="line"></span>
<span class="line"><span class="token keyword">else</span><span class="token operator">:</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line">  <span class="token keyword">type</span></span>
<span class="line">    WideCString<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">ref</span> UncheckedArray<span class="token punctuation">[</span>Utf16Char<span class="token punctuation">]</span></span>
<span class="line">    WideCStringObj<span class="token operator">*</span> <span class="token operator">=</span> WideCString</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Since we&#39;re going to pass a pointer to a null-terminated UTF-16 string to <code>outputString</code>, we need to use the <code>ptr</code> version of <code>WideCString</code>. So let&#39;s add the <code>nimv2</code> flag to our <code>nim.cfg</code>:</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token comment"># nim.cfg</span></span>
<span class="line"><span class="token key attr-name">-d</span><span class="token punctuation">:</span><span class="token value attr-value">nimv2</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>We create a wide string using <code>newWideCString</code> (which returns a <code>WideCStringObj</code>), use the <code>toWideCString</code> converter to get access to the underlying data buffer, and then pass it to <code>outputString</code>.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/bootx64.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">EfiMain</span><span class="token punctuation">(</span>imgHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> sysTable<span class="token operator">:</span> <span class="token keyword">ptr</span> EFiSystemTable<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token punctuation">{.</span>exportc<span class="token punctuation">.}</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token function">NimMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line highlighted">  <span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token function">newWideCString</span><span class="token punctuation">(</span><span class="token string">&quot;Hello, world!\n&quot;</span><span class="token punctuation">)</span><span class="token operator">.</span>toWideCString</span>
<span class="line highlighted"></span>
<span class="line highlighted">  <span class="token keyword">discard</span> sysTable<span class="token operator">.</span>conOut<span class="token operator">.</span><span class="token function">clearScreen</span><span class="token punctuation">(</span>sysTable<span class="token operator">.</span>conOut<span class="token punctuation">)</span></span>
<span class="line highlighted">  <span class="token keyword">discard</span> sysTable<span class="token operator">.</span>conOut<span class="token operator">.</span><span class="token function">outputString</span><span class="token punctuation">(</span>sysTable<span class="token operator">.</span>conOut<span class="token punctuation">,</span> msg<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>When we compile and load this in QEMU, we see the message printed to the screen, as expected.</p><p><img src="/assets/bootloader-hello-world-BDspxe1F.png" alt="Bootloader Hello World"></p><p>Let&#39;s make it easier to create a wide string by adding a <code>W</code> prefix operator to <code>string</code>:</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/uefi.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">W<span class="token operator">*</span></span><span class="token punctuation">(</span>str<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> WideCString <span class="token operator">=</span></span>
<span class="line">  <span class="token function">newWideCString</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token operator">.</span>toWideCString</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now we can create a wide string using <code>W</code>:</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/bootx64.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">EfiMain</span><span class="token punctuation">(</span>imgHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> sysTable<span class="token operator">:</span> <span class="token keyword">ptr</span> EFiSystemTable<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token punctuation">{.</span>exportc<span class="token punctuation">.}</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token function">NimMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">discard</span> sysTable<span class="token operator">.</span>conOut<span class="token operator">.</span><span class="token function">clearScreen</span><span class="token punctuation">(</span>sysTable<span class="token operator">.</span>conOut<span class="token punctuation">)</span></span>
<span class="line highlighted">  <span class="token keyword">discard</span> sysTable<span class="token operator">.</span>conOut<span class="token operator">.</span><span class="token function">outputString</span><span class="token punctuation">(</span>sysTable<span class="token operator">.</span>conOut<span class="token punctuation">,</span> <span class="token string">W&quot;Hello, world!\n&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="using-echo" tabindex="-1"><a class="header-anchor" href="#using-echo"><span>Using <code>echo</code></span></a></h2><p>Preparing a UTF-16 string and calling <code>outputString</code> every time we want to print to the screen is tedious. Ideally, we should be able to use the built-in <code>echo</code> procedure to print to the screen. This requires us to define a <code>stdout</code> file descriptor and implement <code>fwrite</code> to use the UEFI <code>outputString</code> function. But instead of making the <code>libc</code> module deal with UEFI internals, we&#39;ll create a new module called <code>uefi</code> to handle this. We&#39;ll also move all the UEFI types and constants to this module. In the process, we&#39;ll mark all types, constants, and vars as public so that they can be used by other modules.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/uefi.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span></span>
<span class="line">  EfiStatus<span class="token operator">*</span> <span class="token operator">=</span> uint</span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line highlighted"><span class="token keyword">var</span></span>
<span class="line highlighted">  sysTable<span class="token operator">*:</span> <span class="token keyword">ptr</span> EfiSystemTable</span>
<span class="line highlighted"></span>
<span class="line highlighted"><span class="token keyword">proc</span> <span class="token function">consoleClear<span class="token operator">*</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line highlighted">  assert <span class="token operator">not</span> sysTable<span class="token operator">.</span>isNil</span>
<span class="line highlighted">  <span class="token keyword">discard</span> sysTable<span class="token operator">.</span>conOut<span class="token operator">.</span><span class="token function">clearScreen</span><span class="token punctuation">(</span>sysTable<span class="token operator">.</span>conOut<span class="token punctuation">)</span></span>
<span class="line highlighted"></span>
<span class="line highlighted"><span class="token keyword">proc</span> <span class="token function">consoleOut<span class="token operator">*</span></span><span class="token punctuation">(</span>str<span class="token operator">:</span> string<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line highlighted">  assert <span class="token operator">not</span> sysTable<span class="token operator">.</span>isNil</span>
<span class="line highlighted">  <span class="token keyword">discard</span> sysTable<span class="token operator">.</span>conOut<span class="token operator">.</span><span class="token function">outputString</span><span class="token punctuation">(</span>sysTable<span class="token operator">.</span>conOut<span class="token punctuation">,</span> <span class="token function">W</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line highlighted"></span>
<span class="line highlighted"><span class="token keyword">proc</span> <span class="token function">consoleError<span class="token operator">*</span></span><span class="token punctuation">(</span>str<span class="token operator">:</span> string<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line highlighted">  assert <span class="token operator">not</span> sysTable<span class="token operator">.</span>isNil</span>
<span class="line highlighted">  <span class="token keyword">discard</span> sysTable<span class="token operator">.</span>stdErr<span class="token operator">.</span><span class="token function">outputString</span><span class="token punctuation">(</span>sysTable<span class="token operator">.</span>stdErr<span class="token punctuation">,</span> <span class="token function">W</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We&#39;ll initialize the <code>sysTable</code> variable in <code>src/bootx64.nim</code> later. Let&#39;s implement <code>fwrite</code> to use the <code>consoleOut</code> procedure we just defined. Notice that we don&#39;t use the <code>stream</code> argument to differentiate between <code>stdout</code> and <code>stderr</code> here (since they&#39;re both <code>nil</code> for now). We&#39;ll leave that for later.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/libc.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> uefi</span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">fwrite<span class="token operator">*</span></span><span class="token punctuation">(</span>buf<span class="token operator">:</span> const_pointer<span class="token punctuation">,</span> size<span class="token operator">:</span> csize_t<span class="token punctuation">,</span> count<span class="token operator">:</span> csize_t<span class="token punctuation">,</span> stream<span class="token operator">:</span> File<span class="token punctuation">)</span><span class="token operator">:</span> csize_t <span class="token punctuation">{.</span>exportc<span class="token punctuation">.}</span> <span class="token operator">=</span></span>
<span class="line highlighted">  <span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token operator">$</span><span class="token function">cast[cstring]</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span></span>
<span class="line highlighted">  <span class="token function">consoleOut</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">return</span> count</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now let&#39;s update <code>src/bootx64.nim</code> to initialize the <code>sysTable</code> variable and call <code>echo</code> to print to the screen.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/bootx64.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> uefi</span>
<span class="line"><span class="token operator">...</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">EfiMain</span><span class="token punctuation">(</span>imgHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> sysTable<span class="token operator">:</span> <span class="token keyword">ptr</span> EFiSystemTable<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token punctuation">{.</span>exportc<span class="token punctuation">.}</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token function">NimMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line highlighted">  uefi<span class="token operator">.</span>sysTable <span class="token operator">=</span> sysTable</span>
<span class="line"></span>
<span class="line highlighted">  <span class="token function">consoleClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line highlighted">  echo <span class="token string">&quot;Hello, world!&quot;</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>When we compile and load this in QEMU, we still see the message printed to the screen, as expected.</p><h2 id="handling-exceptions" tabindex="-1"><a class="header-anchor" href="#handling-exceptions"><span>Handling Exceptions</span></a></h2><p>Right now, if an exception is raised we won&#39;t see any output on the screen. In fact, the bootloader will return the default value <code>0</code>, which will cause the firmware boot manager to load next.</p><p>In a normal application, Nim generates a <code>main</code> entry point which executes our top-level code, and then checks for exceptions, and if one was raised it prints the exception message to <code>stderr</code>. There&#39;s an <code>unhandledExceptionHook</code> we can use to set a custom handler, but the issue is that it&#39;s only called when Nim is in charge of generating the <code>main</code> entry point. Since we&#39;re using <code>--noMain:on</code> and providing a custom <code>EfiMain</code> entry point, we need to handle exceptions ourselves.</p><p>We&#39;ll do this by wrapping the code in <code>EfiMain</code> in a <code>try</code> block, and printing the exception message (and the stack trace, if one exists) to the screen if one was raised. To avoid cluttering the <code>try</code> block with a lot of code, we&#39;ll move that code to a new <code>EfiMainInner</code> procedure.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/bootx64.nim</span></span>
<span class="line"></span>
<span class="line highlighted"><span class="token keyword">proc</span> <span class="token function">unhandledException<span class="token operator">*</span></span><span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token keyword">ref</span> Exception<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line highlighted">  echo <span class="token string">&quot;Unhandled exception: &quot;</span> <span class="token operator">&amp;</span> e<span class="token operator">.</span>msg <span class="token operator">&amp;</span> <span class="token string">&quot; [&quot;</span> <span class="token operator">&amp;</span> <span class="token operator">$</span>e<span class="token operator">.</span>name <span class="token operator">&amp;</span> <span class="token string">&quot;]&quot;</span></span>
<span class="line highlighted">  <span class="token keyword">if</span> e<span class="token operator">.</span>trace<span class="token operator">.</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token operator">:</span></span>
<span class="line highlighted">    echo <span class="token string">&quot;Stack trace:&quot;</span></span>
<span class="line highlighted">    echo <span class="token function">getStackTrace</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span></span>
<span class="line highlighted">  <span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line highlighted"></span>
<span class="line highlighted"><span class="token keyword">proc</span> <span class="token function">EfiMainInner</span><span class="token punctuation">(</span>imgHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> sysTable<span class="token operator">:</span> <span class="token keyword">ptr</span> EFiSystemTable<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token operator">=</span></span>
<span class="line highlighted">  uefi<span class="token operator">.</span>sysTable <span class="token operator">=</span> sysTable</span>
<span class="line highlighted">  <span class="token function">consoleClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line highlighted"></span>
<span class="line highlighted">  <span class="token comment"># force an IndexDefect exception</span></span>
<span class="line highlighted">  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span></span>
<span class="line highlighted">  <span class="token keyword">let</span> n <span class="token operator">=</span> <span class="token number">5</span></span>
<span class="line highlighted">  <span class="token keyword">discard</span> a<span class="token punctuation">[</span>n<span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">EfiMain</span><span class="token punctuation">(</span>imgHandle<span class="token operator">:</span> EfiHandle<span class="token punctuation">,</span> sysTable<span class="token operator">:</span> <span class="token keyword">ptr</span> EFiSystemTable<span class="token punctuation">)</span><span class="token operator">:</span> EfiStatus <span class="token punctuation">{.</span>exportc<span class="token punctuation">.}</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token function">NimMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line highlighted">  <span class="token keyword">try</span><span class="token operator">:</span></span>
<span class="line highlighted">    <span class="token keyword">return</span> <span class="token function">EfiMainInner</span><span class="token punctuation">(</span>imgHandle<span class="token punctuation">,</span> sysTable<span class="token punctuation">)</span></span>
<span class="line highlighted">  <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token operator">:</span></span>
<span class="line highlighted">    <span class="token function">unhandledException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>When we compile and load this in QEMU, we see the exception message and stack trace printed to the screen, but it looks like the newlines are not being printed correctly.</p><p><img src="/assets/catching-exceptions-1-Thl79MYG.png" alt="Catching Exceptions 1"></p><p>The problem is that Nim uses LF as the newline character, but UEFI expects CRLF. We can fix this by modifying the <code>fwrite</code> procedure to split the string into lines, and print a CR after each line.</p><div class="language-nim line-numbers-mode" data-highlighter="prismjs" data-ext="nim" data-title="nim"><pre><code><span class="line"><span class="token comment"># src/libc.nim</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> std<span class="token operator">/</span>strutils</span>
<span class="line"></span>
<span class="line"><span class="token keyword">proc</span> <span class="token function">fwrite</span><span class="token punctuation">(</span>buf<span class="token operator">:</span> const_pointer<span class="token punctuation">,</span> size<span class="token operator">:</span> csize_t<span class="token punctuation">,</span> count<span class="token operator">:</span> csize_t<span class="token punctuation">,</span> stream<span class="token operator">:</span> File<span class="token punctuation">)</span><span class="token operator">:</span> csize_t <span class="token punctuation">{.</span>exportc<span class="token punctuation">.}</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token operator">$</span><span class="token function">cast[cstring]</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span></span>
<span class="line highlighted">  <span class="token keyword">for</span> line <span class="token operator">in</span> output<span class="token operator">.</span><span class="token function">splitLines</span><span class="token punctuation">(</span>keepEOL <span class="token operator">=</span> true<span class="token punctuation">)</span><span class="token operator">:</span></span>
<span class="line highlighted">    <span class="token function">consoleOut</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></span>
<span class="line highlighted">    <span class="token function">consoleOut</span><span class="token punctuation">(</span><span class="token string">&quot;\r&quot;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">return</span> count</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="/assets/catching-exceptions-2-DuxMgHo2.png" alt="Catching Exceptions 2"></p><p>Much better! We just have to keep in mind that stack traces are available only in debug builds (which is the default). If we compile in release mode, we won&#39;t see the stack trace. But this is great! We now have a way to print to the screen and catch and display unhandled exceptions (so we&#39;re not flying blind).</p><p>The next logical step is to load our kernel from disk, but we don&#39;t have a kernel yet. So we&#39;ll take a short break from the bootloader and start working on the kernel in the next section.</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/osdev/05-bootloader-p1" aria-label="UEFI Bootloader (Part 1)"><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span>UEFI Bootloader (Part 1)</span></div></a><a class="route-link auto-link next" href="/osdev/07-kernel-image" aria-label="Kernel Image"><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span>Kernel Image</span></div></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BEnvQN0t.js" defer></script>
  </body>
</html>
