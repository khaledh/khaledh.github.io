<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.15" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #22272e;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>Rename Refactoring | Khaled Hammouda</title><meta name="description" content="Building a 64-bit operating system from scratch in Nim">
    <link rel="preload" href="/assets/style-DFReAQZD.css" as="style"><link rel="stylesheet" href="/assets/style-DFReAQZD.css">
    <link rel="modulepreload" href="/assets/app-BEnvQN0t.js"><link rel="modulepreload" href="/assets/10-rename-refactoring.html-CQ7xy6Op.js">
    <link rel="prefetch" href="/assets/index.html-DN4baEjd.js" as="script"><link rel="prefetch" href="/assets/index.html-DTcVMSat.js" as="script"><link rel="prefetch" href="/assets/01-mm.html-DdVm3GHI.js" as="script"><link rel="prefetch" href="/assets/index.html-D8_cVHQe.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-Bq4FSDwn.js" as="script"><link rel="prefetch" href="/assets/02-setup.html-9f0UzP9I.js" as="script"><link rel="prefetch" href="/assets/03-filetype.html-DVtyN252.js" as="script"><link rel="prefetch" href="/assets/04-lexer.html-OooGwppm.js" as="script"><link rel="prefetch" href="/assets/05-parser.html-Dw5HPOU5.js" as="script"><link rel="prefetch" href="/assets/06-parser-p2.html-CHLJtldD.js" as="script"><link rel="prefetch" href="/assets/07-grammarkit.html-DALOmYeT.js" as="script"><link rel="prefetch" href="/assets/08-go-to-decl.html-DPftLCwO.js" as="script"><link rel="prefetch" href="/assets/09-scopes.html-BhA3Jfl5.js" as="script"><link rel="prefetch" href="/assets/11-indentation.html-BSbVKVoe.js" as="script"><link rel="prefetch" href="/assets/12-decl-sections.html-DM3D0T_j.js" as="script"><link rel="prefetch" href="/assets/13-comments.html-PACjUQ8Q.js" as="script"><link rel="prefetch" href="/assets/14-numeric-lit.html-Bx-wwqk6.js" as="script"><link rel="prefetch" href="/assets/15-expressions.html-26eNyM4d.js" as="script"><link rel="prefetch" href="/assets/99-tmp.html-gvMZWEF9.js" as="script"><link rel="prefetch" href="/assets/index.html-J4FG-UC7.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-BeNfzmF-.js" as="script"><link rel="prefetch" href="/assets/02-environment-setup.html-C8XAFCUU.js" as="script"><link rel="prefetch" href="/assets/03-targeting-uefi-p1.html-C9weobAl.js" as="script"><link rel="prefetch" href="/assets/04-targeting-uefi-p2.html-DtpCSkF_.js" as="script"><link rel="prefetch" href="/assets/05-bootloader-p1.html-nF5TI7gq.js" as="script"><link rel="prefetch" href="/assets/06-bootloader-p2.html-lTW7xvyF.js" as="script"><link rel="prefetch" href="/assets/07-kernel-image.html-Dbec7FcX.js" as="script"><link rel="prefetch" href="/assets/08-loading-the-kernel-p1.html-CgEWrWCh.js" as="script"><link rel="prefetch" href="/assets/09-loading-the-kernel-p2.html-Bsyq9hJE.js" as="script"><link rel="prefetch" href="/assets/10-loading-the-kernel-p3.html-Cz6f791z.js" as="script"><link rel="prefetch" href="/assets/11-physical-memory.html-Iko_lfyH.js" as="script"><link rel="prefetch" href="/assets/12-virtual-memory.html-BdHdqaeH.js" as="script"><link rel="prefetch" href="/assets/13-higher-half-kernel.html-U7sLCIG_.js" as="script"><link rel="prefetch" href="/assets/14-memory-segments.html-C0Wfonfg.js" as="script"><link rel="prefetch" href="/assets/15-interrupts.html-CuXOHXlP.js" as="script"><link rel="prefetch" href="/assets/16-user-mode.html-DI-QEaJn.js" as="script"><link rel="prefetch" href="/assets/17-tss.html-DedksTv0.js" as="script"><link rel="prefetch" href="/assets/18-system-calls.html-CANG8AhC.js" as="script"><link rel="prefetch" href="/assets/19-tasks.html-D_KA9R1n.js" as="script"><link rel="prefetch" href="/assets/20-position-independent-code.html-DcxhRHAD.js" as="script"><link rel="prefetch" href="/assets/21-elf-loader-p1.html-hRqOVejE.js" as="script"><link rel="prefetch" href="/assets/22-elf-loader-p2.html-CwKLac9X.js" as="script"><link rel="prefetch" href="/assets/23-coop-multitasking.html-CmjVNMNt.js" as="script"><link rel="prefetch" href="/assets/24-system-library.html-Chl8ifRh.js" as="script"><link rel="prefetch" href="/assets/25-interrupt-controller.html-i_QNpPOS.js" as="script"><link rel="prefetch" href="/assets/index.html--jTsfqNO.js" as="script"><link rel="prefetch" href="/assets/404.html-CYnd4SKg.js" as="script"><link rel="prefetch" href="/assets/SearchResult-ZUCfC4Sv.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">Khaled Hammouda</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/osdev/" aria-label="Fusion OS"><!---->Fusion OS<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/acronyms/" aria-label="Computing Acronyms"><!---->Computing Acronyms<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading active" href="/nimjet/" aria-label="NimJet"><!---->NimJet<!----></a><ul class="vp-sidebar-children" style=""><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/01-intro" aria-label="Introduction"><!---->Introduction<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/02-setup" aria-label="Project Setup"><!---->Project Setup<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/03-filetype" aria-label="File Type"><!---->File Type<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/04-lexer" aria-label="Lexer"><!---->Lexer<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/05-parser" aria-label="Parser"><!---->Parser<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/06-parser-p2" aria-label="Parser Implementation"><!---->Parser Implementation<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/07-grammarkit" aria-label="Grammar-Kit"><!---->Grammar-Kit<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/08-go-to-decl" aria-label="Go To Declaration"><!---->Go To Declaration<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/09-scopes" aria-label="Scope Resolution"><!---->Scope Resolution<!----></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/nimjet/10-rename-refactoring" aria-label="Rename Refactoring"><!---->Rename Refactoring<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/11-indentation" aria-label="Indentation"><!---->Indentation<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/12-decl-sections" aria-label="Declaration Sections"><!---->Declaration Sections<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/13-comments" aria-label="Comments"><!---->Comments<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/14-numeric-lit" aria-label="Numeric Literals"><!---->Numeric Literals<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/nimjet/15-expressions" aria-label="Expressions"><!---->Expressions<!----></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="rename-refactoring" tabindex="-1"><a class="header-anchor" href="#rename-refactoring"><span>Rename Refactoring</span></a></h1><p>Now that we have support for scope-based reference resolution, let&#39;s add support for rename refactoring. This will allow users to rename a symbol and have all references to that symbol updated automatically.</p><h2 id="supporting-rename" tabindex="-1"><a class="header-anchor" href="#supporting-rename"><span>Supporting Rename</span></a></h2><p>The IDE supports rename refactoring for elements that implement the <code>PsiNamedElement</code> interface by calling their <code>setName</code> method. This method should create a new identifier element with the new name, and replace the existing identifier element with the new one.</p><p>Creating a new identifier element is not straightforward, as it requires creating a new <code>PsiElement</code> instance backed by a new <code>ASTNode</code>. We&#39;ll need to create a dummy <code>PsiFile</code> from a text fragment that contains the new identifier, let the IDE parse the file, and extract the identifier element from the resulting <code>PsiFile</code>.</p><p>Let&#39;s create a <code>NimElementFactory</code> class that will help us create new elements. We&#39;ll add a pair of <code>createIdentDecl</code> and <code>createIdentRef</code> methods to create new identifier declarations and references, respectively. We will use the former in the <code>setName</code> method of our <code>IdentDecl</code> element, and the latter in the <code>handleElementRename</code> method of our <code>IdentReference</code> element.</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt" data-title="kt"><pre><code><span class="line"><span class="token comment">// src/main/kotlin/khaledh/nimjet/psi/NimElementFactory.kt</span></span>
<span class="line"><span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> NimElementFactory <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">createFile</span><span class="token punctuation">(</span>project<span class="token operator">:</span> Project<span class="token punctuation">,</span> text<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> NimFile <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> PsiFileFactory</span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">createFileFromText</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;dummy.nim&quot;</span></span><span class="token punctuation">,</span> NimFileType<span class="token punctuation">,</span> text<span class="token punctuation">)</span> <span class="token keyword">as</span> NimFile</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">fun</span> <span class="token function">createIdentDecl</span><span class="token punctuation">(</span>project<span class="token operator">:</span> Project<span class="token punctuation">,</span> name<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> IdentDecl <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">val</span> file <span class="token operator">=</span> <span class="token function">createFile</span><span class="token punctuation">(</span>project<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;let </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">name</span></span><span class="token string"> = \&quot;\&quot;&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> PsiTreeUtil<span class="token punctuation">.</span><span class="token function">findChildOfType</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> IdentDecl<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span></span>
<span class="line">                <span class="token operator">?:</span> <span class="token keyword">throw</span> <span class="token function">IncorrectOperationException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Failed to create new IdentDecl element&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">fun</span> <span class="token function">createIdentRef</span><span class="token punctuation">(</span>project<span class="token operator">:</span> Project<span class="token punctuation">,</span> name<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> IdentRef <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">val</span> file <span class="token operator">=</span> <span class="token function">createFile</span><span class="token punctuation">(</span>project<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">name</span></span><span class="token string"> dummy&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> PsiTreeUtil<span class="token punctuation">.</span><span class="token function">findChildOfType</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> IdentRef<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span></span>
<span class="line">                <span class="token operator">?:</span> <span class="token keyword">throw</span> <span class="token function">IncorrectOperationException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Failed to create new IdentRef element&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The <code>createFile</code> method creates a new <code>NimFile</code> instance from a text fragment. The <code>createIdentDecl</code> method uses this method to create a new file containing the fragment <code>let $name = &quot;&quot;</code>, where <code>$name</code> is the new identifier name. This creates a new identifier declaration element with the specified name. We then extract the <code>IdentDecl</code> element from the file and return it.</p><p>The <code>createIdentRef</code> method is similar, but it creates a file containing the fragment <code>$name dummy</code>, where <code>$name</code> is the new identifier name. This creates a new identifier reference element, which we extract and return.</p><p>Now, let&#39;s use the <code>createIdentDecl</code> method in the <code>IdentDeclMixin</code> class to implement the <code>setName</code> method.</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt" data-title="kt"><pre><code><span class="line"><span class="token comment">// src/main/kotlin/khaledh/nimjet/psi/impl/IdentDeclMixin.kt</span></span>
<span class="line"><span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token function">IdentDeclMixin</span><span class="token punctuation">(</span>node<span class="token operator">:</span> ASTNode<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ASTWrapperPsiElement</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">,</span> IdentDecl <span class="token punctuation">{</span></span>
<span class="line">    <span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> PsiElement <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">val</span> newIdentDecl <span class="token operator">=</span> NimElementFactory<span class="token punctuation">.</span><span class="token function">createIdentDecl</span><span class="token punctuation">(</span>project<span class="token punctuation">,</span> name<span class="token punctuation">)</span></span>
<span class="line">        ident<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>newIdentDecl<span class="token punctuation">.</span>ident<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">this</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>After we create the new <code>IdentDecl</code> element, we replace the existing identifier token (the <code>ident</code> property) with the new <code>ident</code> token from the new declaration. This updates the identifier name in the declaration.</p><p>Now, let&#39;s implement the <code>handleElementRename</code> method in the <code>IdentReferenceMixin</code> class to rename references to the identifier.</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt" data-title="kt"><pre><code><span class="line"><span class="token comment">// src/main/kotlin/khaledh/nimjet/psi/IdentReference.kt</span></span>
<span class="line"><span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token function">IdentReference</span><span class="token punctuation">(</span>element<span class="token operator">:</span> IdentRef<span class="token punctuation">,</span> textRange<span class="token operator">:</span> TextRange<span class="token punctuation">)</span></span>
<span class="line">    <span class="token operator">:</span> PsiReferenceBase<span class="token operator">&lt;</span>IdentRef<span class="token operator">&gt;</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> textRange<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">handleElementRename</span><span class="token punctuation">(</span>newElementName<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> PsiElement <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">val</span> newIdentRef <span class="token operator">=</span> NimElementFactory<span class="token punctuation">.</span><span class="token function">createIdentRef</span><span class="token punctuation">(</span>myElement<span class="token punctuation">.</span>project<span class="token punctuation">,</span> newElementName<span class="token punctuation">)</span></span>
<span class="line">        myElement<span class="token punctuation">.</span>ident<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>newIdentRef<span class="token punctuation">.</span>ident<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> myElement</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This time we create a new <code>IdentRef</code> element using the <code>createIdentRef</code> method and replace the existing identifier token with the new one. Notice that <code>IdentReference</code> is a <code>PsiReference</code> object, not the <code>IdentRef</code> element itself. We use the <code>myElement</code> property to access the <code>IdentRef</code> element.</p><p>This should be enough to support rename refactoring. Let&#39;s try it out by putting the cursor on the inner declaration of the <code>msg</code> variable and pressing <code>Shift + F6</code> to rename it. We can also right-click on the declaration and select <code>Refactor -&gt; Rename... </code> from the context menu.</p><p><img src="/assets/rename-dialog-TT_4V6y7.png" alt="Rename Dialog" width="600"></p><p>The IDE shows a dialog where we can enter the new name. We enter <code>innerMsg</code> and press <code>Enter</code>. The IDE updates the declaration and all references to the variable.</p><p><img src="/assets/renamed-identifier-BfyZrU8P.png" alt="Renamed Identifier" width="350"></p><p>Great! Both the inner declaration and the reference to the variable have been updated.</p><h2 id="in-place-rename" tabindex="-1"><a class="header-anchor" href="#in-place-rename"><span>In-place Rename</span></a></h2><p>The IDE also supports in-place rename refactoring, where we can rename an identifier directly in the editor, instead of using the dialog. This feature relies on registering a class that extends <code>RefactoringSupportProvider</code> and registering it in the <code>plugin.xml</code>. This class enables many refactoring features (e.g. rename, introduce variable, extract method, etc.), but we&#39;ll focus only on the rename refactoring for now.</p><p>Let&#39;s create a <code>NimRefactoringSupportProvider</code> class and override the <code>isInplaceRenameAvailable</code> method to enable in-place rename refactoring.</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt" data-title="kt"><pre><code><span class="line"><span class="token comment">// src/main/kotlin/khaledh/nimjet/refactoring/NimRefactoringSupportProvider.kt</span></span>
<span class="line"><span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> NimRefactoringSupportProvider <span class="token operator">:</span> <span class="token function">RefactoringSupportProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">isInplaceRenameAvailable</span><span class="token punctuation">(</span>element<span class="token operator">:</span> PsiElement<span class="token punctuation">,</span> context<span class="token operator">:</span> PsiElement<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> element<span class="token punctuation">.</span>useScope <span class="token keyword">is</span> LocalSearchScope</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The IDE has two handlers for in-place rename refactoring: local and global.</p><ul><li>The local one is <code>VariableInplaceRenameHandler</code>, and it requires the element to have a <code>LocalSearchScope</code> use scope. Local search scope is typically associated with local variables (which include variables at the file scope that are not exported), and function parameters. This handler passes the element to our <code>isInplaceRenameAvailable</code> method to determine if in-place rename is available for that element.</li><li>The global one is <code>MemberInplaceRenameHandler</code>, and it can handle elements with a <code>GlobalSearchScope</code> use scope. This scope is typically associated with public classes, functions, variables, and other symbols that can be accessed from other files. This handler passes the element to the <code>isMemberInplaceRenameAvailable</code> method of the <code>RefactoringSupportProvider</code> class to check if in-place rename is available for that element.</li></ul><p>In our case, we only need the local in-place rename handler, so we override only the <code>isInplaceRenameAvailable</code> method. For this to work though, we need to modify our <code>IdentDecl</code> element to have a <code>LocalSearchScope</code> use scope. Let&#39;s do that in the <code>IdentDeclMixin</code> class.</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt" data-title="kt"><pre><code><span class="line"><span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token function">IdentDeclMixin</span><span class="token punctuation">(</span>node<span class="token operator">:</span> ASTNode<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ASTWrapperPsiElement</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">,</span> IdentDecl <span class="token punctuation">{</span></span>
<span class="line">    <span class="token operator">..</span><span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> PsiElement<span class="token operator">?</span> <span class="token operator">=</span> NimScope<span class="token punctuation">.</span><span class="token function">parentScope</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getUseScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> SearchScope <span class="token operator">=</span> <span class="token function">LocalSearchScope</span><span class="token punctuation">(</span>context <span class="token operator">?:</span> containingFile<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The <code>getUseScope</code> method returns a <code>LocalSearchScope</code> constrained to the element&#39;s parent context, or the containing file if the context is null. This limits the scope of the in-place rename refactoring to the element&#39;s scope.</p><p>Finally, let&#39;s register the <code>NimRefactoringSupportProvider</code> class in the <code>plugin.xml</code> file.</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>idea-plugin</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    ...</span>
<span class="line"></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extensions</span> <span class="token attr-name">defaultExtensionNs</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.intellij<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        ...</span>
<span class="line"></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lang.refactoringSupport</span></span>
<span class="line">            <span class="token attr-name">language</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Nim<span class="token punctuation">&quot;</span></span></span>
<span class="line">            <span class="token attr-name">implementationClass</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>khaledh.nimjet.refactoring.NimRefactoringSupportProvider<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span></span>
<span class="line"></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extensions</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>idea-plugin</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="testing-in-place-rename" tabindex="-1"><a class="header-anchor" href="#testing-in-place-rename"><span>Testing In-place Rename</span></a></h2><p>Let&#39;s test the in-place rename refactoring by putting the cursor on the <code>msg</code> variable declaration in the block scope and pressing <code>Shift + F6</code>. Both the declaration and the reference to the variable should become editable with a purple background. If we start typing, the IDE should update the declaration and all references to the variable in sync.</p><p><img src="/assets/inplace-rename-B4jybu-H.png" alt="In-place Rename" width="420"></p><p>Looks good! Now, let&#39;s try to rename the other <code>msg</code> variable declaration (at the file scope). Notice that I changed the string literal value to <code>&quot;msg&quot;</code> as well. When we start the in-place renaming, the IDE will show a popover to ask if we want to rename the occurrences in the string literal as well.</p><p><img src="/assets/inplace-rename-string-BMdeu-1c.png" alt="In-Place Rename String Occurrences" width="430"></p><p>Let&#39;s choose <strong>Rename all occurrences</strong> and start typing. The IDE should update all occurrences of the variable, including the string literal. Neat!</p><p><img src="/assets/inplace-rename-string-occ-E8YNGe6N.png" alt="In-Place Rename String Occurrences" width="400"></p><p>That&#39;s it for rename refactoring. In the next section, we&#39;ll add support for <strong>Find Usages</strong>, which will allow us to find all references to a symbol and display the results in a tool window.</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/nimjet/09-scopes" aria-label="Scope Resolution"><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span>Scope Resolution</span></div></a><a class="route-link auto-link next" href="/nimjet/11-indentation" aria-label="Indentation"><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span>Indentation</span></div></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BEnvQN0t.js" defer></script>
  </body>
</html>
